@{
	Layout = "~/Views/Shared/_Layout.cshtml";
	ViewData["Title"] = "Kullanıcı Yönetimi";
}

<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="card-body">
				<h5 class="card-title">
					<i class="fas fa-users me-2"></i>
					Kullanıcılar Tablosu
				</h5>

				<div class="table-responsive">
					<table id="usersTable" class="table table-striped table-hover display" style="width:100%">
						<thead class="table-dark">
							<tr>
								<th>#</th>
								<th>KULLANICI ADI</th>
								<th>AD SOYAD</th>
								<th>ROL</th>
								<th>AKTİF Mİ</th>
								<th>İŞLEMLER</th>
							</tr>
						</thead>
						<tbody>
							<!-- DataTables will populate this -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		$(document).ready(function() {
			var table = $('#usersTable').DataTable({
				"processing": true,
				"ajax": {
					"url": "/admin/kullanici-yonetimi/liste-datatable",
					"type": "GET",
					"dataSrc": "",
					"error": function(xhr, error, code) {
						console.error('DataTables AJAX error:', error);
						toastr.error('Veriler yüklenirken hata oluştu: ' + (xhr.responseJSON?.message || error));
					}
				},
				"columns": [
					{
						"data": null,
						"width": "5%",
						"orderable": false,
						"className": "text-center",
						"render": function(data, type, row, meta) {
							return meta.row + 1;
						}
					},
					{
						"data": "userName",
						"render": function(data) {
							consoe.log(data);
							return data ? `<strong>${data}</strong>` : '';
						}
					},
					{
						"data": "fullName",
						"render": function(data) {
							return data || '';
						}
					},
					{
						"data": "roles",
						"render": function(data) {	
							return data ? `<span class="badge bg-info">${data}</span>` : '';
						}
					},
					{
						"data": "isActive",
						"width": "10%",
						"className": "text-center",
						"render": function(data) {
							return data ?
								'<span class="badge bg-success">Evet</span>' :
								'<span class="badge bg-danger">Hayır</span>';
						}
					},
					{
						"data": null,
						"width": "12%",
						"orderable": false,
						"className": "text-center",
						"render": function(data, type, row) {
							return `
								<div class="btn-group btn-group-sm" role="group">
									<button type="button" class="btn btn-outline-primary btn-sm"
											onclick="viewUser('${row.id}')" title="Görüntüle">
										<i class="fas fa-eye"></i>
									</button>
									<button type="button" class="btn btn-outline-warning btn-sm"
											onclick="editUser('${row.id}')" title="Düzenle">
										<i class="fas fa-edit"></i>
									</button>
									<button type="button" class="btn btn-outline-danger btn-sm"
											onclick="deleteUser('${row.id}')" title="Sil">
										<i class="fas fa-trash"></i>
									</button>
								</div>
							`;
						}
					}
				],
				"order": [[1, "asc"]], 
				"language": {
					url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json'
				},
				"lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
				"pageLength": 10,
				"responsive": true,
				"searchDelay": 300,
				"stateSave": true,
				"dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
					   '<"row"<"col-sm-12"tr>>' +
					   '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
				"initComplete": function() {
				},
				"drawCallback": function() {
					$('[title]').tooltip();
				}
			});
		});

		// Kullanıcı işlem fonksiyonları
		function viewUser(userId) {
			window.location.href = `/admin/kullanici-yonetimi/detay/${userId}`;
		}

		function editUser(userId) {
			window.location.href = `/admin/kullanici-yonetimi/duzenle/${userId}`;
		}

		function deleteUser(userId) {
			if (confirm('Bu kullanıcıyı silmek istediğinizden emin misiniz?')) {
				$.ajax({
					url: `/admin/kullanici-yonetimi/sil/${userId}`,
					type: 'DELETE',
					success: function(response) {
						toastr.success('Kullanıcı başarıyla silindi.');
						$('#usersTable').DataTable().ajax.reload();
					},
					error: function(xhr) {
						toastr.error('Kullanıcı silinirken hata oluştu.');
					}
				});
			}
		}
	</script>
}