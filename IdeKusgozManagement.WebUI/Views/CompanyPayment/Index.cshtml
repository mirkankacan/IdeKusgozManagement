@{
    ViewData["Title"] = "Şirket Ödemesi Yönetimi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
}
@Html.AntiForgeryToken()
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-building me-2"></i>
                    Şirket Ödemesi Talepleri Yönetimi
                </h5>

                <div class="table-responsive">
                    <table id="companyPaymentsTable" class="table table-striped table-hover display" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>EKİPMAN</th>
                                <th>PROJE</th>
                                <th>MASRAF</th>
                                <th>TUTAR</th>
                                <th>DURUM</th>
                                <th>NOTLAR</th>
                                <th>DOKÜMANLAR</th>
                                <th>OLUŞTURMA<br />TARİHİ</th>
                                <th>OLUŞTURAN<br />KULLANICI</th>
                                <th>İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- DataTables will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="updateCompanyPaymentRequestModal" tabindex="-1"
     aria-labelledby="updateCompanyPaymentRequestModalLabel" aria-hidden="true" data-bs-backdrop="static"
     data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Şirket Ödemesi Talebi Güncelleme Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form class="needs-validation" novalidate id="updateCompanyPaymentRequestForm"
                  enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="txtUId">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="selectUProjectId" class="form-label">
                                Proje <span class="text-danger">*</span>
                            </label>
                            <select class="form-select project-select" id="selectUProjectId" required
                                    style="width: 100%;">
                                <option value="">Proje seçiniz...</option>
                            </select>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Proje seçiniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="selectUExpenseId" class="form-label">
                                Masraf Türü <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="selectUExpenseId" required style="width: 100%;">
                                <option value="">Masraf türü seçiniz...</option>
                            </select>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Masraf türü seçiniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="selectUEquipmentId" class="form-label">Ekipman (İsteğe Bağlı)</label>
                            <select class="form-select equipment-select" id="selectUEquipmentId" style="width: 100%;">
                                <option value="">Ekipman seçiniz...</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label for="txtUAmount" class="form-label">Tutar <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="txtUAmount" required step="0.01" min="0.01">
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir tutar giriniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="txtUPersonnelNote" class="form-label">Personel Notu (İsteğe Bağlı)</label>
                            <textarea class="form-control" readonly id="txtUPersonnelNote" rows="3"
                                      placeholder="Personel notu..."></textarea>
                        </div>
                        <div class="col-md-12">
                            <label for="txtUChiefNote" class="form-label">Şef Notu (İsteğe Bağlı)</label>
                            <textarea class="form-control" id="txtUChiefNote" rows="3"
                                      placeholder="Şef notu..." readonly></textarea>
                        </div>
                        <div class="col-md-12">
                            <label for="selectUStatus" class="form-label">
                                Durum <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="selectUStatus" required>
                                <option value="0">Beklemede</option>
                                <option value="1">Onaylandı</option>
                                <option value="2">Reddedildi</option>
                            </select>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Durum seçiniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="fileUFile" class="form-label">Dosya (İsteğe Bağlı)</label>
                            <input type="file" class="form-control" id="fileUFile"
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                            <small class="form-text text-muted">
                                Yeni dosya yüklemek için seçiniz (PDF, JPG, PNG, DOC,
                                DOCX)
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-pen me-1"></i>Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel">
                    <i class="fas fa-sticky-note me-2"></i>Notlar
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-user me-2 text-primary"></i>Personel Notu
                        </label>
                        <div class="card">
                            <div class="card-body">
                                <p id="personnelNoteContent" class="mb-0">
                                    <em class="text-muted">Not bulunmamaktadır.</em>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold">
                            <i class="fas fa-user-tie me-2 text-success"></i>Şef Notu
                        </label>
                        <div class="card">
                            <div class="card-body">
                                <p id="chiefNoteContent" class="mb-0">
                                    <em class="text-muted">Not bulunmamaktadır.</em>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveCompanyPaymentModal" tabindex="-1" aria-labelledby="approveCompanyPaymentModalLabel"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Şirket Ödemesi Talebi Onaylama Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="approveCompanyPaymentForm" class="needs-validation" novalidate>
                <div class="modal-body">
                    <input type="hidden" id="txtApproveCompanyPaymentId" />
                    <div class="mb-3">
                        <label for="txtApproveChiefNote" class="form-label">Şef Notu (İsteğe Bağlı)</label>
                        <textarea class="form-control" id="txtApproveChiefNote" rows="3"
                                  placeholder="Onaylama notunuzu yazın..." readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-success w-100" id="btnSubmitApprove">
                        <i class="fas fa-check me-1"></i>Onayla
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectCompanyPaymentModal" tabindex="-1" aria-labelledby="rejectCompanyPaymentModalLabel"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Şirket Ödemesi Talebi Reddetme Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtRejectCompanyPaymentId" />
                <div class="mb-3">
                    <label for="txtRejectReason" class="form-label">Reddetme Sebebi (İsteğe Bağlı)</label>
                    <textarea class="form-control" id="txtRejectReason" rows="3"
                              placeholder="Şirket ödemesi talebini reddetme sebebinizi açıklayın..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger w-100" id="btnRejectCompanyPayment">
                    <i class="fas fa-times me-1"></i>Reddet
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        let companyPaymentsTable;
        document.body.classList.add('sidebar-hidden');
        $(document).ready(async function () {
            setupEventListeners();
            await initializeSelects();
            await initializeDataTable();
        });

        async function initializeSelects() {
            try {
                await initializeProjectSelect();
                await initializeEquipmentSelect();
                await initializeExpenseSelect();
            } catch (error) {
                console.error('Select initialization error:', error);
                handleError(error, 'Select alanları yüklenirken hata oluştu');
            }
        }

        async function initializeProjectSelect() {
            try {
                const response = await makeRequest('/proje/aktif-liste', 'GET');

                if (response && Array.isArray(response)) {
                    $('.project-select').each(function () {
                        const currentSelect = $(this);
                        currentSelect.empty();
                        currentSelect.append('<option value="">Proje seçiniz...</option>');
                        response.forEach(project => {
                            currentSelect.append(`<option value="${project.id}">${project.name}</option>`);
                        });
                    });
                }

                $('.project-select').select2({
                    placeholder: 'Proje seçiniz...',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#updateCompanyPaymentRequestModal')
                });
            } catch (error) {
                console.error('Proje listesi yüklenirken hata:', error);
                handleError(error, 'Proje listesi yüklenirken hata oluştu');
            }
        }

        async function initializeEquipmentSelect() {
            try {
                const response = await makeRequest('/ekipman/aktif-liste', 'GET');

                if (response && Array.isArray(response)) {
                    $('.equipment-select').each(function () {
                        const currentSelect = $(this);
                        currentSelect.empty();
                        currentSelect.append('<option value="">Ekipman seçiniz...</option>');
                        response.forEach(equipment => {
                            currentSelect.append(`<option value="${equipment.id}">${equipment.name}</option>`);
                        });
                    });
                }

                $('.equipment-select').select2({
                    placeholder: 'Ekipman seçiniz...',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#updateCompanyPaymentRequestModal')
                });
            } catch (error) {
                console.error('Ekipman listesi yüklenirken hata:', error);
                handleError(error, 'Ekipman listesi yüklenirken hata oluştu');
            }
        }

        async function initializeExpenseSelect() {
            try {
                const response = await makeRequest('/masraf/aktif-liste', 'GET');

                if (response && Array.isArray(response)) {
                    $('#selectUExpenseId').empty();
                    $('#selectUExpenseId').append('<option value="">Masraf türü seçiniz...</option>');
                    response.forEach(expense => {
                        $('#selectUExpenseId').append(`<option value="${expense.id}">${expense.name}</option>`);
                    });
                }

                $('#selectUExpenseId').select2({
                    placeholder: 'Masraf türü seçiniz...',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#updateCompanyPaymentRequestModal')
                });
            } catch (error) {
                console.error('Masraf türleri yüklenirken hata:', error);
                handleError(error, 'Masraf türleri yüklenirken hata oluştu');
            }
        }

        async function initializeDataTable() {
            companyPaymentsTable = $('#companyPaymentsTable').DataTable({
                "processing": true,
                "ajax": {
                    "url": "/sirket-odemesi/liste",
                    "type": "GET",
                    "dataSrc": function (json) {
                        if (json) {
                            return json;
                        }
                        return [];
                    },
                    "error": function (xhr, error, code) {
                        console.error('DataTables AJAX error:', error);
                        // handleError fonksiyonunu kullanarak hatayı işle
                        let errorObj = null;
                        try {
                            if (xhr.responseJSON) {
                                errorObj = xhr.responseJSON;
                            } else if (xhr.responseText) {
                                try {
                                    errorObj = JSON.parse(xhr.responseText);
                                } catch (parseError) {
                                    // JSON değilse string olarak kullan
                                    errorObj = xhr.responseText;
                                }
                            } else {
                                errorObj = { detail: 'Veriler yüklenirken hata oluştu' };
                            }
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                            errorObj = { detail: 'Veriler yüklenirken hata oluştu' };
                        }
                        handleError(errorObj, 'Veriler yüklenirken hata oluştu');
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "width": "5%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            return '';
                        }
                    },
                    {
                        "data": "equipment",
                        "render": function (data) {
                            return data || '-';
                        }
                    },
                    {
                        "data": "project",
                        "render": function (data) {
                            return data || '-';
                        }
                    },
                    {
                        "data": "expense",
                        "render": function (data) {
                            return data || '-';
                        }
                    },
                    {
                        "data": "amount",
                        "render": function (data) {
                            if (!data && data !== 0) return '';
                            return new Intl.NumberFormat('tr-TR', {
                                style: 'currency',
                                currency: 'TRY'
                            }).format(data);
                        }
                    },
                    {
                        "data": "statusText",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.status === 0) {
                                return `<span class="badge bg-warning">${data}</span>`;
                            } else if (row.status === 1) {
                                return `<span class="badge bg-success">${data}</span>`;
                            } else if (row.status === 2) {
                                return `<span class="badge bg-danger">${data}</span>`;
                            } else if (row.status === 3) {
                                return `<span class="badge bg-success">${data}</span>`;
                            } else if (row.status === 4) {
                                return `<span class="badge bg-danger">${data}</span>`;
                            } else {
                                return `<span class="badge bg-secondary">${data}</span>`;
                            }
                        }
                    },

                    {
                        "data": null,
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {
                            var hasNotes = (row.personnelNote && row.personnelNote.trim() !== '') ||
                                (row.chiefNote && row.chiefNote.trim() !== '');
                            var notesButton = '';
                            if (hasNotes) {
                                var personnelNoteEncoded = btoa(unescape(encodeURIComponent(row.personnelNote || '')));
                                var chiefNoteEncoded = btoa(unescape(encodeURIComponent(row.chiefNote || '')));
                                notesButton = `<button type="button" class="btn btn-outline-info btn-sm me-1 btn-notes"
                                                                            data-company-payment-id="${row.id}"
                                                                            data-personnel-note="${personnelNoteEncoded}"
                                                                            data-chief-note="${chiefNoteEncoded}"
                                                                            title="Notları Görüntüle">
                                                                            <i class="fas fa-sticky-note"></i>
                                                                        </button>`;
                            }
                            return notesButton;
                        }
                    },
                    {
                        "data": "fileIds",
                        "className": "text-center",
                        "render": (data, type, row) => {
                            if (!data || data.length === 0) return '';
                            let items = data.map((fileId, index) => {
                                return `<div class="mb-1">
                                <a class="btn btn-outline-primary btn-sm" style="border-color:#ffffff00 !important"
                                   href="/dosya/indir/${fileId}" title="İndir" download>
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>`;
                            }).join('');

                            return items;
                        }
                    },
                    {
                        "data": "createdDate",
                        "render": function (data) {
                            return data ? new Date(data).toLocaleString('tr-TR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                        }
                    },
                    {
                        "data": "createdByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            return data ? data : "-";
                        }
                    },

                    {
                        "data": null,
                        "width": "10%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {
                            var buttons = '<div class="btn-group btn-group-sm" role="group">';

                            // Eğer status onaylandı veya reddedildi ise sadece görüntüleme butonları göster
                            if (row.status === 1 || row.status === 2 || row.status === 3 || row.status === 4) {
                                buttons += '</div>';
                                return buttons;
                            }
                            const userId = @Html.Raw(Json.Serialize(ViewBag.UserId));
                  
                               if(window.isUserUnitManager || window.isAdmin || window.departmentDutyName === 'Muhasebe Meslek Elemanı' || window.departmentDutyName === 'Muhasebe Müdürü' || window.departmentDutyName === 'Finans Uzmanı'){
                                   console.log("a")
                                      buttons += `
                                                                        <button type="button" class="btn btn-outline-warning btn-sm"
                                                                            onclick="loadCompanyPaymentForEdit('${row.id}')" title="Düzenle">
                                                                            <i class="fas fa-edit"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                                            onclick="deleteCompanyPaymentRequest('${row.id}')" title="Sil">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-outline-success btn-sm"
                                                                            onclick="openApproveModal('${row.id}')" title="Onayla">
                                                                            <i class="fas fa-check"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                                            onclick="openRejectModal('${row.id}')" title="Reddet">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>`;
                               } else if(row.selectedApproverId === userId && window.isUserSef){
                                 buttons += `
                                                                        <button type="button" class="btn btn-outline-warning btn-sm"
                                                                            onclick="loadCompanyPaymentForEdit('${row.id}')" title="Düzenle">
                                                                            <i class="fas fa-edit"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                                            onclick="deleteCompanyPaymentRequest('${row.id}')" title="Sil">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-outline-success btn-sm"
                                                                            onclick="openApproveModal('${row.id}')" title="Onayla">
                                                                            <i class="fas fa-check"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                                            onclick="openRejectModal('${row.id}')" title="Reddet">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>`;
                            }

                            buttons += '</div>';
                            return buttons;
                        }
                    }
                ],
                "language": {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json'
                },
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "pageLength": 10,
                "responsive": true,
                "searchDelay": 300,
                "order": [[8, "desc"]],
                "drawCallback": function () {
                    var api = this.api();
                    var pageInfo = api.page.info();

                    api.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });
                    $('[title]').tooltip();
                }
            });
        }

        function setupEventListeners() {
            // Update form
            $('#updateCompanyPaymentRequestForm').on('submit', function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    updateCompanyPaymentRequest();
                }
                $(this).addClass('was-validated');
            });

            // Approve form
            $('#approveCompanyPaymentForm').on('submit', function (e) {
                e.preventDefault();
                approveCompanyPayment();
            });

            // Reject button click event
            $(document).on('click', '#btnRejectCompanyPayment', async function () {
                await rejectCompanyPayment();
            });

            // Clear forms when modals hide
            $('#updateCompanyPaymentRequestModal').on('hidden.bs.modal', function () {
                $('#updateCompanyPaymentRequestForm')[0].reset();
                $('#updateCompanyPaymentRequestForm').removeClass('was-validated');
            });

            $('#updateCompanyPaymentRequestModal').on('show.bs.modal', function () {
                // Şef notu alanını her zaman göster, sadece şef ise düzenlenebilir yap
                if (window.isUserSef) {
                    $('#txtUChiefNote').prop('readonly', false);
                } else {
                    $('#txtUChiefNote').prop('readonly', true);
                }
            });

            $('#approveCompanyPaymentModal').on('hidden.bs.modal', function () {
                $('#approveCompanyPaymentForm')[0].reset();
                $('#approveCompanyPaymentForm').removeClass('was-validated');
            });

            $('#approveCompanyPaymentModal').on('show.bs.modal', function () {
                // Şef notu alanını her zaman göster, sadece şef ise düzenlenebilir yap
                if (window.isUserSef) {
                    $('#txtApproveChiefNote').prop('readonly', false);
                } else {
                    $('#txtApproveChiefNote').prop('readonly', true);
                }
            });

            $('#rejectCompanyPaymentModal').on('hidden.bs.modal', function () {
                $('#txtRejectCompanyPaymentId').val('');
                $('#txtRejectReason').val('');
            });

            // Notes button click event (delegated event)
            $(document).on('click', '.btn-notes', function () {
                var companyPaymentId = $(this).data('company-payment-id');
                var personnelNoteEncoded = $(this).data('personnel-note');
                var chiefNoteEncoded = $(this).data('chief-note');

                // Base64 decode
                var personnelNote = '';
                var chiefNote = '';

                try {
                    if (personnelNoteEncoded) {
                        personnelNote = decodeURIComponent(escape(atob(personnelNoteEncoded)));
                    }
                } catch (e) {
                    console.error('Personnel note decode error:', e);
                }

                try {
                    if (chiefNoteEncoded) {
                        chiefNote = decodeURIComponent(escape(atob(chiefNoteEncoded)));
                    }
                } catch (e) {
                    console.error('Chief note decode error:', e);
                }

                showNotesModal(companyPaymentId, personnelNote, chiefNote);
            });
        }

        async function loadCompanyPaymentForEdit(companyPaymentId) {
            try {
                const response = await makeRequest(`/sirket-odemesi/${companyPaymentId}`, 'GET');

                $('#txtUId').val(response.id);
                $('#txtUAmount').val(response.amount);
                $('#txtUPersonnelNote').val(response.personnelNote || '');
                $('#txtUChiefNote').val(response.chiefNote || '');
                $('#selectUStatus').val(response.status);

                $('#selectUProjectId').val(response.projectId).trigger('change');
                $('#selectUExpenseId').val(response.expenseId).trigger('change');

                if (response.equipmentId) {
                    $('#selectUEquipmentId').val(response.equipmentId).trigger('change');
                }

                $('#updateCompanyPaymentRequestModal').modal('show');
            } catch (error) {
                console.error('Load company payment error:', error);
                handleError(error, 'Şirket ödemesi bilgisi yüklenirken hata oluştu.');
            }
        }

        async function updateCompanyPaymentRequest() {
            const companyPaymentId = $('#txtUId').val();
            const formData = new FormData();

            formData.append('ProjectId', $('#selectUProjectId').val());
            formData.append('ExpenseId', $('#selectUExpenseId').val());
            formData.append('Amount', $('#txtUAmount').val());
            formData.append('Status', $('#selectUStatus').val());

            const equipmentId = $('#selectUEquipmentId').val();
            if (equipmentId) {
                formData.append('EquipmentId', equipmentId);
            }

            const personnelNote = $('#txtUPersonnelNote').val().trim();
            if (personnelNote) {
                formData.append('PersonnelNote', personnelNote);
            }

            // Şef notunu sadece isUserSef ise gönder
            if (window.isUserSef) {
                const chiefNote = $('#txtUChiefNote').val().trim();
                if (chiefNote) {
                    formData.append('ChiefNote', chiefNote);
                }
                }

            // Dosyayı ekle
            const file = $('#fileUFile')[0].files[0];
            if (file) {
                formData.append('File', file);
            }

            try {
                await makeRequest(`/sirket-odemesi/${companyPaymentId}`, 'PUT', formData);
                showToast('Şirket ödemesi talebi başarıyla güncellendi.', 'success', 'Başarılı!');
                $('#updateCompanyPaymentRequestModal').modal('hide');
                companyPaymentsTable.ajax.reload();
            } catch (error) {
                console.error('Update company payment error:', error);
                handleError(error, 'Şirket ödemesi talebi güncellenirken hata oluştu.');
            }
        }

        function showNotesModal(companyPaymentId, personnelNote, chiefNote) {
            // Personel notunu göster
            if (personnelNote && personnelNote.trim() !== '') {
                // HTML escape yap ve satır sonlarını <br> ile değiştir
                var safePersonnelNote = $('<div>').text(personnelNote).html().replace(/\n/g, '<br>');
                $('#personnelNoteContent').html(safePersonnelNote);
            } else {
                $('#personnelNoteContent').html('<em class="text-muted">Not bulunmamaktadır.</em>');
            }

            // Şef notunu göster
            if (chiefNote && chiefNote.trim() !== '') {
                // HTML escape yap ve satır sonlarını <br> ile değiştir
                var safeChiefNote = $('<div>').text(chiefNote).html().replace(/\n/g, '<br>');
                $('#chiefNoteContent').html(safeChiefNote);
            } else {
                $('#chiefNoteContent').html('<em class="text-muted">Not bulunmamaktadır.</em>');
            }

            // Modal'ı göster
            const notesModal = new bootstrap.Modal(document.getElementById('notesModal'));
            notesModal.show();
        }

        async function deleteCompanyPaymentRequest(companyPaymentId) {
            try {
                const result = await Swal.fire({
                    title: 'Şirket Ödemesi Talebini Sil',
                    text: 'Bu şirket ödemesi talebini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-trash"></i> Evet, Sil',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await makeRequest(`/sirket-odemesi/${companyPaymentId}`, 'DELETE');
                            return response;
                        } catch (error) {
                            let errorMessage = 'Silme başarısız';
                            if (error.detail) {
                                errorMessage = error.detail;
                            } else if (error.title) {
                                errorMessage = error.title;
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;
                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Şirket ödemesi talebi başarıyla silindi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    companyPaymentsTable.ajax.reload(null, false);
                }
            } catch (error) {
                console.error('Silme hatası:', error);
            }
        }

        function openApproveModal(companyPaymentId) {
            // Şef değilse direkt onayla, modal açma
            if (!window.isUserSef) {
                approveCompanyPaymentDirect(companyPaymentId);
                return;
            }

            // Şef ise modal aç
            $('#txtApproveCompanyPaymentId').val(companyPaymentId);
            $('#txtApproveChiefNote').val('');
            $('#txtApproveChiefNote').prop('readonly', false);
            $('#approveCompanyPaymentModal').modal('show');
        }

        // Modal'dan çağrılan onaylama fonksiyonu
        async function approveCompanyPayment() {
            const companyPaymentId = $('#txtApproveCompanyPaymentId').val();
            let chiefNote = '';

            // Şef notunu sadece isUserSef ise al
            if (window.isUserSef) {
                chiefNote = $('#txtApproveChiefNote').val().trim();
            }

            await approveCompanyPaymentDirect(companyPaymentId, chiefNote);
        }

        // Direkt onaylama fonksiyonu (modal olmadan)
        async function approveCompanyPaymentDirect(companyPaymentId, chiefNote = '') {
            try {
                if (!companyPaymentId) {
                    showToast('Şirket ödemesi ID\'si bulunamadı', 'error', 'Hata');
                    return;
                }

                const submitBtn = $('#btnSubmitApprove');
                if (submitBtn.length > 0) {
                    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Onaylanıyor...');
                }

                const url = `/sirket-odemesi/${companyPaymentId}/onayla${chiefNote ? `?chiefNote=${encodeURIComponent(chiefNote)}` : ''}`;
                await makeRequest(url, 'PUT');

                showToast('Şirket ödemesi talebi başarıyla onaylandı.', 'success', 'Başarılı');
                $('#approveCompanyPaymentModal').modal('hide');
                companyPaymentsTable.ajax.reload(null, false);

            } catch (error) {
                console.error('Onaylama hatası:', error);
                handleError(error, 'Şirket ödemesi talebi onaylanırken hata oluştu');
            } finally {
                const submitBtn = $('#btnSubmitApprove');
                if (submitBtn.length > 0) {
                    submitBtn.prop('disabled', false).html('<i class="fas fa-check me-1"></i>Onayla');
                }
            }
        }

        function openRejectModal(companyPaymentId) {
            // Şef değilse direkt reddet, modal açma
            if (!window.isUserSef) {
                rejectCompanyPaymentDirect(companyPaymentId);
                return;
            }

            // Şef ise modal aç
            $('#txtRejectCompanyPaymentId').val(companyPaymentId);
            $('#txtRejectReason').val('');
            $('#rejectCompanyPaymentModal').modal('show');
        }

        // Modal'dan çağrılan reddetme fonksiyonu
        async function rejectCompanyPayment() {
            const companyPaymentId = $('#txtRejectCompanyPaymentId').val();
            const rejectReason = $('#txtRejectReason').val().trim();

            await rejectCompanyPaymentDirect(companyPaymentId, rejectReason);
        }

        // Direkt reddetme fonksiyonu (modal olmadan)
        async function rejectCompanyPaymentDirect(companyPaymentId, rejectReason = '') {
            try {
                if (!companyPaymentId) {
                    showToast('Şirket ödemesi ID\'si bulunamadı', 'error', 'Hata');
                    return;
                }

                const submitBtn = $('#btnRejectCompanyPayment');
                if (submitBtn.length > 0) {
                    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Reddediliyor...');
                }

                const url = `/sirket-odemesi/${companyPaymentId}/reddet${rejectReason ? `?rejectReason=${encodeURIComponent(rejectReason)}` : ''}`;
                await makeRequest(url, 'PUT');

                showToast('Şirket ödemesi talebi başarıyla reddedildi.', 'success', 'Başarılı');
                $('#rejectCompanyPaymentModal').modal('hide');
                companyPaymentsTable.ajax.reload(null, false);

            } catch (error) {
                console.error('Reddetme hatası:', error);
                handleError(error, 'Şirket ödemesi talebi reddedilirken hata oluştu');
            } finally {
                const submitBtn = $('#btnRejectCompanyPayment');
                if (submitBtn.length > 0) {
                    submitBtn.prop('disabled', false).html('<i class="fas fa-times me-1"></i>Reddet');
                }
            }
        }
    </script>
}