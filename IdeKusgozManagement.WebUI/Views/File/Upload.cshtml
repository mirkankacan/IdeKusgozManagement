@{
    ViewData["Title"] = "Evrak Yükle";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link href="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <style>
        .dropzone {
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            min-height: 200px;
            padding: 20px;
        }

            .dropzone .dz-preview .dz-progress {
                border:unset;
                background:unset;
            }
        .dropzone:hover {
            border-color: #0056b3;
            background: #e3f2fd;
        }

        .dropzone.dz-drag-hover {
            border-color: #28a745;
            background: #d4edda;
        }

        .dropzone .dz-preview {
            margin: 10px;
            min-height: 0;
        }

        .dropzone .dz-preview .dz-image {
            border-radius: 8px;
            overflow: hidden;
        }

        .dropzone .dz-preview .dz-error-message {
            background: #dc3545;
            color: white;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
        }

        .file-type-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .dropzone.dz-disabled {
            opacity: 0.6;
            pointer-events: none;
            cursor: not-allowed;
            background: #e9ecef;
        }

        .dropzone.dz-disabled .dz-message {
            opacity: 0.5;
        }
    </style>
}

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-file me-2"></i>
                    Evrak Yükleme
                </h5>
                <!-- File Type Selection -->
                <div class="file-type-section">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="department-select" class="form-label">Departman</label> <span class="text-danger">*</span>
                            <select id="department-select" class="form-select">
                                <option value="">Departman seçin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="document-type-select" class="form-label">Evrak Tipi</label>  <span class="text-danger">*</span>
                            <select id="document-type-select" class="form-select">
                                <option value="">Evrak tipini seçin</option>
                            </select>
                        </div>

                    </div>
                      <div class="row mt-2">
                        <div class="col-md-6">
                            <label for="user-select" class="form-label">Hedef Kullanıcı</label>
                            <select id="user-select" class="form-select">
                                <option value="">Kullanıcı seçin</option>
                            </select>
                        </div>
                        <div class="col-md-2 mt-5">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="hasRenewalPeriodCheckbox">
                                <label class="form-check-label" for="hasRenewalPeriodCheckbox">
                                    Süreli mi?
                                </label>
                            </div>
                        </div>
                        <div id="dateRangeContainer" style="display: none;" class="col-md-4">
                            <label for="date-range" class="form-label">Tarih Aralığı</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="date-range" placeholder="Başlangıç - Bitiş">
                                <span class="input-group-text">
                                    <i class="fas fa-calendar"></i>
                                </span>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                'Süreli mi' seçeneği seçilip tarih aralığı seçilmeden evrak yüklenirse başlangıç tarihini yapay zeka tespit eder. Bitiş tarihi sistemdeki yenileme süresi ile hesaplanır
                            </small>
                        </div>
                      </div>

                </div>

                <!-- Dropzone Area -->
                <form id="fileUploadForm" class="dropzone mt-3" action="/dosya/yukle" method="post"
                    enctype="multipart/form-data">
                    <div class="dz-message" data-dz-message>
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted" id="dropzone-message">Lütfen önce departman ve evrak tipi seçin</h5>
                            <p class="text-muted mb-0" id="dropzone-submessage"></p>
                            <small class="text-muted">Maksimum dosya boyutu: 50MB</small>
                        </div>
                    </div>
                </form>

                <div id="uploadButtonsContainer" class="d-flex justify-content-between align-items-center mt-3"
                    style="display: none !important;">
                    <div>
                        <button type="button" id="uploadBtn" class="btn btn-primary me-2">
                            <i class="fas fa-upload me-1"></i> Dosyaları Yükle
                        </button>
                        <button type="button" id="clearBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> Temizle
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Dosyaları seçtikten sonra "Dosyaları Yükle" butonuna basın
                    </small>
                </div>

                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-4" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Yükleme İlerlemesi</span>
                        <span id="progressText" class="text-muted">0%</span>
                    </div>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        let filesTable;
        let myDropzone;

        $(document).ready(async function () {
            // await initializeDataTable();
            initializeDropzone();
            await initializeDepartmentSelect();
            // Initialize document type and user selects as empty initially
            await initializeDocumentTypeSelect(null);
            await initializeUserSelect(null);
            // Initial dropzone status check
            checkDropzoneStatus();
            // Initialize checkbox handler (daterangepicker checkbox işaretlendiğinde initialize edilecek)
            initializeTemporaryCheckbox();
        });

        async function initializeDocumentTypeSelect(departmentId) {
            try {
                if (!departmentId) {
                    $('#document-type-select').empty();
                    $('#document-type-select').append('<option value="">Evrak tipini seçin</option>');
                    $('#document-type-select').select2({
                        placeholder: 'Evrak tipini seçin',
                        theme: 'bootstrap-5',
                        allowClear: true,
                        width: '100%'
                    });
                    return;
                }

                const response = await $.ajax({
                    url: `/dokuman-tip-liste/${departmentId}`,
                    type: 'GET',
                    dataType: 'json'
                });

                if (response && response.isSuccess && response.data) {
                    $('#document-type-select').empty();
                    $('#document-type-select').append('<option value="">Evrak tipini seçin</option>');
                    response.data.forEach(docType => {
                        $('#document-type-select').append(`<option value="${docType.id}">${docType.name}</option>`);
                    });
                }

                $('#document-type-select').select2({
                    placeholder: 'Evrak tipini seçin',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });

                // Document type change event listener (for select2)
                $('#document-type-select').on('change select2:select select2:clear', function () {
                    checkDropzoneStatus();
                });
            } catch (error) {
                console.error('Evrak tipi listesi yüklenirken hata:', error);
                toastr.error('Evrak tipi listesi yüklenirken hata oluştu', 'Hata!');
            }
        }

        async function initializeDepartmentSelect() {
            try {
                const response = await $.ajax({
                    url: '/departman-liste',
                    type: 'GET',
                    dataType: 'json'
                });

                if (response && response.isSuccess && response.data) {
                    $('#department-select').empty();
                    $('#department-select').append('<option value="">Departman seçin</option>');
                    response.data.forEach(department => {
                        $('#department-select').append(`<option value="${department.id}">${department.name}</option>`);
                    });
                }

                $('#department-select').select2({
                    placeholder: 'Departman seçin',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });

                // Department change event listener
                $('#department-select').on('change', async function () {
                    const departmentId = $(this).val();

                    // Reset document type and user selects
                    $('#document-type-select').val(null).trigger('change');
                    $('#user-select').val(null).trigger('change');

                    if (departmentId) {
                        await initializeDocumentTypeSelect(departmentId);
                        await initializeUserSelect(departmentId);
                    } else {
                        await initializeDocumentTypeSelect(null);
                        await initializeUserSelect(null);
                    }

                    // Dropzone durumunu kontrol et
                    checkDropzoneStatus();
                });
            } catch (error) {
                console.error('Departman listesi yüklenirken hata:', error);
                toastr.error('Departman listesi yüklenirken hata oluştu', 'Hata!');
            }
        }

        function checkDropzoneStatus() {
            const departmentId = $("#department-select").val();
            const documentTypeId = $("#document-type-select").val();
            const isEnabled = departmentId && documentTypeId;

            if (myDropzone) {
                if (isEnabled) {
                    myDropzone.enable();
                    $("#fileUploadForm").removeClass("dz-disabled");
                    $("#dropzone-message").text("Dosyalarınızı buraya sürükleyip bırakın");
                    $("#dropzone-submessage").html("veya <strong>tıklayarak</strong> dosya seçin");
                } else {
                    myDropzone.disable();
                    $("#fileUploadForm").addClass("dz-disabled");
                    $("#dropzone-message").text("Lütfen önce departman ve evrak tipi seçin");
                    $("#dropzone-submessage").text("");
                }
            }
        }

        function initializeDropzone() {
            Dropzone.autoDiscover = false;

            myDropzone = new Dropzone("#fileUploadForm", {
                url: "/FileUpload/yukle",
                method: "post",
                paramName: "files",
                maxFilesize: 50,
                maxFiles: 5,
                acceptedFiles: "image/*,application/pdf,.doc,.docx,.txt,.xlsx,.xls",
                addRemoveLinks: true,
                dictDefaultMessage: "",
                dictRemoveFile: "Kaldır",
                dictCancelUpload: "İptal",
                dictUploadCanceled: "Yükleme iptal edildi",
                dictInvalidFileType: "Bu dosya türü desteklenmiyor",
                dictFileTooBig: "Dosya çok büyük ({{filesize}}MB). Maksimum: {{maxFilesize}}MB",
                dictMaxFilesExceeded: "Maksimum {{maxFiles}} dosya yükleyebilirsiniz",
                autoProcessQueue: false, // Otomatik yükleme kapalı
                uploadMultiple: false,   // Manuel gönderim için false
                parallelUploads: 1,
                disabled: true, // Başlangıçta disabled

                init: function () {
                    const dropzone = this;

                    // Dropzone'u başlangıçta disabled yap
                    dropzone.disable();
                    $("#fileUploadForm").addClass("dz-disabled");

                    // Dosya eklenmeye çalışıldığında kontrol et
                    this.on("addedfile", function (file) {
                        const departmentId = $("#department-select").val();
                        const documentTypeId = $("#document-type-select").val();

                        if (!departmentId || !documentTypeId) {
                            toastr.warning("Lütfen önce departman ve evrak tipi seçin!", 'Uyarı!');
                            dropzone.removeFile(file);
                            return;
                        }

                        console.log("Dosya eklendi:", file.name);
                        // Butonları göster
                        updateUploadButtonsVisibility();
                    });

                    this.on("removedfile", function (file) {
                        console.log("Dosya kaldırıldı:", file.name);
                        if (dropzone.files.length === 0) {
                            hideProgress();
                            // Butonları gizle
                            updateUploadButtonsVisibility();
                        }
                    });

                    // Dosya eklendiğinde otomatik işlem yapmayı kaldırdık
                    // this.on("addedfiles", function (files) {
                    //     if (files.length > 0) {
                    //         setTimeout(() => {
                    //             processAllFiles();
                    //         }, 500);
                    //     }
                    // });

                    this.on("success", function (file, response) {
                        console.log("Dosya yükleme başarılı:", response);

                        if (response && response.success) {
                            toastr.success("Dosyalar başarıyla yüklendi", 'Başarılı!');
                        } else {
                            toastr.error(response?.message || "Yükleme başarısız", 'Hata!');
                        }

                        hideProgress();

                        if (typeof filesTable !== 'undefined' && filesTable.ajax) {
                            filesTable.ajax.reload(null, false);
                        }

                        setTimeout(() => {
                            dropzone.removeAllFiles();
                        }, 2000);
                    });

                    this.on("error", function (file, errorMessage) {
                        console.log("Yükleme hatası:", errorMessage);

                        let message = "Yükleme sırasında hata oluştu";
                        if (typeof errorMessage === 'string') {
                            message = errorMessage;
                        } else if (errorMessage && errorMessage.message) {
                            message = errorMessage.message;
                        }

                        toastr.error(message, 'Hata!');
                        hideProgress();
                    });

                    this.on("totaluploadprogress", function (uploadProgress) {
                        updateProgress(uploadProgress);
                    });

                    // Upload butonuna click event'i ekle
                    $("#uploadBtn").on("click", function () {
                        processAllFiles();
                    });

                    // Clear butonuna click event'i ekle
                    $("#clearBtn").on("click", function () {
                        dropzone.removeAllFiles(true);
                        hideProgress();
                        updateUploadButtonsVisibility();
                    });

                    // Manuel dosya yükleme fonksiyonu
                    function processAllFiles() {
                        const departmentId = $("#department-select").val();
                        const documentTypeId = $("#document-type-select").val();
                        const targetUserId = $("#user-select").val();
                        // Validasyonlar
                        if (!departmentId) {
                            toastr.warning("Lütfen departman seçin!", 'Uyarı!');
                            return;
                        }

                        if (!documentTypeId) {
                            toastr.warning("Lütfen evrak tipini seçin!", 'Uyarı!');
                            return;
                        }

                        const files = dropzone.getAcceptedFiles();
                        if (files.length === 0) {
                            toastr.warning("Lütfen en az bir dosya seçin!", 'Uyarı!');
                            return;
                        }

                        console.log(`${files.length} dosya toplu olarak yüklenecek...`);

                        // Manuel FormData oluştur ve gönder
                        uploadFilesManually(files, departmentId, documentTypeId, targetUserId);
                    }

                    function uploadFilesManually(files, departmentId, documentTypeId, targetUserId) {
                        const formData = new FormData();

                        const token = $('input[name="__RequestVerificationToken"]').val();
                        formData.append("__RequestVerificationToken", token);

                        // Süreli mi kontrolü
                        const hasRenewalPeriod = $('#hasRenewalPeriodCheckbox').is(':checked');
                        let startDate = null;
                        let endDate = null;

                                   if (hasRenewalPeriod) {
            const dateRangeValue = $('#date-range').val();
            const picker = $('#date-range').data('daterangepicker');

            // Sadece tarihler seçilmiş ise startDate/endDate set et
            if (dateRangeValue && dateRangeValue.trim() !== '' && picker && picker.startDate && picker.endDate) {
                startDate = picker.startDate.format('YYYY-MM-DD');
                endDate = picker.endDate.format('YYYY-MM-DD');
            }
            // Tarih seçilmemiş ise startDate/endDate null kalır, AI PDF'den bulacak
        }
                          files.forEach(function (file, index) {
                            formData.append(`[${index}].FormFile`, file);
                            formData.append(`[${index}].DepartmentId`, departmentId);
                            formData.append(`[${index}].DocumentTypeId`, documentTypeId);
                             formData.append(`[${index}].HasRenewalPeriod`, hasRenewalPeriod);
                        if (targetUserId) {
                                   formData.append(`[${index}].TargetUserId`, targetUserId);
                               }

                               if (hasRenewalPeriod && startDate && endDate) {
                                   formData.append(`[${index}].StartDate`, startDate);
                                   formData.append(`[${index}].EndDate`, endDate);
                               }
                        });

                        // Progress göster
                        showProgress();
                        $("#uploadBtn").prop('disabled', true).text('Yükleniyor...');

                        // AJAX ile gönder
                        $.ajax({
                            url: '/dosya/yukle',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            xhr: function () {
                                const xhr = new window.XMLHttpRequest();
                                // Progress tracking
                                xhr.upload.addEventListener("progress", function (evt) {
                                    if (evt.lengthComputable) {
                                        const percentComplete = (evt.loaded / evt.total) * 100;
                                        updateProgress(percentComplete);
                                    }
                                }, false);
                                return xhr;
                            },
                            success: function (response) {
                                console.log('Başarılı:', response);

                                if (response && response.success) {
                                    toastr.success(`${files.length} dosya başarıyla yüklendi!`, 'Başarılı!');
                                } else {
                                    toastr.success(response?.message || 'Dosyalar başarıyla yüklendi!', 'Başarılı!');
                                }

                                // Tabloyu yenile
                                if (typeof filesTable !== 'undefined' && filesTable.ajax) {
                                    filesTable.ajax.reload(null, false);
                                }

                                // Dosyaları temizle
                                setTimeout(() => {
                                    dropzone.removeAllFiles(true);
                                    updateUploadButtonsVisibility();
                                }, 2000);
                            },
                            error: function (xhr, status, error) {
                                console.error('Hata:', xhr.responseText);

                                let errorMessage = 'Yükleme sırasında hata oluştu!';

                                try {
                                    const errorResponse = JSON.parse(xhr.responseText);
                                    if (errorResponse.message) {
                                        errorMessage = errorResponse.message;
                                    } else if (errorResponse.errors && errorResponse.errors.length > 0) {
                                        errorMessage = errorResponse.errors.join(', ');
                                    }
                                } catch (e) {
                                    errorMessage = xhr.responseText || errorMessage;
                                }

                                toastr.error(errorMessage, 'Hata!');
                            },
                            complete: function () {
                                hideProgress();
                                $("#uploadBtn").prop('disabled', false).text('Dosyaları Yükle');
                            }
                        });
                    }
                }
            });
        }

        function updateUploadButtonsVisibility() {
            if (myDropzone && myDropzone.files.length > 0) {
                $("#uploadButtonsContainer").show();
            } else {
                $("#uploadButtonsContainer").hide();
            }
        }

            function initializeDateRangePicker() {
            // Daterangepicker'ı sadece bir kez initialize et
            if ($('#date-range').data('daterangepicker')) {
                return; // Zaten initialize edilmiş
            }

            $('#date-range').daterangepicker({
                locale: turkishLocale,
                opens: 'left',
                autoUpdateInput: false,
                autoApply: true,              
            });

            $('#date-range').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
            });

            $('#date-range').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
            });

            // Calendar icon'a tıklandığında input'u focus et
            $('#dateRangeContainer .fa-calendar').parent().on('click', function () {
                $(this).closest('.input-group').find('#date-range').focus();
            });
        }
        function initializeTemporaryCheckbox() {
            $('#hasRenewalPeriodCheckbox').on('change', function () {
                if ($(this).is(':checked')) {
                    // Daterangepicker'ı initialize et
                    initializeDateRangePicker();
                    $('#dateRangeContainer').slideDown();
                } else {
                    $('#dateRangeContainer').slideUp();
                    $('#date-range').val('');
                }
            });
        }

   

        function showProgress() {
            $("#uploadProgress").show();
            updateProgress(0);
        }

        function hideProgress() {
            $("#uploadProgress").hide();
        }

        function updateProgress(progress) {
            const percentage = Math.round(progress);
            $("#progressBar").css("width", percentage + "%");
            $("#progressText").text(percentage + "%");
        }
        async function initializeUserSelect(departmentId) {
            try {
                if (!departmentId) {
                    $('#user-select').empty();
                    $('#user-select').append('<option value="">Kullanıcı seçin</option>');
                    $('#user-select').select2({
                        placeholder: 'Kullanıcı seçin',
                        theme: 'bootstrap-5',
                        allowClear: true,
                        width: '100%'
                    });
                    return;
                }

                const response = await $.ajax({
                    url: `/kullanici/departman/${departmentId}`,
                    type: 'GET',
                    dataType: 'json'
                });

                if (response && response.isSuccess && response.data) {
                    $('#user-select').each(function () {
                        const currentSelect = $(this);
                        currentSelect.empty();
                        currentSelect.append('<option value="">Kullanıcı seçin</option>');
                        response.data.forEach(user => {
                            currentSelect.append(`<option value="${user.id}">${user.fullName}</option>`);
                        });
                    });
                }

                $('#user-select').select2({
                    placeholder: 'Kullanıcı seçin',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });
            } catch (error) {
                console.error('Kullanıcı listesi yüklenirken hata:', error);
                toastr.error('Kullanıcı listesi yüklenirken hata oluştu', 'Hata!');
            }
        }
        async function deleteFile(fileId) {
            try {
                const result = await Swal.fire({
                    title: 'Evrağı Sil',
                    text: 'Bu evrağı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-trash"></i> Evet, Sil',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await $.ajax({
                                url: `/dosya/${fileId}`,
                                type: 'DELETE',
                                contentType: 'application/json'
                            });
                            return response;
                        } catch (error) {
                            let errorMessage = 'Silme başarısız';
                            if (error.responseJSON) {
                                if (error.responseJSON.message) {
                                    errorMessage = error.responseJSON.message;
                                } else if (error.responseJSON.errors && error.responseJSON.errors.length > 0) {
                                    errorMessage = error.responseJSON.errors.join(', ');
                                }
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;

                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Evrak başarıyla silindi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    myLeaveRequestsTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Silme hatası:', error);
            }
        }
    </script>
}