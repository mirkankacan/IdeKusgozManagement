@{
    ViewData["Title"] = "Evrak Yükle";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link href="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone.css" rel="stylesheet" type="text/css" />

    <style>
        .dropzone {
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            min-height: 200px;
            padding: 20px;
        }

            .dropzone:hover {
                border-color: #0056b3;
                background: #e3f2fd;
            }

            .dropzone.dz-drag-hover {
                border-color: #28a745;
                background: #d4edda;
            }

            .dropzone .dz-preview {
                margin: 10px;
                min-height: 0;
            }

                .dropzone .dz-preview .dz-image {
                    border-radius: 8px;
                    overflow: hidden;
                }

                .dropzone .dz-preview .dz-error-message {
                    background: #dc3545;
                    color: white;
                    border-radius: 4px;
                    padding: 5px 10px;
                    font-size: 12px;
                }

        .file-type-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
}

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-file me-2"></i>
                    Evrak Yükleme
                </h5>

                <!-- File Type Selection -->
                <div class="file-type-section">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="fileType" class="form-label">Dosya Türü</label>
                            <select id="fileType" class="form-select">
                                <option value="">Dosya türünü seçin</option>
                                <option value="1">Resim</option>
                                <option value="2">Doküman</option>
                                <option value="3">PDF</option>
                                <option value="4">Diğer</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="user-select" class="form-label">Hedef Kullanıcı</label>
                            <select id="user-select" class="form-select">
                                <option value="">Kullanıcı seçin</option>

                            </select>
                        </div>
                    </div>
                </div>

                <!-- Dropzone Area -->
                <form id="fileUploadForm" class="dropzone" action="/dosya/yukle" method="post" enctype="multipart/form-data">
                    <div class="dz-message" data-dz-message>
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Dosyalarınızı buraya sürükleyip bırakın</h5>
                            <p class="text-muted mb-0">veya <strong>tıklayarak</strong> dosya seçin</p>
                            <small class="text-muted">Maksimum dosya boyutu: 50MB</small>
                        </div>
                    </div>
                </form>

                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-4" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Yükleme İlerlemesi</span>
                        <span id="progressText" class="text-muted">0%</span>
                    </div>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Files List -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-list me-2"></i>
                    Yüklenen Dosyalar
                </h5>

                <div class="table-responsive">
                    <table id="filesTable" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th width="5%">#</th>
                                <th>Dosya Adı</th>
                                <th>Dosya Türü</th>
                                <th>Boyut</th>
                                <th>Hedef Kullanıcı</th>
                                <th>Durum</th>
                                <th>Yükleme Tarihi</th>
                                <th width="10%">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone-min.js"></script>

    <script>
        let filesTable;
        let myDropzone;

        $(document).ready(async function () {
            // await initializeDataTable();
            initializeDropzone();
            initializeSelect2();
            await initializeUserSelect();
        });

        function initializeSelect2() {
            $('#fileType').select2({
                theme: 'bootstrap-5',
                placeholder: 'Dosya türünü seçin',
                allowClear: false
            });
        }

        function initializeDropzone() {
            // Disable auto discover
            Dropzone.autoDiscover = false;

            myDropzone = new Dropzone("#fileUploadForm", {
                url: "/dosya/yukle",
                method: "post",
                paramName: "FormFile",
                maxFilesize: 50, // MB
                maxFiles: 5,
                acceptedFiles: "image/*,application/pdf,.doc,.docx,.txt,.xlsx,.xls",
                addRemoveLinks: true,
                dictDefaultMessage: "",
                dictRemoveFile: "Kaldır",
                dictCancelUpload: "İptal",
                dictUploadCanceled: "Yükleme iptal edildi",
                dictInvalidFileType: "Bu dosya türü desteklenmiyor",
                dictFileTooBig: "Dosya çok büyük ({{filesize}}MB). Maksimum: {{maxFilesize}}MB",
                dictMaxFilesExceeded: "Maksimum {{maxFiles}} dosya yükleyebilirsiniz",
                autoProcessQueue: false,
                uploadMultiple: false,
                parallelUploads: 1,

                init: function() {
                    const dropzone = this;
                    let totalFiles = 0;
                    let processedFiles = 0;

                    // Handle file addition
                    this.on("addedfile", function(file) {
                        console.log("Dosya eklendi:", file.name);
                        totalFiles++;
                    });

                    // Handle file removal
                    this.on("removedfile", function(file) {
                        console.log("Dosya kaldırıldı:", file.name);
                        totalFiles--;
                        if (totalFiles === 0) {
                            hideProgress();
                        }
                    });

                    // Start upload when files are added
                    this.on("addedfiles", function(files) {
                        if (files.length > 0) {
                            setTimeout(() => {
                                processFiles();
                            }, 500);
                        }
                    });

                    // Handle sending additional data
                    this.on("sending", function(file, xhr, formData) {
                        const fileType = $("#fileType").val();
                        const targetUserId = $("#targetUserId").val();
                        const token = $('input[name="__RequestVerificationToken"]').val();

                        formData.append("__RequestVerificationToken", token);
                        formData.append("FileType", fileType);
                        formData.append("TargetUserId", targetUserId);

                    });

                    // Handle upload progress
                    this.on("uploadprogress", function(file, progress) {
                        updateProgress(progress);
                    });

                    // Handle successful upload
                    this.on("success", function(file, response) {
                        processedFiles++;
                        console.log("Yükleme başarılı:", response);

                        if (response && response.isSuccess) {
                            toastr.success(`${file.name} başarıyla yüklendi`, 'Başarılı!');
                        } else {
                            toastr.error(response?.message || "Yükleme başarısız", 'Hata!');
                        }

                        checkUploadComplete();
                    });

                    // Handle upload error
                    this.on("error", function(file, errorMessage) {
                        processedFiles++;
                        console.log("Yükleme hatası:", errorMessage);

                        let message = "Yükleme sırasında hata oluştu";
                        if (typeof errorMessage === 'string') {
                            message = errorMessage;
                        } else if (errorMessage && errorMessage.message) {
                            message = errorMessage.message;
                        }

                        toastr.error(`${file.name}: ${message}`, 'Hata!');
                        checkUploadComplete();
                    });

                    function processFiles() {
                        const fileType = $("#fileType").val();

                        if (!fileType) {
                            toastr.warning("Lütfen dosya türünü seçin!", 'Uyarı!');
                            dropzone.removeAllFiles();
                            return;
                        }

                        showProgress();
                        processedFiles = 0;
                        dropzone.processQueue();
                    }

                    function checkUploadComplete() {
                        if (processedFiles === totalFiles) {
                            hideProgress();
                            filesTable.ajax.reload(null, false);

                            // Clear the dropzone after successful upload
                            setTimeout(() => {
                                dropzone.removeAllFiles();
                                totalFiles = 0;
                                processedFiles = 0;
                            }, 2000);
                        }
                    }
                }
            });
        }

        async function initializeDataTable() {
            filesTable = $('#filesTable').DataTable({
                "processing": true,
                "ajax": {
                    "url": `/dosya/liste/${userId}`,
                    "type": "GET",
                    "dataSrc": function (json) {
                        if (json && json.isSuccess && json.data) {
                            return json.data;
                        }
                        return [];
                    },
                    "error": function (xhr, error, code) {
                        console.error('DataTables AJAX error:', error);
                        let errorMessage = 'Veriler yüklenirken hata oluştu';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ': ' + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ': ' + xhr.responseText;
                            }
                        } catch (e) {
                            errorMessage += ': ' + error;
                        }
                        toastr.error(errorMessage);
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "width": "5%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            return '';
                        }
                    },
                    {
                        "data": "fileName",
                        "render": function (data) {
                            return data || '';
                        }
                    },
                    {
                        "data": "fileType",
                        "className": "text-center",
                        "render": function (data) {
                            const types = {
                                1: '<span class="badge bg-info">Resim</span>',
                                2: '<span class="badge bg-primary">Doküman</span>',
                                3: '<span class="badge bg-danger">PDF</span>',
                                4: '<span class="badge bg-secondary">Diğer</span>'
                            };
                            return types[data] || '<span class="badge bg-secondary">Bilinmiyor</span>';
                        }
                    },
                    {
                        "data": "fileSize",
                        "className": "text-center",
                        "render": function (data) {
                            if (!data) return '';
                            const size = parseInt(data);
                            if (size < 1024) return size + ' B';
                            if (size < 1048576) return Math.round(size / 1024) + ' KB';
                            return Math.round(size / 1048576) + ' MB';
                        }
                    },
                    {
                        "data": "targetUserId",
                        "render": function (data) {
                            return data || '-';
                        }
                    },
                    {
                        "data": "status",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (data === 1) {
                                return '<span class="badge bg-success">Aktif</span>';
                            } else {
                                return '<span class="badge bg-secondary">Pasif</span>';
                            }
                        }
                    },
                    {
                        "data": "createdDate",
                        "render": function (data) {
                            return data ? new Date(data).toLocaleString('tr-TR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                        }
                    },
                    {
                        "data": null,
                        "width": "10%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {
                            let actions = '';

                            // Download button
                            if (row.id) {
                                actions += `
                                    <a href="/dosya/indir/${row.id}"
                                       class="btn btn-outline-primary btn-sm me-1"
                                       title="İndir" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                `;
                            }

                            // Delete button
                            actions += `
                                <button type="button"
                                        class="btn btn-outline-danger btn-sm"
                                        onclick="deleteFile('${row.id}')"
                                        title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;

                            return actions;
                        }
                    }
                ],
                "language": {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json'
                },
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "pageLength": 10,
                "responsive": true,
                "searchDelay": 300,
                "order": [[6, "desc"]], // Order by created date desc
                "drawCallback": function () {
                    var api = this.api();
                    var pageInfo = api.page.info();

                    api.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });
                    $('[title]').tooltip();
                }
            });
        }

        function showProgress() {
            $("#uploadProgress").show();
            updateProgress(0);
        }

        function hideProgress() {
            $("#uploadProgress").hide();
        }

        function updateProgress(progress) {
            const percentage = Math.round(progress);
            $("#progressBar").css("width", percentage + "%");
            $("#progressText").text(percentage + "%");
        }
          async function initializeUserSelect() {
            try {
                const response = await $.ajax({
                    url: '/kullanici/liste',
                    type: 'GET',
                    dataType: 'json'
                });

                if (response && response.isSuccess && response.data) {
                    $('#user-select').each(function () {
                        const currentSelect = $(this);
                        currentSelect.empty();
                        currentSelect.append('<option value="">Kullanıcı seçin</option>');
                        response.data.forEach(user => {
                            currentSelect.append(`<option value="${user.id}">${user.fullName}</option>`);
                        });
                    });
                }

                $('#user-select').select2({
                    placeholder: 'Kullanıcı seçin',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });
            } catch (error) {
                console.error('Kullanıcı listesi yüklenirken hata:', error);
                toastr.error('Kullanıcı listesi yüklenirken hata oluştu', 'Hata!');
            }
        }
          async function deleteFile(fileId) {
            try {
                const result = await Swal.fire({
                    title: 'Evrağı Sil',
                    text: 'Bu evrağı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-trash"></i> Evet, Sil',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await $.ajax({
                                url: `/dosya/${fileId}`,
                                type: 'DELETE',
                                contentType: 'application/json',
                                headers: {
                                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                                }
                            });
                            return response;
                        } catch (error) {
                            let errorMessage = 'Silme başarısız';
                            if (error.responseJSON) {
                                if (error.responseJSON.message) {
                                    errorMessage = error.responseJSON.message;
                                } else if (error.responseJSON.errors && error.responseJSON.errors.length > 0) {
                                    errorMessage = error.responseJSON.errors.join(', ');
                                }
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                                                        return false;

                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Evrak başarıyla silindi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    myLeaveRequestsTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Silme hatası:', error);
            }
        }
    </script>
}