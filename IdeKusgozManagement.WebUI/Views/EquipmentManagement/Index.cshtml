@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Ekipman Yönetimi";
}

@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
}

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-tools me-2"></i>
                    Ekipman Yönetimi
                </h5>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEquipmentModal">
                    <i class="fas fa-plus me-2"></i>Ekipman Ekle
                </button>
                <br />
                <br />
                <div class="table-responsive">
                    <table id="equipmentsTable" class="table table-striped table-hover display" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>EKIPMAN ADI</th>
                                <th>OLUŞTURMA TARİHİ</th>
                                <th>OLUŞTURAN</th>
                                <th>İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- DataTables will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Equipment Modal -->
<div class="modal fade" id="createEquipmentModal" tabindex="-1" aria-labelledby="createEquipmentModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ekipman Ekleme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form class="needs-validation" novalidate id="createEquipmentForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="txtCName" class="form-label">Ekipman Adı</label>
                            <input type="text" class="form-control" id="txtCName" required>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir ekipman adı giriniz.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Equipment Modal -->
<div class="modal fade" id="updateEquipmentModal" tabindex="-1" aria-labelledby="updateEquipmentModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ekipman Güncelleme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form class="needs-validation" novalidate id="updateEquipmentForm">
                <div class="modal-body">
                    <input type="hidden" id="txtUId">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="txtUName" class="form-label">Ekipman Adı</label>
                            <input type="text" class="form-control" id="txtUName" required>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir ekipman adı giriniz.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary">Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        let equipmentsTable;

        $(document).ready(function () {
            initializeDataTable();
            setupEventListeners();
        });

        function initializeDataTable() {
            equipmentsTable = $('#equipmentsTable').DataTable({
                "processing": true,
                "serverSide": false,
                "ajax": {
                    "url": "/ekipman-yonetimi/liste",
                    "type": "GET",
                    "headers": {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    "dataSrc": function (json) {
                        if (json.isSuccess) {
                            return json.data;
                        } else {
                            toastr.error(json.message, 'Hata!');
                            return [];
                        }
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { "data": "name" },
                    {
                        "data": "createdDate",
                        "render": function (data) {
                            return new Date(data).toLocaleDateString('tr-TR');
                        }
                    },
                    { "data": "createdBy" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-outline-primary edit-equipment" data-id="${row.id}" title="Düzenle">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-equipment" data-id="${row.id}" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                    }
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/tr.json"
                },
                "responsive": true,
                "autoWidth": false
            });
        }

        function setupEventListeners() {
            // Create equipment form
            $('#createEquipmentForm').on('submit', function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    createEquipment();
                }
                $(this).addClass('was-validated');
            });

            // Update equipment form
            $('#updateEquipmentForm').on('submit', function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    updateEquipment();
                }
                $(this).addClass('was-validated');
            });

            // Edit button click
            $(document).on('click', '.edit-equipment', function () {
                const equipmentId = $(this).data('id');
                loadEquipmentForEdit(equipmentId);
            });

            // Delete button click
            $(document).on('click', '.delete-equipment', function () {
                const equipmentId = $(this).data('id');
                deleteEquipment(equipmentId);
            });

            // Clear forms when modals hide
            $('#createEquipmentModal').on('hidden.bs.modal', function () {
                $('#createEquipmentForm')[0].reset();
                $('#createEquipmentForm').removeClass('was-validated');
            });

            $('#updateEquipmentModal').on('hidden.bs.modal', function () {
                $('#updateEquipmentForm')[0].reset();
                $('#updateEquipmentForm').removeClass('was-validated');
            });
        }

        async function createEquipment() {
            const equipmentData = {
                name: $('#txtCName').val()
            };

            try {
                const response = await $.ajax({
                    url: '/ekipman-yonetimi',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(equipmentData),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                });

                if (response.isSuccess) {
                    toastr.success(response.message, 'Başarılı!');
                    $('#createEquipmentModal').modal('hide');
                    equipmentsTable.ajax.reload();
                } else {
                    toastr.error(response.message, 'Hata!');
                }
            } catch (error) {
                console.error('Create equipment error:', error);
                toastr.error('Ekipman oluşturulurken bir hata oluştu', 'Hata!');
            }
        }

        async function loadEquipmentForEdit(equipmentId) {
            try {
                const response = await $.ajax({
                    url: `/ekipman-yonetimi/${equipmentId}`,
                    type: 'GET',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                });

                if (response.isSuccess) {
                    $('#txtUId').val(response.data.id);
                    $('#txtUName').val(response.data.name);
                    $('#updateEquipmentModal').modal('show');
                } else {
                    toastr.error(response.message, 'Hata!');
                }
            } catch (error) {
                console.error('Load equipment error:', error);
                toastr.error('Ekipman bilgileri yüklenirken bir hata oluştu', 'Hata!');
            }
        }

        async function updateEquipment() {
            const equipmentId = $('#txtUId').val();
            const equipmentData = {
                name: $('#txtUName').val()
            };

            try {
                const response = await $.ajax({
                    url: `/ekipman-yonetimi/${equipmentId}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(equipmentData),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                });

                if (response.isSuccess) {
                    toastr.success(response.message, 'Başarılı!');
                    $('#updateEquipmentModal').modal('hide');
                    equipmentsTable.ajax.reload();
                } else {
                    toastr.error(response.message, 'Hata!');
                }
            } catch (error) {
                console.error('Update equipment error:', error);
                toastr.error('Ekipman güncellenirken bir hata oluştu', 'Hata!');
            }
        }

        async function deleteEquipment(equipmentId) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu ekipman silinecek ve geri alınamayacak!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, Sil!',
                cancelButtonText: 'İptal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await $.ajax({
                            url: `/ekipman-yonetimi/${equipmentId}`,
                            type: 'DELETE',
                            headers: {
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            }
                        });

                        if (response.isSuccess) {
                            toastr.success(response.message, 'Başarılı!');
                            equipmentsTable.ajax.reload();
                        } else {
                            toastr.error(response.message, 'Hata!');
                        }
                    } catch (error) {
                        console.error('Delete equipment error:', error);
                        toastr.error('Ekipman silinirken bir hata oluştu', 'Hata!');
                    }
                }
            });
        }
    </script>
}
