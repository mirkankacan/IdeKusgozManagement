@{
    ViewData["Title"] = "Onaylanmış Avanslar";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

}
@Html.AntiForgeryToken()
<div class="row">
    <div class="col-md-6 col-xl-3">
        <div class="card stat-widget">
            <div class="card-body">
                <h5 class="card-title">Beklemede Avans Talepleri</h5>
                <h2 id="pendingAdvancesCount">0</h2>
                <div class="progress">
                    <div class="progress-bar bg-secondary progress-bar-striped" role="progressbar"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card stat-widget">
            <div class="card-body">
                <h5 class="card-title">Onayda Bekleyen Avans Talepleri</h5>
                <h2 id="approvedAdvancesCount">0</h2>
                <div class="progress">
                    <div class="progress-bar bg-info progress-bar-striped" role="progressbar" ></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card stat-widget">
            <div class="card-body">
                <h5 class="card-title">Reddedilmiş Avans Talepleri</h5>
                <h2 id="rejectedAdvancesCount">0</h2>
                <div class="progress">
                    <div class="progress-bar bg-danger progress-bar-striped" role="progressbar" ></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card stat-widget">
            <div class="card-body">
                <h5 class="card-title">Tamamlanmış Avans Talepleri</h5>
                <h2 id="completedAdvancesCount">0</h2>
                <div class="progress">
                    <div class="progress-bar bg-success progress-bar-striped" role="progressbar" ></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-hand-holding-dollar me-2"></i>
                    Onaylanmış Avanslar
                </h5>

                <div class="table-responsive">
                    <table id="approvedAdvancesTable" class="table table-striped table-hover display"
                           style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>TALEP<br /> NEDENİ</th>
                                <th>TUTAR</th>
                                <th>DURUM</th>
                                <th>AÇIKLAMA</th>

                                <th>OLUŞTURMA<br />TARİHİ</th>
                                <th>OLUŞTURAN<br />KULLANICI</th>
                                <th>İŞLEM<br />YAPAN<br />ÜST</th>
                                <th>ÜST<br />İŞLEM<br />TARİHİ</th>
                                <th>İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- DataTables will populate this -->
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-file-circle-check me-2"></i>
                    Tamamlanmış Avanslar
                </h5>

                <div class="table-responsive">
                    <table id="completedAdvancesTable" class="table table-striped table-hover display"
                           style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>TALEP<br /> NEDENİ</th>
                                <th>TUTAR</th>
                                <th>DURUM</th>
                                <th>AÇIKLAMA</th>

                                <th>OLUŞTURMA<br />TARİHİ</th>
                                <th>OLUŞTURAN<br />KULLANICI</th>
                                <th>İŞLEM<br />YAPAN<br />FİNANS</th>
                                <th>FİNANS<br />İŞLEM<br />TARİHİ</th>
                                <th>İŞLEMLER</th>

                            </tr>
                        </thead>
                        <tbody>
                            <!-- DataTables will populate this -->
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>
<!-- View Parts Modal -->
<div class="modal fade" id="viewPartsModal" tabindex="-1" aria-labelledby="viewPartsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list me-2"></i>Avans Parçaları
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Onay Tarihi</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="viewPartsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Avans Talebi Reddetme Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtRejectAdvanceRequestId" value="" disabled readonly />
                <div class="mb-3">
                    <label for="txtRejectReason" class="form-label">Reddetme Sebebi (İsteğe Bağlı)</label>
                    <textarea class="form-control" id="txtRejectReason" rows="3"
                              placeholder="Avans talebini reddetme sebebinizi açıklayın..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger w-100" id="btnRejectAdvanceRequest">
                    <i class="fas fa-times me-1"></i>Reddet
                </button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        let approvedAdvancesTable;
        let completedAdvancesTable;
        const advancePartsMap = {};

        $(document).ready(async function () {
            setupEventListeners();
            await loadStatistics();
            await initializeDataTables();
        });
        async function initializeDataTables() {
               completedAdvancesTable = $('#completedAdvancesTable').DataTable({
                "processing": true,
                "ajax": {
                    "url": "/avans/tamamlanmis-liste",
                    "type": "GET",
                    "dataSrc": function (json) {
                        if (json) {

                            return json;
                        }
                        return [];
                    },
                    "error": function (xhr, error, code) {
                        console.error('DataTables AJAX error:', error);
                        let errorMessage = 'Veriler yüklenirken hata oluştu';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ': ' + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ': ' + xhr.responseText;
                            }
                        } catch (e) {
                            errorMessage += ': ' + error;
                        }
                        showToast(errorMessage, 'error', 'Hata');
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "width": "5%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            return '';
                        }
                    },
                    {
                        "data": "reason",
                        "render": function (data) {
                            return data || '';
                        }
                    },
                    {
                        "data": "amount",
                        "render": function (data) {
                            if (!data && data !== 0) return '';

                            return new Intl.NumberFormat('tr-TR', {
                                style: 'currency',
                                currency: 'TRY'
                            }).format(data);
                        }
                    },
                    {
                        "data": "statusText",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.status === 0) {
                                return `<span class="badge bg-warning">${data}</span>`;
                            } else if (row.status === 1) {
                                return `<span class="badge bg-success">${data}</span>`;
                            } else if (row.status === 2) {
                                return `<span class="badge bg-primary">${data}</span>`;
                            } else if (row.status === 3 || row.status === 4 || row.status === 5) {
                                return `<span class="badge bg-danger">${data}</span>`;
                            }   else if (row.status === 6) {
                                return `<span class="badge bg-success">${data}</span>`;
                            }else {
                                return `<span class="badge bg-secondary">${data}</span>`;
                            }
                        }
                    },
                    {
                        "data": "description",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            return data ? data : "";
                        }
                    },
                    {
                        "data": "createdDate",
                        "render": function (data) {
                            return data ? new Date(data).toLocaleString('tr-TR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                        }
                    },
                    {
                        "data": "createdByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            return data ? data : "";
                        }
                    },
                    {
                        "data": "completedByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {

                             if (data) {
                                return data
                            }
                            else {
                                return "";
                            }

                        }
                    },
                    {
                        "data": "completedDate",
                        "render": function (data, type, row) {

                             if (data) {
                                return new Date(data).toLocaleString('tr-TR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            }
                            else {
                                return "";
                            }

                        }
                    },
                   {
                        "data": null,
                        "width": "10%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {
                            var buttons = '<div class="btn-group btn-group-sm" role="group">';
                                buttons += `
                                                                               <button type="button" class="btn btn-outline-info btn-sm"
                                                                                    onclick="viewAdvanceParts('completedAdvancesTable','${row.id}')" title="Parçaları Görüntüle">
                                                                                    <i class="fas fa-list"></i>
                                                                                </button>`;

                            buttons += '</div>';
                            return buttons;

                        }
                    }
                ],
                "language": {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json'
                },
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "pageLength": 10,
                "responsive": true,
                "searchDelay": 300,
                "order": [[8, "desc"]], // Order by created date desc
                "drawCallback": function () {
                    var api = this.api();
                    var pageInfo = api.page.info();

                    api.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });
                    $('[title]').tooltip();
                }
            });

            approvedAdvancesTable = $('#approvedAdvancesTable').DataTable({
                "processing": true,
                "ajax": {
                    "url": "/avans/onaylanmis-liste",
                    "type": "GET",
                 "dataSrc": function (rows) {
                     if (rows) {
                         rows.forEach(row => { advancePartsMap[row.id] = row.parts; });

                         return rows;
                     }

                     return [];
                    },
                    "error": function (xhr, error, code) {
                        console.error('DataTables AJAX error:', error);
                        let errorMessage = 'Veriler yüklenirken hata oluştu';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ': ' + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ': ' + xhr.responseText;
                            }
                        } catch (e) {
                            errorMessage += ': ' + error;
                        }
                        showToast(errorMessage, 'error', 'Hata');
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "width": "5%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            return '';
                        }
                    },
                    {
                        "data": "reason",
                        "render": function (data) {
                            return data || '';
                        }
                    },
                    {
                        "data": "amount",
                        "render": function (data) {
                            if (!data && data !== 0) return '';

                            return new Intl.NumberFormat('tr-TR', {
                                style: 'currency',
                                currency: 'TRY'
                            }).format(data);
                        }
                    },
                    {
                        "data": "statusText",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.status === 0) {
                                return `<span class="badge bg-warning">${data}</span>`;
                            } else if (row.status === 1) {
                                return `<span class="badge bg-success">${data}</span>`;
                            } else if (row.status === 2) {
                                return `<span class="badge bg-primary">${data}</span>`;
                            } else if (row.status === 3 || row.status === 4 || row.status === 5) {
                                return `<span class="badge bg-danger">${data}</span>`;
                            }
                            else if (row.status === 6) {
                                return `<span class="badge bg-success">${data}</span>`;
                            } else {
                                return `<span class="badge bg-secondary">${data}</span>`;
                            }
                        }
                    },
                    {
                        "data": "description",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            return data ? data : "";
                        }
                    },
                    {
                        "data": "createdDate",
                        "render": function (data) {
                            return data ? new Date(data).toLocaleString('tr-TR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                        }
                    },
                    {
                        "data": "createdByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            return data ? data : "";
                        }
                    },
                    {
                        "data": "chiefByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.unitManagerFullName) {
                                return row.unitManagerFullName;
                            }
                            else if (data) {
                                return data
                            }
                            else {
                                return "";
                            }

                        }
                    },
                    {
                        "data": "chiefProcessedDate",
                        "render": function (data, type, row) {
                            if (row.unitManagerProcessedDate) {
                                return new Date(row.unitManagerProcessedDate).toLocaleString('tr-TR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            }
                            else if (data) {
                                return new Date(data).toLocaleString('tr-TR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            }
                            else {
                                return "";
                            }

                        }
                    },
                    {
                        "data": null,
                        "width": "10%",
                        "orderable": false,
                        "className": "text-center",
                       "render": function (data, type, row) {
                             var buttons = '<div class="btn-group btn-group-sm" role="group">';

                                buttons += `
                                                                        <button type="button" class="btn btn-outline-info btn-sm"
                                                                                    onclick="viewAdvanceParts('approvedAdvancesTable','${row.id}')" title="Parçaları Görüntüle">
                                                                                    <i class="fas fa-list"></i>
                                                                                </button>
                                                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                                            onclick="deleteAdvanceRequest('${row.id}')" title="Sil">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                          <button type="button" class="btn btn-outline-success btn-sm"
                                                                                     onclick="completeAdvanceRequest('${row.id}')"
                                                                     title="Tamamla">
                                                                            <i class="fas fa-check"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                                            onclick="openRejectModal('${row.id}')" title="Reddet">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>`;

                            buttons += '</div>';
                            return buttons;
                        }
                    }
                ],
                "language": {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json'
                },
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "pageLength": 10,
                "responsive": true,
                "searchDelay": 300,
                "order": [[8, "desc"]], // Order by created date desc
                "drawCallback": function () {
                    var api = this.api();
                    var pageInfo = api.page.info();

                    api.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });
                    $('[title]').tooltip();
                }
            });
        }
        function setupEventListeners() {

            $(document).on('click', '#btnRejectAdvanceRequest', async function () {
                await rejectAdvanceRequest();
            });

            $('#viewPartsModal').on('hidden.bs.modal', function () {
                $('#viewPartsTableBody').empty();
                $('#viewPartsModal .modal-title').html('<i class="fas fa-list me-2"></i>Avans Parçaları');
            });
        }

        async function deleteAdvanceRequest(advanceRequestId) {
            try {
                const result = await Swal.fire({
                    title: 'Avans Talebini Sil',
                    text: 'Bu avans talebini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-trash"></i> Evet, Sil',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await makeRequest(`/avans/${advanceRequestId}`, 'DELETE');
                            return response;
                        } catch (error) {
                            let errorMessage = 'Silme başarısız';
                            if (error.detail) {
                                errorMessage = error.detail;
                            } else if (error.title) {
                                errorMessage = error.title;
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;

                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Avans talebi başarıyla silindi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    approvedAdvancesTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Silme hatası:', error);
            }
        }
             function viewAdvanceParts(tableId, advanceId) {
            // Get the DataTable instance from the table name/selector
            const tbl = $("#"+tableId).DataTable();

            console.log(tbl);

            const row = tbl.rows().data().toArray().find(r => r.id === advanceId);

            if (!row || !row.parts || row.parts.length === 0) {
                showToast('Parça bilgisi bulunamadı', 'warning', 'Uyarı');
                return;
            }

            const formattedTotalAmount = new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(row.amount);

            // Fixed: Use template literal correctly with backticks
            $('#viewPartsModal .modal-title').html(`<i class="fas fa-list me-2"></i>Avans Parçaları - ${formattedTotalAmount}`);

            const tbody = $('#viewPartsTableBody');
            tbody.empty();

            let totalAmount = 0;

            row.parts.forEach((part, index) => {
                const date = new Date(part.year, part.month - 1, part.day);
                const formattedDate = date.toLocaleDateString('tr-TR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const formattedAmount = new Intl.NumberFormat('tr-TR', {
                    style: 'currency',
                    currency: 'TRY'
                }).format(part.amount);

                totalAmount += parseFloat(part.amount);

                tbody.append(`
                    <tr>
                        <td>${index + 1}</td>
                        <td>${formattedDate}</td>
                        <td class="text-end">${formattedAmount}</td>
                    </tr>
                `);
            });

            const totalFormatted = new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(totalAmount);

            tbody.append(`
                <tr class="table-info fw-bold">
                    <td colspan="2" class="text-end">TOPLAM:</td>
                    <td class="text-end">${totalFormatted}</td>
                </tr>
            `);

            $('#viewPartsModal').modal('show');
        }
        async function completeAdvanceRequest(advanceId ,parts) {
            try {
                    const parts = advancePartsMap[advanceId];
                          if (!parts || parts.length === 0) {
            showToast('Parça bilgisi bulunamadı', 'warning', 'Uyarı');
            return;
        }
                const result = await Swal.fire({
                    title: 'Avans Talebini Tamamla',
                    text: 'Bu avans talebini tamamlamak istediğinizden emin misiniz?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-check"></i> Evet, Tamamla',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await makeRequest(`/avans/${advanceId}/tamamla`, 'PUT', { parts: parts });
                            return response;
                        } catch (error) {
                            let errorMessage = 'Tamamlama başarısız';
                            if (error.detail) {
                                errorMessage = error.detail;
                            } else if (error.title) {
                                errorMessage = error.title;
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;
                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Avans talebi başarıyla tamamlandı.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    approvedAdvancesTable.ajax.reload(null, false);
                    completedAdvancesTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Tamamlama hatası:', error);
            }
        }
        function openRejectModal(id) {
            $('#txtRejectAdvanceRequestId').val(id);
            $('#txtRejectReason').val('');
            $('#rejectModal').modal('show');
        }
        async function rejectAdvanceRequest() {
            try {
                const advanceRequestId = $('#txtRejectAdvanceRequestId').val();

                if (!advanceRequestId) {
                    showToast('Avans talebi ID\'si bulunamadı', 'error', 'Hata');
                    return;
                }

                const rejectReason = $('#txtRejectReason').val().trim();

                const submitBtn = $('#btnRejectAdvanceRequest');
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Reddediliyor...');

                const url = `/avans/${advanceRequestId}/reddet${rejectReason ? `?rejectReason=${encodeURIComponent(rejectReason)}` : ''}`;
                await makeRequest(url, 'PUT');

                showToast('Avans talebi başarıyla reddedildi.', 'success', 'Başarılı');
                $('#rejectModal').modal('hide');
                approvedAdvancesTable.ajax.reload(null, false);

            } catch (error) {
                console.error('Reddetme hatası:', error);
                handleError(error, 'Avans talebi reddedilirken hata oluştu');
            } finally {
                const submitBtn = $('#btnRejectAdvanceRequest');
                submitBtn.prop('disabled', false).html('<i class="fas fa-times me-1"></i>Reddet');
            }
        }
                      // Sayfa yüklendiğinde istatistikleri çek
        async function loadStatistics() {
            try {
                const response = await makeRequest('/avans/istatistik', 'GET');
                if (response) {
                    const stats = response;
                    
                    // Sayıları güncelle
                    $('#pendingAdvancesCount').text(stats.pendingCount);
                    $('#approvedAdvancesCount').text(stats.approvedCount);
                    $('#rejectedAdvancesCount').text(stats.rejectedCount);
                    $('#completedAdvancesCount').text(stats.completedCount);

                    // Progress bar'ları güncelle
                    $('.card-body').eq(0).find('.progress-bar')
                        .css('width', stats.pendingPercentage + '%')
                        .attr('aria-valuenow', stats.pendingPercentage);

                    $('.card-body').eq(1).find('.progress-bar')
                        .css('width', stats.approvedPercentage + '%')
                        .attr('aria-valuenow', stats.approvedPercentage);

                    $('.card-body').eq(2).find('.progress-bar')
                        .css('width', stats.rejectedPercentage + '%')
                        .attr('aria-valuenow', stats.rejectedPercentage);

                    $('.card-body').eq(3).find('.progress-bar')
                        .css('width', stats.completedPercentage + '%')
                        .attr('aria-valuenow', stats.completedPercentage);
                }
            } catch (error) {
                console.error('İstatistikler yüklenirken hata:', error);
                handleError(error, 'İstatistikler yüklenirken hata oluştu');
            }
        }

    </script>

}