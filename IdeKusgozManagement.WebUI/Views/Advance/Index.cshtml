@{
    ViewData["Title"] = "Avans Yönetimi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>

    </style>
}
@Html.AntiForgeryToken()
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-money-bill me-2"></i>
                    Avans Talepleri Yönetimi
                </h5>

                <div class="table-responsive">
                    <table id="advancesTable" class="table table-striped table-hover display" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>TALEP<br /> NEDENİ</th>
                                <th>TUTAR</th>
                                <th>DURUM</th>
                                <th>AÇIKLAMA</th>

                                <th>OLUŞTURMA<br />TARİHİ</th>
                                <th>OLUŞTURAN<br />KULLANICI</th>
                                <th>İŞLEM<br />YAPAN<br />ÜST</th>
                                <th>ÜST<br />İŞLEM<br />TARİHİ</th>
                                <th>İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- DataTables will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="updateAdvanceRequestModal" tabindex="-1" aria-labelledby="updateAdvanceRequestModalLabel"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Avans Talebi Güncelleme Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form class="needs-validation" novalidate id="updateAdvanceRequestForm">
                <div class="modal-body">
                    <input type="hidden" id="txtUId">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="selectUAdvanceReason" class="form-label">Talep Nedeni</label>
                            <select class="form-select selectAdvanceReason" id="selectUAdvanceReason" required>
                                <option value="" selected disabled>Talep nedeni seçiniz...</option>
                                <option>İş Avansı</option>
                                <option>Maaş Avansı</option>
                            </select>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli talep nedeni seçiniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="txtUAmount" class="form-label">Tutar</label>
                            <input type="number" class="form-control" id="txtUAmount" required step="0.1">
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir tutar giriniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="txtUDescription" class="form-label">Açıklama (İsteğe Bağlı)</label>
                            <textarea class="form-control" id="txtUDescription" rows="3"
                                      placeholder="Açıklama..."></textarea>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-pen me-1"></i>Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Approve Modal -->
<div class="modal fade" id="approveAdvanceModal" tabindex="-1" aria-labelledby="approveAdvanceModalLabel"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Avans Talebi Onaylama Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="approveAdvanceForm" class="needs-validation" novalidate>
                <div class="modal-body">
                    <input type="hidden" id="txtApproveAdvanceRequestId" />
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="alert alert-info mb-0">
                                <strong>Toplam Tutar:</strong>
                                <span id="approveTotalAmount" class="fs-5">₺0</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning mb-0" id="approveRemainingAmountContainer">
                                <strong>Kalan Tutar:</strong>
                                <span id="approveRemainingAmount" class="fs-5">₺0</span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div id="approvePartsContainer">
                        <!-- Parçalar buraya dinamik olarak eklenecek -->
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-primary" id="btnAddApprovePart">
                            <i class="fas fa-plus me-2"></i>Avansı Böl
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-success w-100" id="btnSubmitApprove">
                        <i class="fas fa-check me-1"></i>Onayla
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- View Parts Modal -->
<div class="modal fade" id="viewPartsModal" tabindex="-1" aria-labelledby="viewPartsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list me-2"></i>Avans Parçaları
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Onay Tarihi</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="viewPartsTableBody">
                            <!-- Parçalar buraya eklenecek -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Avans Talebi Reddetme Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtRejectAdvanceRequestId" value="" disabled readonly />
                <div class="mb-3">
                    <label for="txtRejectReason" class="form-label">Reddetme Sebebi (İsteğe Bağlı)</label>
                    <textarea class="form-control" id="txtRejectReason" rows="3"
                              placeholder="Avans talebini reddetme sebebinizi açıklayın..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger w-100" id="btnRejectAdvanceRequest">
                    <i class="fas fa-times me-1"></i>Reddet
                </button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        let advancesTable;

        $(document).ready(async function () {
            setupEventListeners();
            await initializeDataTable();
        });
        async function initializeDataTable() {
            advancesTable = $('#advancesTable').DataTable({
                "processing": true,
                "ajax": {
                    "url": "/avans/liste",
                    "type": "GET",
                    "dataSrc": function (json) {
                        if (json) {
                            return json;
                        }
                        return [];
                    },
                    "error": function (xhr, error, code) {
                        console.error('DataTables AJAX error:', error);
                        let errorMessage = 'Veriler yüklenirken hata oluştu';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ': ' + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ': ' + xhr.responseText;
                            }
                        } catch (e) {
                            errorMessage += ': ' + error;
                        }
                        showToast(errorMessage, 'error', 'Hata');
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "width": "5%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            return '';
                        }
                    },
                    {
                        "data": "reason",
                        "render": function (data) {
                            return data || '';
                        }
                    },
                    {
                        "data": "amount",
                        "render": function (data) {
                            if (!data && data !== 0) return '';

                            return new Intl.NumberFormat('tr-TR', {
                                style: 'currency',
                                currency: 'TRY'
                            }).format(data);
                        }
                    },
                    {
                        "data": "statusText",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.status === 0) {
                                return `<span class="badge bg-warning">${data}</span>`;
                            } else if (row.status === 1) {
                                return `<span class="badge bg-success">${data}</span>`;
                            } else if (row.status === 2) {
                                return `<span class="badge bg-primary">${data}</span>`;
                            } else if (row.status === 3 || row.status === 4 || row.status=== 5) {
                                return `<span class="badge bg-danger">${data}</span>`;
                            } else if (row.status === 6) {
                                return `<span class="badge bg-success">${data}</span>`;
                            } else {
                                return `<span class="badge bg-secondary">${data}</span>`;
                            }
                        }
                    },
                    {
                        "data": "description",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            return data ? data : "";
                        }
                    },
                    {
                        "data": "createdDate",
                        "render": function (data) {
                            return data ? new Date(data).toLocaleString('tr-TR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                        }
                    },
                    {
                        "data": "createdByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            return data ? data : "";
                        }
                    },
                    {
                        "data": "chiefByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.unitManagerFullName) {
                                return row.unitManagerFullName;
                            }
                            else if (data) {
                                return data
                            }
                            else {
                                return "";
                            }

                        }
                    },
                    {
                        "data": "chiefProcessedDate",
                        "render": function (data, type, row) {
                            if (row.unitManagerProcessedDate) {
                                return new Date(row.unitManagerProcessedDate).toLocaleString('tr-TR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            }
                            else if (data) {
                                return new Date(data).toLocaleString('tr-TR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            }
                            else {
                                return "";
                            }

                        }
                    },
                    {
                        "data": null,
                        "width": "10%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {
                            var buttons = '<div class="btn-group btn-group-sm" role="group">';
                            const amount = parseFloat(row.amount) || 0;
                            const isOverThreshold = amount > approvalThreshold;

                            if (row.status === 1 || row.status === 2 || row.status===6) {
                                // Eğer parçalar varsa görüntüle butonu göster
                                if (row.hasParts && row.parts && row.parts.length > 0) {
                                    buttons += `
                                                                <button type="button" class="btn btn-outline-info btn-sm"
                                                                    onclick="viewAdvanceParts('${row.id}')"
                                                                    data-advance-id="${row.id}"
                                                                    title="Parçaları Görüntüle">
                                                                    <i class="fas fa-list"></i>
                                                                </button>`;
                                }
                                buttons += '</div>';
                                return buttons;
                            }

                            // Yönetici rolü kontrolü - Can only approve/reject advances over ₺5000
                            if (window.isUserUnitManager || window.isAdmin) {
                                if (!isOverThreshold && row.status !== 2) {

                                    buttons += `
                                                                                                            <button type="button" class="btn btn-outline-warning btn-sm"
                                                                                                                onclick="loadAdvanceForEdit('${row.id}')" title="Düzenle">
                                                                                                                <i class="fas fa-edit"></i>
                                                                                                            </button>
                                                                                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                                                                                onclick="deleteAdvanceRequest('${row.id}')" title="Sil">
                                                                                                                <i class="fas fa-trash"></i>
                                                                                                            </button>
                                                                                                              <button type="button" class="btn btn-outline-success btn-sm"
                                                                                                                onclick="approveAdvanceRequest('${row.id}')" title="Onayla">
                                                                                                                <i class="fas fa-check"></i>
                                                                                                            </button>
                                                                                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                                                                                onclick="openRejectModal('${row.id}')" title="Reddet">
                                                                                                                <i class="fas fa-times"></i>
                                                                                                            </button>`;
                                }
                            }
                            // Şef rolü kontrolü - Can only approve/reject advances up to ₺5000
                            else if (window.isUserSef) {
                                // Only show approve/reject buttons if amount <= ₺5000
                                if (!isOverThreshold) {
                                    buttons += `
                                                                                                               <button type="button" class="btn btn-outline-warning btn-sm"
                                                                                                                onclick="loadAdvanceForEdit('${row.id}')" title="Düzenle">
                                                                                                                <i class="fas fa-edit"></i>
                                                                                                            </button>
                                                                                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                                                                                onclick="deleteAdvanceRequest('${row.id}')" title="Sil">
                                                                                                                <i class="fas fa-trash"></i>
                                                                                                            </button>
                                                                                                            <button type="button" class="btn btn-outline-success btn-sm"
                                                                                                                onclick="approveAdvanceRequest('${row.id}')" title="Onayla">
                                                                                                                <i class="fas fa-check"></i>
                                                                                                            </button>
                                                                                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                                                                                onclick="openRejectModal('${row.id}')" title="Reddet">
                                                                                                                <i class="fas fa-times"></i>
                                                                                                            </button>`;
                                }
                            }

                            buttons += '</div>';
                            return buttons;
                        }
                    }
                ],
                "language": {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json'
                },
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "pageLength": 10,
                "responsive": true,
                "searchDelay": 300,
                "order": [[5, "desc"]], // Order by created date desc
                "drawCallback": function () {
                    var api = this.api();
                    var pageInfo = api.page.info();

                    api.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });
                    $('[title]').tooltip();
                }
            });
        }
        function setupEventListeners() {
            // Create expense form
            $('#createAdvanceRequestForm').on('submit', function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    createAdvanceRequest();
                }
                $(this).addClass('was-validated');
            });

            // Update expense form
            $('#updateAdvanceRequestForm').on('submit', function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    updateAdvanceRequest();
                }
                $(this).addClass('was-validated');
            });

            // Approve advance form
            $('#approveAdvanceForm').on('submit', function (e) {
                e.preventDefault();
                submitApproveAdvance();
            });

            $(document).on('click', '#btnRejectAdvanceRequest', async function () {
                await rejectAdvanceRequest();
            });

            $(document).on('click', '#btnAddApprovePart', function () {
                addApprovePart();
            });

            // Tutar input değişikliklerini dinle
            $(document).on('input', '.approve-part-amount', function () {
                const partId = $(this).closest('.approve-part-item').data('part-id');
                updatePartAmount(partId, parseFloat($(this).val()) || 0);
                updateRemainingAmount();
            });

            // Clear forms when modals hide
            $('#createAdvanceRequestModal').on('hidden.bs.modal', function () {
                $('#createAdvanceRequestForm')[0].reset();
                $('#createAdvanceRequestForm').removeClass('was-validated');
            });

            $('#updateAdvanceRequestModal').on('hidden.bs.modal', function () {
                $('#updateAdvanceRequestForm')[0].reset();
                $('#updateAdvanceRequestForm').removeClass('was-validated');
            });

            $('#approveAdvanceModal').on('hidden.bs.modal', function () {
                approveParts = [];
                approveTotalAmount = 0;
                $('#approvePartsContainer').empty();
                $('#approveAdvanceForm').removeClass('was-validated');
            });

            $('#viewPartsModal').on('hidden.bs.modal', function () {
                $('#viewPartsTableBody').empty();
                $('#viewPartsModal .modal-title').html('<i class="fas fa-list me-2"></i>Avans Parçaları');
            });
        }
        async function createAdvanceRequest() {
            const advanceData = {
                amount: $('#txtCAmount').val(),
                description: $('#txtCDescription').val().trim() ?? null,
                reason: $('#selectCAdvanceReason').val()
            };

            try {
                const response = await makeRequest('/avans/istek-olustur', 'POST', advanceData);

                showToast('Avans talebi başarıyla oluşturuldu.', 'success', 'Başarılı!');
                $('#createAdvanceRequestModal').modal('hide');
                advancesTable.ajax.reload();
            } catch (error) {
                console.error('Create advance error:', error);
                handleError(error, 'Avans talebi oluşturulurken hata oluştu.');
            }
        }

        async function loadAdvanceForEdit(advanceId) {
            try {
                const response = await makeRequest(`/avans/${advanceId}`, 'GET');

                $('#txtUId').val(response.id);
                $('#txtUAmount').val(response.amount);
                $('#txtUDescription').val(response.description);
                $('#selectUAdvanceReason').val(response.reason);
                $('#updateAdvanceRequestModal').modal('show');
            } catch (error) {
                console.error('Load advance error:', error);
                handleError(error, 'Avans bilgisi yüklenirken hata oluştu.');
            }
        }

        async function updateAdvanceRequest() {
            const expenseId = $('#txtUId').val();
            const advanceData = {
                amount: $('#txtUAmount').val(),
                description: $('#txtUDescription').val().trim() ?? null,
                reason: $('#selectUAdvanceReason').val()
            };

            try {
                const response = await makeRequest(`/avans/${expenseId}`, 'PUT', advanceData);

                showToast('Avans talebi başarıyla güncellendi.', 'success', 'Başarılı!');
                $('#updateAdvanceRequestModal').modal('hide');
                advancesTable.ajax.reload();
            } catch (error) {
                console.error('Update advance error:', error);
                handleError(error, 'Avans talebi güncellenirken hata oluştu.');
            }
        }
        async function deleteAdvanceRequest(advanceRequestId) {
            try {
                const result = await Swal.fire({
                    title: 'Avans Talebini Sil',
                    text: 'Bu avans talebini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-trash"></i> Evet, Sil',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await makeRequest(`/avans/${advanceRequestId}`, 'DELETE');
                            return response;
                        } catch (error) {
                            let errorMessage = 'Silme başarısız';
                            if (error.detail) {
                                errorMessage = error.detail;
                            } else if (error.title) {
                                errorMessage = error.title;
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;

                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Avans talebi başarıyla silindi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    advancesTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Silme hatası:', error);
            }
        }
        let approveParts = [];
        let approveTotalAmount = 0;

        async function approveAdvanceRequest(advanceId) {
            try {
                // Avans bilgisini al
                const response = await makeRequest(`/avans/${advanceId}`, 'GET');

                approveTotalAmount = parseFloat(response.amount) || 0;
                approveParts = [];
                openApproveModal(advanceId, approveTotalAmount);
            } catch (error) {
                console.error('Avans bilgisi alınırken hata:', error);
                handleError(error, 'Avans bilgisi alınırken hata oluştu');
            }
        }

        function openApproveModal(advanceId, totalAmount) {
            $('#txtApproveAdvanceRequestId').val(advanceId);
            $('#approveTotalAmount').text(new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(totalAmount));

            // İlk parçayı ekle (default: bugünün tarihi ve toplam tutar)
            approveParts = [];
            const today = new Date();
            const defaultDate = {
                day: today.getDate(),
                month: today.getMonth() + 1,
                year: today.getFullYear()
            };

            addApprovePart(defaultDate, totalAmount);
            $('#approveAdvanceModal').modal('show');
        }

        function addApprovePart(date = null, amount = 0) {
            const today = date || new Date();
            const partDate = date ? date : {
                day: today.getDate(),
                month: today.getMonth() + 1,
                year: today.getFullYear()
            };

            const partId = 'part_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const part = {
                id: partId,
                day: partDate.day || today.getDate(),
                month: partDate.month || (today.getMonth() + 1),
                year: partDate.year || today.getFullYear(),
                amount: amount || 0
            };

            approveParts.push(part);

            // Günler listesi - seçili ay ve yıla göre
            const daysInMonth = new Date(part.year, part.month, 0).getDate();
            // Eğer seçili gün ayın gün sayısından fazlaysa, son günü seç
            if (part.day > daysInMonth) {
                part.day = daysInMonth;
            }
            const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            // Aylar listesi
            const months = [
                { value: 1, text: 'Ocak' },
                { value: 2, text: 'Şubat' },
                { value: 3, text: 'Mart' },
                { value: 4, text: 'Nisan' },
                { value: 5, text: 'Mayıs' },
                { value: 6, text: 'Haziran' },
                { value: 7, text: 'Temmuz' },
                { value: 8, text: 'Ağustos' },
                { value: 9, text: 'Eylül' },
                { value: 10, text: 'Ekim' },
                { value: 11, text: 'Kasım' },
                { value: 12, text: 'Aralık' }
            ];
            // Yıllar listesi (sadece mevcut yıl ve ilerisi - 10 yıl ileri)
            const currentYear = new Date().getFullYear();
            const years = Array.from({ length: 11 }, (_, i) => currentYear + i);

            // Bu parça için maksimum tutarı hesapla (diğer parçaların toplamını çıkar)
            const otherPartsTotal = approveParts
                .filter(p => p.id !== partId)
                .reduce((sum, p) => {
                    const pAmount = parseFloat($(`.approve-part-item[data-part-id="${p.id}"] .approve-part-amount`).val()) || 0;
                    return sum + pAmount;
                }, 0);
            const maxAmountForThisPart = approveTotalAmount - otherPartsTotal;

            const partHtml = `
                                                                                            <div class="card mb-3 approve-part-item" data-part-id="${partId}">
                                                                                                <div class="card-body">
                                                                                                    <div class="row g-3 align-items-end">
                                                                                                        <div class="col-md-2">
                                                                                                            <label class="form-label">Gün</label>
                                                                                                            <select class="form-select approve-part-day" required>
                                                                                                                ${days.map(d => `<option value="${d}" ${d === part.day ? 'selected' : ''}>${d}</option>`).join('')}
                                                                                                            </select>
                                                                                                        </div>
                                                                                                        <div class="col-md-3">
                                                                                                            <label class="form-label">Ay</label>
                                                                                                            <select class="form-select approve-part-month" required>
                                                                                                                ${months.map(m => `<option value="${m.value}" ${m.value === part.month ? 'selected' : ''}>${m.text}</option>`).join('')}
                                                                                                            </select>
                                                                                                        </div>
                                                                                                        <div class="col-md-2">
                                                                                                            <label class="form-label">Yıl</label>
                                                                                                            <select class="form-select approve-part-year" required>
                                                                                                                ${years.map(y => `<option value="${y}" ${y === part.year ? 'selected' : ''}>${y}</option>`).join('')}
                                                                                                            </select>
                                                                                                        </div>
                                                                                                        <div class="col-md-3">
                                                                                                            <label class="form-label">Tutar</label>
                                                                                                            <input type="number" class="form-control approve-part-amount"
                                                                                                                   step="0.01" min="0.01" max="${maxAmountForThisPart > 0 ? maxAmountForThisPart : approveTotalAmount}" value="${amount}" required>
                                                                                                        </div>
                                                                                                        <div class="col-md-2">
                                                                                                            <button type="button" class="btn btn-outline-danger btn-sm w-100"
                                                                                                                    onclick="removeApprovePart('${partId}')" title="Sil">
                                                                                                                <i class="fas fa-trash"></i>
                                                                                                            </button>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        `;

            $('#approvePartsContainer').append(partHtml);
            updateRemainingAmount();

            // Event listener'ları ekle
            $(`.approve-part-item[data-part-id="${partId}"] .approve-part-amount`).on('input', function () {
                updatePartAmount(partId, parseFloat($(this).val()) || 0);
                updateRemainingAmount();
            });

            // Ay değiştiğinde günleri güncelle
            $(`.approve-part-item[data-part-id="${partId}"] .approve-part-month`).on('change', function () {
                const month = parseInt($(this).val());
                const year = parseInt($(`.approve-part-item[data-part-id="${partId}"] .approve-part-year`).val());
                const part = approveParts.find(p => p.id === partId);
                if (part) {
                    part.month = month;
                }
                updateDaysForMonth(partId, month, year);
            });

            // Yıl değiştiğinde günleri güncelle
            $(`.approve-part-item[data-part-id="${partId}"] .approve-part-year`).on('change', function () {
                const year = parseInt($(this).val());
                const month = parseInt($(`.approve-part-item[data-part-id="${partId}"] .approve-part-month`).val());
                const part = approveParts.find(p => p.id === partId);
                if (part) {
                    part.year = year;
                }
                updateDaysForMonth(partId, month, year);
            });
        }

        window.removeApprovePart = function (partId) {
            if (approveParts.length <= 1) {
                showToast('En az bir parça olmalıdır.', 'warning', 'Uyarı');
                return;
            }

            approveParts = approveParts.filter(p => p.id !== partId);
            $(`.approve-part-item[data-part-id="${partId}"]`).remove();
            updateRemainingAmount();
        }

        function updateDaysForMonth(partId, month, year) {
            const daySelect = $(`.approve-part-item[data-part-id="${partId}"] .approve-part-day`);
            const currentDay = parseInt(daySelect.val());

            // Ayın gün sayısını hesapla
            const daysInMonth = new Date(year, month, 0).getDate();

            // Mevcut seçenekleri temizle
            daySelect.empty();

            // Yeni seçenekleri ekle
            for (let i = 1; i <= daysInMonth; i++) {
                daySelect.append(`<option value="${i}" ${i === currentDay ? 'selected' : ''}>${i}</option>`);
            }

            // Eğer seçili gün ayın gün sayısından fazlaysa, son günü seç
            if (currentDay > daysInMonth) {
                daySelect.val(daysInMonth);
                const part = approveParts.find(p => p.id === partId);
                if (part) {
                    part.day = daysInMonth;
                }
            }
        }

        function updatePartAmount(partId, amount) {
            const part = approveParts.find(p => p.id === partId);
            if (part) {
                part.amount = amount;
            }
        }

        function updateRemainingAmount() {
            // Tüm parçaların tutarlarını güncelle
            approveParts.forEach(part => {
                const amountInput = $(`.approve-part-item[data-part-id="${part.id}"] .approve-part-amount`);
                if (amountInput.length) {
                    part.amount = parseFloat(amountInput.val()) || 0;
                }
            });

            const totalPartsAmount = approveParts.reduce((sum, part) => sum + (parseFloat(part.amount) || 0), 0);
            const remaining = approveTotalAmount - totalPartsAmount;

            $('#approveRemainingAmount').text(new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(remaining));

            // Kalan tutar negatifse uyarı göster
            if (remaining < 0) {
                $('#approveRemainingAmountContainer').removeClass('alert-warning').addClass('alert-danger');
                $('#approveRemainingAmount').text(new Intl.NumberFormat('tr-TR', {
                    style: 'currency',
                    currency: 'TRY'
                }).format(remaining));
            } else if (remaining === 0) {
                $('#approveRemainingAmountContainer').removeClass('alert-warning alert-danger').addClass('alert-success');
            } else {
                $('#approveRemainingAmountContainer').removeClass('alert-danger alert-success').addClass('alert-warning');
            }

            // Tutar validasyonu - her input için max değeri güncelle
            approveParts.forEach(part => {
                const amountInput = $(`.approve-part-item[data-part-id="${part.id}"] .approve-part-amount`);
                const currentAmount = parseFloat(amountInput.val()) || 0;
                const otherPartsTotal = approveParts
                    .filter(p => p.id !== part.id)
                    .reduce((sum, p) => {
                        const pAmount = p.id === part.id ? 0 : (parseFloat($(`.approve-part-item[data-part-id="${p.id}"] .approve-part-amount`).val()) || 0);
                        return sum + pAmount;
                    }, 0);
                const maxAmount = approveTotalAmount - otherPartsTotal;

                if (currentAmount > maxAmount) {
                    amountInput.val(maxAmount.toFixed(2));
                    part.amount = maxAmount;
                    updateRemainingAmount();
                }
                amountInput.attr('max', maxAmount);
            });
        }

        function validateApproveParts() {
            // Tüm parçaların tutarlarını güncelle
            approveParts.forEach(part => {
                const amountInput = $(`.approve-part-item[data-part-id="${part.id}"] .approve-part-amount`);
                const daySelect = $(`.approve-part-item[data-part-id="${part.id}"] .approve-part-day`);
                const monthSelect = $(`.approve-part-item[data-part-id="${part.id}"] .approve-part-month`);
                const yearSelect = $(`.approve-part-item[data-part-id="${part.id}"] .approve-part-year`);

                if (amountInput.length) {
                    part.amount = parseFloat(amountInput.val()) || 0;
                }
                if (daySelect.length) {
                    part.day = parseInt(daySelect.val());
                }
                if (monthSelect.length) {
                    part.month = parseInt(monthSelect.val());
                }
                if (yearSelect.length) {
                    part.year = parseInt(yearSelect.val());
                }
            });

            const totalPartsAmount = approveParts.reduce((sum, part) => sum + (parseFloat(part.amount) || 0), 0);

            if (totalPartsAmount > approveTotalAmount) {
                showToast(`Toplam parça tutarı (${new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(totalPartsAmount)}) toplam avans tutarını (${new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(approveTotalAmount)}) aşamaz.`, 'error', 'Hata');
                return false;
            }

            if (totalPartsAmount < approveTotalAmount) {
                showToast(`Toplam parça tutarı (${new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(totalPartsAmount)}) toplam avans tutarına (${new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(approveTotalAmount)}) eşit olmalıdır.`, 'warning', 'Uyarı');
                return false;
            }

            // Tarih validasyonu
            for (let part of approveParts) {
                const date = new Date(part.year, part.month - 1, part.day);
                if (date.getDate() !== part.day || date.getMonth() !== part.month - 1 || date.getFullYear() !== part.year) {
                    showToast('Geçersiz tarih seçildi.', 'error', 'Hata');
                    return false;
                }
            }

            return true;
        }

        async function submitApproveAdvance() {
            if (!validateApproveParts()) {
                return;
            }

            const advanceId = $('#txtApproveAdvanceRequestId').val();
            const parts = approveParts.map(part => ({
                day: part.day,
                month: part.month,
                year: part.year,
                amount: parseFloat(part.amount)
            }));

            const submitBtn = $('#btnSubmitApprove');
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Onaylanıyor...');

            try {
                const response = await makeRequest(`/avans/${advanceId}/onayla`, 'PUT', { parts: parts });

                showToast('Avans talebi başarıyla onaylandı.', 'success', 'Başarılı!');
                $('#approveAdvanceModal').modal('hide');
                advancesTable.ajax.reload(null, false);
            } catch (error) {
                console.error('Onaylama hatası:', error);
                handleError(error, 'Onaylama başarısız');
            } finally {
                submitBtn.prop('disabled', false).html('<i class="fas fa-check me-1"></i>Onayla');
            }
        }
        function viewAdvanceParts(advanceId) {
            // DataTable'dan row'u bul
            const row = advancesTable.rows().data().toArray().find(r => r.id === advanceId);

            if (!row || !row.parts || row.parts.length === 0) {
                showToast('Parça bilgisi bulunamadı', 'warning', 'Uyarı');
                return;
            }

            // Modal başlığını güncelle
            const formattedTotalAmount = new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(row.amount);
            $('#viewPartsModal .modal-title').html(`<i class="fas fa-list me-2"></i>Avans Parçaları - ${formattedTotalAmount}`);

            const tbody = $('#viewPartsTableBody');
            tbody.empty();

            let totalAmount = 0;
            row.parts.forEach((part, index) => {
                const date = new Date(part.year, part.month - 1, part.day);
                const formattedDate = date.toLocaleDateString('tr-TR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const formattedAmount = new Intl.NumberFormat('tr-TR', {
                    style: 'currency',
                    currency: 'TRY'
                }).format(part.amount);
                totalAmount += parseFloat(part.amount);

                tbody.append(`
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${formattedDate}</td>
                                                <td class="text-end">${formattedAmount}</td>
                                            </tr>
                                        `);
            });

            // Toplam satırı ekle
            const totalFormatted = new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(totalAmount);
            tbody.append(`
                                        <tr class="table-info fw-bold">
                                            <td colspan="2" class="text-end">TOPLAM:</td>
                                            <td class="text-end">${totalFormatted}</td>
                                        </tr>
                                    `);

            $('#viewPartsModal').modal('show');
        }

        function openRejectModal(id) {
            $('#txtRejectAdvanceRequestId').val(id);
            $('#txtRejectReason').val('');
            $('#rejectModal').modal('show');
        }
        async function rejectAdvanceRequest() {
            try {
                const advanceRequestId = $('#txtRejectAdvanceRequestId').val();

                if (!advanceRequestId) {
                    showToast('Avans talebi ID\'si bulunamadı', 'error', 'Hata');
                    return;
                }

                const rejectReason = $('#txtRejectReason').val().trim();

                const submitBtn = $('#btnRejectAdvanceRequest');
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Reddediliyor...');

                const url = `/avans/${advanceRequestId}/reddet${rejectReason ? `?rejectReason=${encodeURIComponent(rejectReason)}` : ''}`;
                await makeRequest(url, 'PUT');

                showToast('Avans talebi başarıyla reddedildi.', 'success', 'Başarılı');
                $('#rejectModal').modal('hide');
                advancesTable.ajax.reload(null, false);

            } catch (error) {
                console.error('Reddetme hatası:', error);
                handleError(error, 'Avans talebi reddedilirken hata oluştu');
            } finally {
                const submitBtn = $('#btnRejectAdvanceRequest');
                submitBtn.prop('disabled', false).html('<i class="fas fa-times me-1"></i>Reddet');
            }
        }

    </script>

}