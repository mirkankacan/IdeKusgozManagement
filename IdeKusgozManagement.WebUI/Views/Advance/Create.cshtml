@{
    ViewData["Title"] = "Avans Taleplerim";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

}
@Html.AntiForgeryToken()
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-money-bill me-2"></i>
                    Avans Taleplerim
                </h5>
                <div class="mb-3">
                    <span id="totalJobAdvance" class="badge bg-success me-2 text-dark fs-5">İş Avansı Bakiyesi:
                        ₺0</span>
                    <span id="totalSalaryAdvance" class="badge bg-success me-2 text-dark fs-5">Maaş Avansı Bakiyesi:
                        ₺0</span>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                    data-bs-target="#createAdvanceRequestModal">
                    <i class="fas fa-plus me-2"></i>Avans Talebi Oluştur
                </button>
                <br />
                <br />
                <div class="table-responsive">
                    <table id="myAdvanceRequestsTable" class="table table-striped table-hover display"
                        style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>TALEP<br /> NEDENİ</th>
                                <th>TUTAR</th>
                                <th>DURUM</th>
                                <th>OLUŞTURMA<br />TARİHİ</th>
                                <th>OLUŞTURAN<br />KULLANICI</th>
                                <th>İŞLEM<br />YAPAN<br />ÜST</th>
                                <th>ÜST<br />İŞLEM<br />TARİHİ</th>
                                <th>İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- DataTables will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="createAdvanceRequestModal" tabindex="-1" aria-labelledby="createAdvanceRequestModalLabel"
    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Avans Talebi Oluşturma Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createAdvanceRequestForm" class="needs-validation" novalidate>
                <div class="modal-body">
                    <div class="row g-3">
                        @if (!User.IsInRole("Personel"))
                        {
                            <div class="col-md-12">
                                <label for="selectCUserId" class="form-label">Kullanıcı</label>
                                <select class="form-select selectUser" id="selectCUserId" style="width: 100%;">
                                    <option value="">Kendi adıma</option>
                                </select>
                                <div class="valid-feedback">İyi görünüyor!</div>
                                <div class="invalid-feedback">Geçerli bir kullanıcı seçiniz.</div>
                            </div>
                        }
                        <div class="col-md-12">
                            <label for="selectCAdvanceReason" class="form-label">Talep Nedeni</label>
                            <select class="form-select selectAdvanceReason" id="selectCAdvanceReason" required>
                                <option value="" selected disabled>Talep nedeni seçiniz...</option>
                                <option>İş Avansı</option>
                                <option>Maaş Avansı</option>
                            </select>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli talep nedeni seçiniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="txtCAmount" class="form-label">Tutar</label>
                            <input type="number" class="form-control" id="txtCAmount" required step="0.1">
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir tutar giriniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="txtCDescription" class="form-label">Açıklama (İsteğe Bağlı)</label>
                            <textarea class="form-control" id="txtCDescription" rows="3"
                                placeholder="Açıklama..."></textarea>
                        </div>
                        <div class="col-md-12" id="advanceInfoContainer" style="display: none;">
                            <div class="alert alert-info" role="alert">
                                <h6 class="alert-heading">
                                    <i class="fas fa-info-circle me-2"></i>Avans Türü Hakkında
                                    Bilgi
                                </h6>
                                <hr>
                                <div id="advanceInfoContent">
                                    <!-- Dinamik içerik buraya gelecek -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkAdvanceTerms" required>
                                <label class="form-check-label" for="chkAdvanceTerms">
                                    Avans türlerini okudum ve anladım
                                </label>
                                <div class="invalid-feedback">
                                    Avans türlerini okuduğunuzu onaylamanız gerekmektedir.
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus me-1"></i>Oluştur</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="updateAdvanceRequestModal" tabindex="-1" aria-labelledby="updateAdvanceRequestModalLabel"
    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Avans Talebi Güncelleme Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form class="needs-validation" novalidate id="updateAdvanceRequestForm">
                <div class="modal-body">
                    <input type="hidden" id="txtUId">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="selectUAdvanceReason" class="form-label">Talep Nedeni</label>
                            <select class="form-select selectAdvanceReason" id="selectUAdvanceReason" required>
                                <option value="" selected disabled>Talep nedeni seçiniz...</option>
                                <option>İş Avansı</option>
                                <option>Maaş Avansı</option>
                                <option>Yemek Avansı</option>
                            </select>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli talep nedeni seçiniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="txtUAmount" class="form-label">Tutar</label>
                            <input type="number" class="form-control" id="txtUAmount" required step="0.1">
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir tutar giriniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="txtUDescription" class="form-label">Açıklama (İsteğe Bağlı)</label>
                            <textarea class="form-control" id="txtUDescription" rows="3"
                                placeholder="Açıklama..."></textarea>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-pen me-1"></i>Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- View Parts Modal -->
<div class="modal fade" id="viewPartsModal" tabindex="-1" aria-labelledby="viewPartsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list me-2"></i>Avans Parçaları
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Onay Tarihi</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="viewPartsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        let myAdvanceRequestsTable;

        $(document).ready(async function () {
            setupEventListeners();
            if (!window.isUserPersonel) {
                await initializeUserSelect();
            }
            await getMyBalance();
            await initializeDataTable();

        });
        async function initializeDataTable() {
            myAdvanceRequestsTable = $('#myAdvanceRequestsTable').DataTable({
                "processing": true,
                "ajax": {
                    "url": "/avans/listem",
                    "type": "GET",
                    "dataSrc": function (json) {
                        if (json) {
                            return json;
                        }
                        return [];
                    },
                    "error": function (xhr, error, code) {
                        console.error('DataTables AJAX error:', error);
                        let errorMessage = 'Veriler yüklenirken hata oluştu';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ': ' + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ': ' + xhr.responseText;
                            }
                        } catch (e) {
                            errorMessage += ': ' + error;
                        }
                        showToast(errorMessage, 'error', 'Hata');
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "width": "5%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            return '';
                        }
                    },
                    {
                        "data": "reason",
                        "render": function (data) {
                            return data || '';
                        }
                    },
                    {
                        "data": "amount",
                        "render": function (data) {
                            if (!data && data !== 0) return '';

                            return new Intl.NumberFormat('tr-TR', {
                                style: 'currency',
                                currency: 'TRY'
                            }).format(data);
                        }
                    },
                    {
                        "data": "statusText",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.status === 0) {
                                return `<span class="badge bg-warning">${data}</span>`;
                            } else if (row.status === 1) {
                                return `<span class="badge bg-success">${data}</span>`;
                            } else if (row.status === 2) {
                                return `<span class="badge bg-primary">${data}</span>`;
                            } else if (row.status === 3 || row.status === 4) {
                                return `<span class="badge bg-danger">${data}</span>`;
                            } else {
                                return `<span class="badge bg-secondary">${data}</span>`;
                            }
                        }
                    },
                    {
                        "data": "createdDate",
                        "render": function (data) {
                            return data ? new Date(data).toLocaleString('tr-TR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                        }
                    },
                    {
                        "data": "createdByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            return data ? data : "";
                        }
                    },
                    {
                        "data": "chiefByFullName",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.unitManagerFullName) {
                                return row.unitManagerFullName;
                            }
                            else if (data) {
                                return data
                            }
                            else {
                                return "";
                            }

                        }
                    },
                    {
                        "data": "chiefProcessedDate",
                        "render": function (data, type, row) {
                            if (row.unitManagerProcessedDate) {
                                return new Date(row.unitManagerProcessedDate).toLocaleString('tr-TR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            }
                            else if (data) {
                                return new Date(data).toLocaleString('tr-TR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            }
                            else {
                                return "";
                            }

                        }
                    },
                    {
                        "data": null,
                        "width": "10%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {
                            var buttons = '<div class="btn-group btn-group-sm" role="group">';

                            if (row.status === 0) {
                                buttons += `
                                            <button type="button" class="btn btn-outline-warning btn-sm"
                                                onclick="loadAdvanceForEdit('${row.id}')" title="Düzenle">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                onclick="deleteAdvanceRequest('${row.id}')" title="Sil">
                                                <i class="fas fa-trash"></i>
                                            </button>`;
                            } else if (row.hasParts && row.parts && row.parts.length > 0) {
                                buttons += `
                                            <button type="button" class="btn btn-outline-info btn-sm"
                                                onclick="viewAdvanceParts('${row.id}')" title="Parçaları Görüntüle">
                                                <i class="fas fa-list"></i>
                                            </button>`;
                            }

                            buttons += '</div>';
                            return buttons;

                        }
                    }
                ],
                "language": {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json'
                },
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "pageLength": 10,
                "responsive": true,
                "searchDelay": 300,
                "order": [[4, "desc"]], // Order by created date desc
                "drawCallback": function () {
                    var api = this.api();
                    var pageInfo = api.page.info();

                    api.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });
                    $('[title]').tooltip();
                }
            });
        }
        async function initializeUserSelect() {
            try {
                const response = await makeRequest('/kullanici/liste', 'GET');

                if (response && Array.isArray(response)) {
                    const select = $('#selectCUserId');
                    select.select2({
                        theme: 'bootstrap-5',
                        placeholder: 'Kullanıcı seçiniz...',
                        allowClear: true,
                        language: {
                            noResults: function () {
                                return "Sonuç bulunamadı";
                            }
                        }
                    });

                    // Kullanıcıları ekle
                    response.forEach(function (user) {
                        if (user.isActive) {
                            const option = new Option(user.fullNameWithExp || user.fullName, user.id, false, false);
                            select.append(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Kullanıcı listesi yüklenirken hata:', error);
                handleError(error, 'Kullanıcı listesi yüklenirken bir hata oluştu.');
            }
        }

        function setupEventListeners() {
            // Avans türü seçildiğinde bilgiyi güncelle
            $('#selectCAdvanceReason').on('change', function () {
                updateAdvanceInfo($(this).val());
            });

            // Create expense form
            $('#createAdvanceRequestForm').on('submit', function (e) {
                e.preventDefault();
                // Checkbox kontrolü
                if (!$('#chkAdvanceTerms').is(':checked')) {
                    $('#chkAdvanceTerms').addClass('is-invalid');
                    $(this).addClass('was-validated');
                    return false;
                } else {
                    $('#chkAdvanceTerms').removeClass('is-invalid').addClass('is-valid');
                }
                if (this.checkValidity()) {
                    createAdvanceRequest();
                }
                $(this).addClass('was-validated');
            });

            // Update expense form
            $('#updateAdvanceRequestForm').on('submit', function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    updateAdvanceRequest();
                }
                $(this).addClass('was-validated');
            });

            // Clear forms when modals hide
            $('#createAdvanceRequestModal').on('hidden.bs.modal', function () {
                $('#createAdvanceRequestForm')[0].reset();
                $('#createAdvanceRequestForm').removeClass('was-validated');
                $('#chkAdvanceTerms').removeClass('is-invalid is-valid');
                $('#advanceInfoContainer').hide();
                $('#selectCUserId').val('').trigger('change');
            });

            // Checkbox değiştiğinde validasyon sınıflarını güncelle
            $('#chkAdvanceTerms').on('change', function () {
                if ($(this).is(':checked')) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else {
                    $(this).removeClass('is-valid');
                }
            });
        }

        function updateAdvanceInfo(advanceType) {
            const infoContainer = $('#advanceInfoContainer');
            const infoContent = $('#advanceInfoContent');

            if (!advanceType || advanceType === '') {
                infoContainer.hide();
                return;
            }

            let content = '';

            if (advanceType === 'İş Avansı') {
                content = `
                                                <p class="mb-2"><strong>İş Avansı:</strong></p>
                                                <p class="mb-0 small">Görevinizi yerine getirebilmeniz için gerekli olan iş ile ilgili harcamaları karşılamak amacıyla İşveren tarafından önceden verilen nakit veya hesaba havale tutarıdır. Bu avans, işin yürütülmesi için yapılacak masrafları (örneğin seyahat, konaklama, malzeme alımı) karşılamak üzere verilir ve harcama belgeleri ile kapatılır. Kullanılmayan tutar iade edilir.</p>
                                            `;
            } else if (advanceType === 'Maaş Avansı') {
                content = `
                                                <p class="mb-2"><strong>Maaş Avansı:</strong></p>
                                                <p class="mb-0 small">Maaş hakkedişinizden kendi özel harcamalarınıza istinaden maaşından mahsup edilmek üzere istediğiniz tutardır.</p>
                                            `;
            }

            infoContent.html(content);
            infoContainer.show();
        }

        $('#updateAdvanceRequestModal').on('hidden.bs.modal', function () {
            $('#updateAdvanceRequestForm')[0].reset();
            $('#updateAdvanceRequestForm').removeClass('was-validated');
        });

        $('#viewPartsModal').on('hidden.bs.modal', function () {
            $('#viewPartsTableBody').empty();
            $('#viewPartsModal .modal-title').html('<i class="fas fa-list me-2"></i>Avans Parçaları');
        });

        async function createAdvanceRequest() {
            const selectedUserId = $('#selectCUserId').val();
            const advanceData = {
                amount: $('#txtCAmount').val(),
                description: $('#txtCDescription').val().trim() ?? null,
                reason: $('#selectCAdvanceReason').val()
            };

            // Eğer kullanıcı seçildiyse userId ekle (backend'de userId alanı varsa)
            if (selectedUserId && selectedUserId !== '') {
                advanceData.userId = selectedUserId;
            }

            try {
                const response = await makeRequest('/avans/istek-olustur', 'POST', advanceData);

                showToast('Avans talebi başarıyla oluşturuldu.', 'success', 'Başarılı!');
                $('#createAdvanceRequestModal').modal('hide');
                myAdvanceRequestsTable.ajax.reload();
            } catch (error) {
                console.error('Create advance error:', error);
                handleError(error, 'Avans talebi oluşturulurken hata oluştu.');
            }
        }
        async function getMyBalance() {
            try {
                const response = await makeRequest(`/kullanici-bakiye/bakiyem`, 'GET');

                if (response) {
                    const totalJobAdvance = response.totalJobAdvanceBalance;
                    const totalSalaryAdvance = response.totalSalaryAdvanceBalance;
                    $('#totalJobAdvance').text("İş Avansı Bakiyesi: ₺" + totalJobAdvance);
                    $('#totalSalaryAdvance').text("Maaş Avansı Bakiyesi: ₺" + totalSalaryAdvance);
                    if (totalJobAdvance < 0) {
                        $('#totalJobAdvance').removeClass('bg-success').addClass('bg-danger');
                    } else {
                        $('#totalJobAdvance').removeClass('bg-danger').addClass('bg-success');
                    }

                    if (totalSalaryAdvance < 0) {
                        $('#totalSalaryAdvance').removeClass('bg-success').addClass('bg-danger');
                    } else {
                        $('#totalSalaryAdvance').removeClass('bg-danger').addClass('bg-success');
                    }

                } else {
                    $('#totalJobAdvance').text("İş Avansı Bakiyesi: ₺0");
                    $('#totalSalaryAdvance').text("Maaş Avansı Bakiyesi: ₺0");
                }

            } catch (error) {
                $('#totalJobAdvance').text("İş Avansı Bakiyesi: Hata");
                $('#totalSalaryAdvance').text("Maaş Avansı Bakiyesi: Hata");
                handleError(error, 'Bakiye bilgisi yüklenirken hata oluştu.');
            }
        }
        async function loadAdvanceForEdit(advanceId) {
            try {
                const response = await makeRequest(`/avans/${advanceId}`, 'GET');

                $('#txtUId').val(response.id);
                $('#txtUAmount').val(response.amount);
                $('#txtUDescription').val(response.description);
                $('#selectUAdvanceReason').val(response.reason);
                $('#updateAdvanceRequestModal').modal('show');
            } catch (error) {
                console.error('Load advance error:', error);
                handleError(error, 'Avans bilgisi yüklenirken hata oluştu.');
            }
        }

        async function updateAdvanceRequest() {
            const expenseId = $('#txtUId').val();
            const advanceData = {
                amount: $('#txtUAmount').val(),
                description: $('#txtUDescription').val().trim() ?? null,
                reason: $('#selectUAdvanceReason').val()
            };

            try {
                const response = await makeRequest(`/avans/${expenseId}`, 'PUT', advanceData);

                showToast('Avans talebi başarıyla güncellendi.', 'success', 'Başarılı!');
                $('#updateAdvanceRequestModal').modal('hide');
                myAdvanceRequestsTable.ajax.reload();
            } catch (error) {
                console.error('Update advance error:', error);
                handleError(error, 'Avans talebi güncellenirken hata oluştu.');
            }
        }
        async function deleteAdvanceRequest(advanceRequestId) {
            try {
                const result = await Swal.fire({
                    title: 'Avans Talebini Sil',
                    text: 'Bu avans talebini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-trash"></i> Evet, Sil',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await makeRequest(`/avans/${advanceRequestId}`, 'DELETE');
                            return response;
                        } catch (error) {
                            let errorMessage = 'Silme başarısız';
                            if (error.detail) {
                                errorMessage = error.detail;
                            } else if (error.title) {
                                errorMessage = error.title;
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;

                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Avans talebi başarıyla silindi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    myAdvanceRequestsTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Silme hatası:', error);
            }
        }

        function viewAdvanceParts(advanceId) {
            const row = myAdvanceRequestsTable.rows().data().toArray().find(r => r.id === advanceId);

            if (!row || !row.parts || row.parts.length === 0) {
                showToast('Parça bilgisi bulunamadı', 'warning', 'Uyarı');
                return;
            }

            const formattedTotalAmount = new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(row.amount);
            $('#viewPartsModal .modal-title').html(`<i class="fas fa-list me-2"></i>Avans Parçaları - ${formattedTotalAmount}`);

            const tbody = $('#viewPartsTableBody');
            tbody.empty();

            let totalAmount = 0;
            row.parts.forEach((part, index) => {
                const date = new Date(part.year, part.month - 1, part.day);
                const formattedDate = date.toLocaleDateString('tr-TR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const formattedAmount = new Intl.NumberFormat('tr-TR', {
                    style: 'currency',
                    currency: 'TRY'
                }).format(part.amount);
                totalAmount += parseFloat(part.amount);

                tbody.append(`
                            <tr>
                                <td>${index + 1}</td>
                                <td>${formattedDate}</td>
                                <td class="text-end">${formattedAmount}</td>
                            </tr>
                        `);
            });

            const totalFormatted = new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(totalAmount);
            tbody.append(`
                        <tr class="table-info fw-bold">
                            <td colspan="2" class="text-end">TOPLAM:</td>
                            <td class="text-end">${totalFormatted}</td>
                        </tr>
                    `);

            $('#viewPartsModal').modal('show');
        }

    </script>

}