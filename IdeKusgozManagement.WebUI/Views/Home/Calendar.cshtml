@{
    ViewData["Title"] = "Takvim";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section CalendarCss {
    <link href="~/theme/assets/plugins/fullcalendar/main.min.css" rel="stylesheet">
}
@section Styles {
    <style>
        .fc-event-title.fc-sticky {
            color: white !important;
        }

        /* All-day yazƒ±sƒ±nƒ± gizle */
        .fc-list-event-time {
            color: transparent !important;
            position: relative;
        }

        /* Yerine T√ºm G√ºn yaz */
        .fc-list-event-time::after {
            content: "T√ºm G√ºn";
            color: #6c757d !important;
        }
    </style>
}

<div class="card">
    <div class="card-body">
        <div id='calendar'></div>
    </div>
</div>
@section Scripts {
    <script src="~/theme/assets/plugins/fullcalendar/main.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'tr',
                firstDay: 1,
                height: 505,

                // Header toolbar - g√∂r√ºn√ºm deƒüi≈ütirme butonlarƒ±
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek,dayGridDay,listWeek'
                },

                buttonText: {
                    today: '\u0042\u0075\u0067\u00fc\u006e',
                    month: 'Ay',
                    week: 'Hafta',
                    day: '\u0047\u00fc\u006e',
                    list: 'Liste',
                    prev: '\u00d6\u006e\u0063\u0065\u006b\u0069',
                    next: 'Sonraki'
                },

                // Farklƒ± g√∂r√ºn√ºmler i√ßin √∂zel ayarlar
                views: {
                    dayGridMonth: {
                        dayMaxEvents: 3,
                        moreLinkClick: 'popover'
                    },
                    listWeek: {
                        listDayFormat: { weekday: 'long', month: 'long', day: 'numeric' }
                    }
                },

                titleFormat: {
                    year: 'numeric',
                    month: 'long'
                },
                moreLinkText: function (n) {
                    return '+ ' + n + ' tane daha';
                },
                noEventsText: 'G√∂r√ºnt√ºlenecek etkinlik yok',
                didMount: function () {
                    initializeTooltips();
                },
                eventDidMount: function (info) {
                    // Debug i√ßin konsola yazdƒ±r
                    console.log('Event mounted:', {
                        title: info.event.title,
                        start: info.event.start,
                        end: info.event.end,
                        allDay: info.event.allDay,
                        view: info.view.type
                    });

                    let tooltipContent = '';

                    if (info.event.extendedProps.type === 'leave') {
                        tooltipContent = `
                                    <div>
                                        <strong>üèñÔ∏è ${info.event.extendedProps.createdByName}</strong><br>
                                        <small><b>Sebep:</b> ${info.event.extendedProps.reason}</small><br>
                                        <small><b>Ba≈ülangƒ±√ß:</b> ${new Date(info.event.start).toLocaleDateString('tr-TR')}</small><br>
                                        <small><b>Biti≈ü:</b> ${new Date(info.event.extendedProps.originalEndDate).toLocaleDateString('tr-TR')}</small><br>
                                        <small><b>Net ƒ∞zin S√ºresi:</b> ${info.event.extendedProps.duration}</small><br>
                                        <small><b>ƒ∞zin Olu≈üturulma Tarihi:</b> ${new Date(info.event.extendedProps.createdDate).toLocaleString('tr-TR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</small><br>
                                        <small><b>ƒ∞zin Onaylanma Tarihi:</b> ${new Date(info.event.extendedProps.updatedDate).toLocaleString('tr-TR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</small><br>
                                        <small><b>Onaylayan:</b> ${info.event.extendedProps.updatedByName}</small>
                                    </div>
                                `;
                    } else if (info.event.extendedProps.type === 'project') {
                        tooltipContent = `
                                    <div>
                                        <strong>üìã ${info.event.extendedProps.projectName}</strong><br>
                                        <small><b>Ba≈ülangƒ±√ß:</b> ${new Date(info.event.start).toLocaleDateString('tr-TR')}</small><br>
                                        <small><b>Biti≈ü:</b> ${new Date(info.event.extendedProps.originalEndDate).toLocaleDateString('tr-TR')}</small><br>
                                        <small><b>Durum:</b> ${info.event.extendedProps.isActive ? '‚úÖ Aktif' : '‚ùå Pasif'}</small><br>
                                        <small><b>Olu≈üturulma:</b> ${new Date(info.event.extendedProps.createdDate).toLocaleString('tr-TR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</small>
                                    </div>
                                `;
                    }

                    tippy(info.el, {
                        content: tooltipContent,
                        allowHTML: true,
                        theme: 'light',
                        placement: 'top',
                        arrow: true,
                        animation: 'fade',
                        duration: [200, 150],
                        hideOnClick: false,
                        trigger: 'mouseenter focus'
                    });
                },
                events: async function (fetchInfo, successCallback, failureCallback) {
                    try {
                        // Debug i√ßin tarih aralƒ±ƒüƒ±nƒ± konsola yazdƒ±r
                        console.log('Fetching events for:', {
                            start: fetchInfo.start,
                            end: fetchInfo.end,
                            timeZone: fetchInfo.timeZone
                        });

                        // ƒ∞zinleri al
                        const leaveData = await makeRequest('/takvim/izinler', 'GET');

                        // Projeleri al
                        const projectData = await makeRequest('/takvim/projeler', 'GET');

                        let events = [];

                        // ƒ∞zinleri event'lere √ßevir
                        if (leaveData && Array.isArray(leaveData)) {
                            const leaveEvents = leaveData.map(leave => {
                                const color = getLeaveColor(leave.createdBy);
                                const startDate = new Date(leave.startDate);
                                const endDate = new Date(leave.endDate);
                                endDate.setDate(endDate.getDate() + 1);


                                return {
                                    id: 'leave-' + leave.id,
                                    title: 'üèñÔ∏è ' + leave.createdByFullName + ' - ' + leave.reason,
                                    start: startDate.toISOString().split('T')[0], // YYYY-MM-DD format
                                    end: endDate.toISOString().split('T')[0],     // YYYY-MM-DD format
                                    allDay: true,
                                    backgroundColor: color,
                                    borderColor: color,
                                    classNames: ['event-leave'],
                                    extendedProps: {
                                        type: 'leave',
                                        reason: leave.reason,
                                        createdByName: leave.createdByFullName,
                                        status: leave.status,
                                        createdDate: leave.createdDate,
                                        updatedByName: leave.updatedByFullName,
                                        updatedDate: leave.updatedDate,
                                        duration: leave.duration,
                                        originalEndDate: leave.endDate
                                    }
                                };
                            });
                            events = events.concat(leaveEvents);
                        }

                        // Projeleri event'lere √ßevir
                        if (projectData && Array.isArray(projectData)) {
                            const projectEvents = projectData
                                .filter(project => project.name !== 'Ofis' && project.name !== 'Garaj')
                                .map(project => {
                                    const startDate = new Date(project.startDate);
                                    const endDate = new Date(project.endDate);
                                    endDate.setDate(endDate.getDate() + 1);
                                    const hexToRgb = (hex) => {
                                        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                                        return result ? {
                                            r: parseInt(result[1], 16),
                                            g: parseInt(result[2], 16),
                                            b: parseInt(result[3], 16)
                                        } : null;
                                    };

                                    const rgb = hexToRgb(project.projectColor || '#563d7c');
                                    const bgColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.4)`;
                                    const borderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.8)`;
                                    return {
                                        id: 'project-' + project.id,
                                        title: 'üìã ' + project.name,
                                        start: startDate.toISOString().split('T')[0], // YYYY-MM-DD format
                                        end: endDate.toISOString().split('T')[0],     // YYYY-MM-DD format
                                        allDay: true,
                                        backgroundColor: bgColor,
                                        borderColor: borderColor,
                                        classNames: ['event-project'],
                                        extendedProps: {
                                            type: 'project',
                                            projectName: project.name,
                                            isActive: project.isActive,
                                            createdDate: project.createdDate,
                                            originalEndDate: project.endDate
                                        }
                                    };
                                });
                            events = events.concat(projectEvents);
                        }


                        successCallback(events);

                    } catch (error) {
                        console.error('Veri y√ºkleme hatasƒ±:', error);
                        handleError(error, 'Takvim verileri y√ºklenirken bir hata olu≈ütu');
                        failureCallback();
                    }
                }
            });

            calendar.render();

            // Tooltip'leri yeniden initialize etme fonksiyonu
            function initializeTooltips() {
                document.querySelectorAll('[data-tippy-root]').forEach(el => {
                    if (el._tippy) {
                        el._tippy.destroy();
                    }
                });
            }

            const leaveColors = [
                'rgba(55, 136, 216, 0.5)',
                'rgba(40, 167, 69, 0.5)',
                'rgba(255, 193, 7, 0.5)',
                'rgba(220, 53, 69, 0.5)',
                'rgba(111, 66, 193, 0.5)',
                'rgba(253, 126, 20, 0.5)',
                'rgba(32, 201, 151, 0.5)',
                'rgba(232, 62, 140, 0.5)',
                'rgba(108, 117, 125, 0.5)',
                'rgba(23, 162, 184, 0.5)',
            ];

            function getLeaveColor(leaveId) {
                let hash = 0;
                for (let i = 0; i < leaveId.length; i++) {
                    const char = leaveId.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                hash = Math.abs(hash);
                return leaveColors[hash % leaveColors.length];
            }
        });
    </script>
}