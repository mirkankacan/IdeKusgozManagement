@model ApiResponse<UserViewModel>
@{
    ViewData["Title"] = "Profil";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Profil Güncelleme Sayfası</h5>

                <form class="row g-3 needs-validation" novalidate>
                    @Html.AntiForgeryToken()

                    <input type="hidden" id="txtUserId" readonly disabled value="@Model.Data.Id" />
                    <div class="col-md-6">
                        <label for="txtTCNo" class="form-label">TC No</label>
                        <input type="text" class="form-control" id="txtTCNo" name="TCNo" value="@Model.Data.TCNo"
                            required>
                        <div class="valid-feedback">İyi görünüyor!</div>
                        <div class="invalid-feedback">Geçerli bir TC No giriniz.</div>
                    </div>

                    <div class="col-md-6">
                        <label for="txtPassword" class="form-label">Şifre</label>
                        <input type="password" class="form-control" id="txtPassword" name="Password" value=""
                            autocomplete="new-password" data-lpignore="true">
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Boş bırakırsanız şifre değişmez, doldurursanız şifre güncellenir.
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="txtName" class="form-label">Adı</label>
                        <input type="text" class="form-control" id="txtName" name="Name" value="@Model.Data.Name"
                            required>
                        <div class="valid-feedback">İyi görünüyor!</div>
                        <div class="invalid-feedback">Geçerli bir isim giriniz.</div>
                    </div>

                    <div class="col-md-6">
                        <label for="txtSurname" class="form-label">Soyadı</label>
                        <input type="text" class="form-control" id="txtSurname" name="Surname"
                            value="@Model.Data.Surname" required>
                        <div class="valid-feedback">İyi görünüyor!</div>
                        <div class="invalid-feedback">Geçerli bir soyisim giriniz.</div>
                    </div>

                    <div class="col-12">
                        <button class="btn btn-primary w-100" id="btnUpdateProfile" type="submit">Güncelle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@section Scripts {

    <script>
        $(document).ready(async function () {
            $(document).on('click', '#btnUpdateProfile', async function (e) {
                e.preventDefault();
                e.stopPropagation();
                await updateProfile();
            });

        });
        async function updateProfile() {
            try {
                const submitBtn = $('.btn-primary');
                const originalText = submitBtn.text();
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Güncelleniyor...');

                const userData = {
                    Id: $('#txtUserId').val(),
                    TCNo: $('#txtTCNo').val().trim(),
                    Password: $("#txtPassword").val().trim() || null,
                    Name: $('#txtName').val().trim(),
                    Surname: $('#txtSurname').val().trim()
                };

                await makeRequest('/profil-guncelle', 'PUT', userData);

                showToast('Profil başarıyla güncellendi!', 'success', 'Başarılı');

                $('#txtPassword').val('');

                $('.needs-validation').removeClass('was-validated');

                setTimeout(() => {
                    location.reload()
                }, "1500");
            } catch (error) {
                console.error('Error:', error);
                handleError(error, 'Güncelleme sırasında hata oluştu!');
            } finally {
                // Loading'i kaldır
                const submitBtn = $('.btn-primary');
                submitBtn.prop('disabled', false).text('Güncelle');
            }
        }
    </script>
}