@inject IConfiguration Configuration
@{
    var fullName = User.FindFirstValue("FullName")!;
    var fullNameWithExp = User.FindFirstValue("FullNameWithExp")!;
    var departmentName = User.FindFirstValue("DepartmentName")!;
    var departmentDutyName = User.FindFirstValue("DepartmentDutyName")!;
}

<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="İdeaktif Danışmanlık ve Yazılım Ltd.">

    <!-- Favicon dosyaları -->
    <link rel="icon" type="image/png" sizes="16x16" href="~/theme/assets/images/favicons/favicon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="~/theme/assets/images/favicons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="72x72" href="~/theme/assets/images/favicons/favicon-72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="~/theme/assets/images/favicons/favicon-96.png">
    <link rel="shortcut icon" href="~/theme/assets/images/favicons/favicon-32.png">
    <!-- Title -->
    <title>@ViewData["Title"] • Kuşgöz İzmir Vinç</title>

    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,700,800&display=swap" rel="stylesheet">
    <link href="~/theme/assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
          integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="~/theme/assets/plugins/perfectscroll/perfect-scrollbar.css" rel="stylesheet">
    @await RenderSectionAsync("CalendarCss", required: false)
    <!-- Theme Styles -->
    <link href="~/theme/assets/css/main.min.css" rel="stylesheet">
    <link href="~/theme/assets/css/custom.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/toastr/build/toastr.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2/dist/sweetalert2.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tippy.js/dist/tippy.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/themes/light.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
    @await RenderSectionAsync("Styles", required: false)
    <style>
        .profile-dropdown {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .profile-department {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .modal-dialog-scrollable form {
            max-height: calc(100vh - 200px);
            /* header + footer yüksekliğini çıkar */
            overflow-y: auto;
        }

        .bold-notif-text {
            font-weight: bold !important;
            background-color: #e3f2fd !important;
        }

        .notification-item:hover {
            background-color: #f8f9fa !important;
        }

        .bold-notif-text:hover {
            background-color: #bbdefb !important;
        }

        .notification-item .fa-bell {
            font-size: 14px;
        }

        .notification-item .badge {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .notification-item {
            position: relative;
            border-left: 3px solid transparent;
        }

        .bold-notif-text {
            border-left-color: #2196f3 !important;
        }

        .modal-footer {
            flex-wrap: nowrap !important;
        }

        /* Approved/readonly row styles */
        :disabled,
        .disabled {
            opacity: 0.8;
            cursor: not-allowed !important;
        }

        .notif-drop-menu {
            max-height: unset !important;
            overflow-y: hidden !important;
            overflow-x: hidden !important;
        }

        .notification-item p {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .notification-item {
            max-width: 100%;
            overflow: hidden;
        }

            .notification-item .flex-grow-1 {
                min-width: 0;
                overflow: hidden;
            }

        .page-header .header-notif .notif-image span {
            width: 20px !important;
            height: 20px !important;
            line-height: 20px !important;
        }
    </style>
</head>

<body class="">

    <div class="page-container">
        <div class="page-header">
            <nav class="navbar navbar-expand-lg d-flex justify-content-between">
                <div class="" id="navbarNav">
                    <ul class="navbar-nav" id="leftNav">
                        <li class="nav-item">
                            <a class="nav-link" id="sidebar-toggle" href="#"><i data-feather="arrow-left"></i></a>
                        </li>

                    </ul>
                </div>
                <div class="logo">
                    <a class="navbar-brand" href="/ana-sayfa"></a>
                </div>
                <div class="" id="headerNav">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link notifications-dropdown" href="#" id="notificationsDropDown" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <span id="notificationCount">0</span>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end notif-drop-menu"
                                 aria-labelledby="notificationsDropDown" id="notificationsDropdown"
                                 data-bs-auto-close="false">
                                <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                                    <h6 class="dropdown-header mb-0">Bildirimler</h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="markAllAsReadBtn"
                                            style="display: none;">
                                        <i class="fas fa-check-double"></i>
                                    </button>
                                </div>

                                <div id="notificationsContainer" style="max-height: 400px; overflow-y: auto;">
                                    <div id="notificationsList">
                                        <div class="text-center py-3">
                                            <p class="text-muted mb-0">Henüz bildirim bulunmuyor</p>
                                        </div>
                                    </div>

                                    <div id="loadingIndicator" class="text-center py-2" style="display: none;">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                    </div>

                                    <div id="loadMoreContainer" class="text-center py-2" style="display: none;">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="loadMoreBtn">
                                            <i class="fas fa-chevron-down"></i> Daha Fazla Yükle
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="nav-item dropdown">

                            <a class="nav-link profile-dropdown" href="#" id="profileDropDown" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <img src="/theme/assets/images/avatars/profile-image.png" alt="">
                                <div class="profile-info">
                                    <span class="profile-name">@fullName</span>
                                    <span class="profile-department">@departmentDutyName</span>
                                </div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end profile-drop-menu"
                                 aria-labelledby="profileDropDown">
                                <a class="dropdown-item" href="/profil"><i data-feather="user"></i>Profil</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="/cikis-yap"><i data-feather="log-out"></i>Çıkış Yap</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
        <div class="page-sidebar">
            <ul class="list-unstyled accordion-menu">
                <li class="sidebar-title">
                    Menü
                </li>
                <li class="@(Context.Request.Path == "/ana-sayfa" ? "active-page" : "")">
                    <a href="/ana-sayfa"><i data-feather="home"></i>Ana Sayfa</a>
                </li>
                <li class="@(Context.Request.Path == "/takvim" ? "active-page" : "")">
                    <a href="/takvim"><i data-feather="calendar"></i>Takvim</a>
                </li>
                <li class="@(Context.Request.Path == "/sosyal" ? "active-page" : "")">
                    <a href="/sosyal"><i data-feather="message-circle"></i>Sosyal</a>
                </li>
                @if (User.IsInRole("Admin") || User.IsInRole("Yönetici"))
                {
                    <li class="sidebar-title">
                        Yönetici İşlemleri
                    </li>
                    <li class="@(Context.Request.Path == "/kullanici" ? "active-page" : "")">
                        <a href="/kullanici"><i data-feather="users"></i>Kullanıcılar</a>
                    </li>
                    <li class="@(Context.Request.Path == "/trafik-ceza" ? "active-page" : "")">
                        <a href="/trafik-ceza"><i data-feather="alert-octagon"></i>Trafik Cezaları</a>
                    </li>

                }
                @if (User.IsInRole("Admin") || User.IsInRole("Yönetici") || User.IsInRole("Şef"))
                {
                    <li class="sidebar-title">
                        Şef İşlemleri
                    </li>
                    <li class="@(Context.Request.Path == "/proje" ? "active-page" : "")">
                        <a href="/proje"><i data-feather="cpu"></i>Projeler</a>
                    </li>
                    <li class="@(Context.Request.Path == "/ekipman" ? "active-page" : "")">
                        <a href="/ekipman"><i data-feather="tool"></i>Ekipmanlar</a>
                    </li>
                    <li class="@(Context.Request.Path == "/masraf" ? "active-page" : "")">
                        <a href="/masraf"><i data-feather="tag"></i>Masraflar</a>
                    </li>
                    <li class="@(Context.Request.Path == "/izin" ? "active-page" : "")">
                        <a href="/izin"><i data-feather="navigation"></i>İzinler</a>
                    </li>
                    <li class="@(Context.Request.Path == "/firma" ? "active-page" : "")">
                        <a href="/firma"><i data-feather="git-branch"></i>Firmalar</a>
                    </li>
                    <li class="@(Context.Request.Path == "/puantaj" ? "active-page" : "")">
                        <a href="/puantaj"><i data-feather="list"></i>Puantajlar</a>
                    </li>
                    <li class="@(Context.Request.Path == "/makine-puantaj" ? "active-page" : "")">
                        <a href="/makine-puantaj"><i data-feather="table"></i>Makine Puantajları</a>
                    </li>
                    <li class="@(Context.Request.Path == "/avans" ? "active-page" : "")">
                        <a href="/avans"><i data-feather="book-open"></i>Avanslar</a>
                    </li>

                }
                @if (User.IsInRole("Admin") || User.IsInRole("Yönetici") || User.IsInRole("Şef"))
                {
                    <li class="sidebar-title">
                        Doküman İşlemleri
                    </li>
                    <li class="@(Context.Request.Path == "/dokuman" ? "active-page" : "")">
                        <a href="/dokuman"><i data-feather="layers"></i>Doküman Tipleri</a>
                    </li>
                    <li class="@(Context.Request.Path == "/dokuman/eslestirme" ? "active-page" : "")">
                        <a href="/dokuman/eslestirme"><i data-feather="link"></i>Doküman Eşleştirme</a>
                    </li>
                    <li class="@(Context.Request.Path == "/dokuman/yukle" ? "active-page" : "")">
                        <a href="/dokuman/yukle"><i data-feather="upload"></i>Doküman Yükle</a>
                    </li>

                    <li class="@(Context.Request.Path == "/dokuman/kontrol" ? "active-page" : "")">
                        <a href="/dokuman/kontrol"><i data-feather="user-check"></i>Doküman Kontrol</a>
                    </li>
                }
                <li class="sidebar-title">
                    Personel İşlemleri
                </li>
                <li class="@(Context.Request.Path == "/puantaj/ekle" ? "active-page" : "")">
                    <a href="/puantaj/ekle"><i data-feather="clock"></i>Puantaj Gir</a>
                </li>
                @if (User.IsInRole("Admin") || User.IsInRole("Yönetici") || User.IsInRole("Şef") || departmentDutyName.Contains("Operatör") || departmentDutyName.Contains("Şoför-Yük Taşıma"))
                {
                    <li class="@(Context.Request.Path == "/makine-puantaj/ekle" ? "active-page" : "")">
                        <a href="/makine-puantaj/ekle"><i data-feather="command"></i>Makine Puantajı Gir</a>
                    </li>
                }

                <li class="@(Context.Request.Path == "/izin/istek-olustur" ? "active-page" : "")">
                    <a href="/izin/istek-olustur"><i data-feather="flag"></i>İzinlerim</a>
                </li>
                <li class="@(Context.Request.Path == "/avans/istek-olustur" ? "active-page" : "")">
                    <a href="/avans/istek-olustur"><i data-feather="credit-card"></i>Avanslarım</a>
                </li>
                <li><br /></li>

            </ul>
        </div>
        <div class="page-content">
            <div class="main-wrapper">
                @RenderBody()
                <div class="modal fade" id="filePreviewModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-xl" role="document" style="max-width: 90%; height: 90vh;">
                        <div class="modal-content" style="height: 100%;">
                            <div class="modal-header">
                                <h5 class="modal-title" id="filePreviewModalTitle">Dosya Önizleme</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>

                            </div>
                            <div class="modal-body p-0" style="height: 100%; overflow: hidden;">
                                <!-- PDF için iframe -->
                                <iframe id="filePreviewIframe"
                                        style="width: 100%; height: 100%; border: none; display: none;"></iframe>

                                <!-- Excel için container -->
                                <div id="excelPreviewContainer" style="display: none; overflow: auto; height: 100%;">
                                </div>

                                <!-- Resim için container -->
                                <div id="imagePreviewContainer" style="display: none; overflow: auto; height: 100%;">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-6">
                    </div>
                    <div class="col-sm-6">
                        <div class="text-sm-end d-none d-sm-block">
                            <a href="https://www.ideaktif.com.tr" target="_blank" style="color:#5b5b5b">
                                2025 © İdeaktif
                                Danışmanlık ve Yazılım Ltd.
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <!-- Javascripts -->
    <script src="~/theme/assets/plugins/jquery/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@popperjs/core/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js/dist/tippy.umd.min.js"></script>
    <script src="~/theme/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/js/all.min.js"
            integrity="sha512-gBYquPLlR76UWqCwD06/xwal4so02RjIR0oyG1TIhSGwmBTRrIkQbaPehPF8iwuY9jFikDHMGEelt0DtY7jtvQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="~/theme/assets/plugins/perfectscroll/perfect-scrollbar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastr/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="~/theme/assets/plugins/blockui/jquery.blockUI.js"></script>
    <script src="~/theme/assets/js/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script src="~/js/realtime-manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <script src="~/theme/assets/plugins/pdfjs/build/pdf.mjs" type="module"></script>
    <script type="module">
        var { pdfjsLib } = globalThis;
        pdfjsLib.GlobalWorkerOptions.workerSrc = '~/theme/assets/plugins/pdfjs/build/pdf.worker.mjs';
    </script>
    <script>
        var turkishLocale = {
            "format": 'DD/MM/YYYY',
            "separator": ' - ',
            "applyLabel": 'Uygula',
            "cancelLabel": 'İptal',
            "fromLabel": 'Başlangıç',
            "toLabel": 'Bitiş',
            "customRangeLabel": 'Özel',
            "weekLabel": 'Hf',
            "daysOfWeek": [
                "Pz",
                "Pt",
                "Sl",
                "Çr",
                "Pr",
                "Cm",
                "Ct"
            ], "monthNames": ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'],
            "firstDay": 1

        };
        window.isUserPersonel = @Html.Raw(Json.Serialize(User.IsInRole("Personel")));
        window.isUserSef = @Html.Raw(Json.Serialize(User.IsInRole("Şef")));
        window.isUserUnitManager = @Html.Raw(Json.Serialize(User.IsInRole("Yönetici")));
        window.signalRUrl = (function () {
            const currentUrl = window.location.href;
            if (currentUrl.includes('portal.izmircrane.com')) {
                return 'http://92.45.19.226:5291/';
            } else if (currentUrl.startsWith('http://192.168.2.253:5290')) {
                return 'http://192.168.2.253:5291/';
            } else if (currentUrl.startsWith('http://localhost:5290')) {
                return 'http://localhost:5291/';
            }
        })();
        window.departmentName = @Html.Raw(Json.Serialize(departmentName))
            window.departmentDutyName = @Html.Raw(Json.Serialize(departmentDutyName))

            $(document).ready(async function () {

                $.ajaxSetup({
                    beforeSend: function (xhr, settings) {
                        if (settings.type !== 'GET') {
                            const token = $('input[name="__RequestVerificationToken"]').val();
                            if (token) {
                                xhr.setRequestHeader('X-CSRF-TOKEN', token);
                            }
                        }
                    },
                    statusCode: {
                        401: function (xhr) {
                            // 401 Unauthorized hatası geldiğinde
                            let message = 'Oturum süresi doldu. Lütfen tekrar giriş yapın.';
                            let redirectUrl = '/giris-yap';

                            // Backend'den gelen mesajı kontrol et
                            try {
                                const response = JSON.parse(xhr.responseText);
                                if (response.message) {
                                    message = response.message;
                                }
                                if (response.loginUrl) {
                                    redirectUrl = response.loginUrl;
                                }
                                if (response.redirectToLogin) {
                                    // Logout işlemi yap ve login sayfasına yönlendir
                                    handleUnauthorizedError(message, redirectUrl);
                                    return;
                                }
                            } catch (e) {
                                // JSON parse hatası - direkt logout yap
                            }

                            // Varsayılan olarak logout yap
                            handleUnauthorizedError(message, redirectUrl);
                        }
                    }
                });
            });

        // 401 hatası için logout ve yönlendirme fonksiyonu
        function handleUnauthorizedError(message, redirectUrl) {
            // Toastr mesajı göster
            if (typeof toastr !== 'undefined') {
                toastr.error(message, 'Oturum Sonlandı', {
                    timeOut: 3000,
                    onHidden: function () {
                        performLogout(redirectUrl);
                    }
                });
            } else {
                // Toastr yoksa direkt logout yap
                performLogout(redirectUrl);
            }
        }

        // Logout işlemi ve yönlendirme
        function performLogout(redirectUrl) {
            // Session storage ve local storage'ı temizle
            if (typeof sessionStorage !== 'undefined') {
                sessionStorage.clear();
            }
            if (typeof localStorage !== 'undefined') {
                localStorage.clear();
            }

            // Logout endpoint'ine istek gönder (GET olarak - başarısız olsa da devam et)
            $.ajax({
                url: '/cikis-yap',
                type: 'GET',
                async: false,
                timeout: 2000
            }).always(function () {
                // Her durumda login sayfasına yönlendir
                window.location.href = redirectUrl || '/giris-yap';
            });
        }
        function previewFile(file) {
            var fileName = file.name.toLowerCase();
            var fileType = file.type;

            // PDF önizleme
            if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
                previewPDF(file);
            }
            // Excel önizleme
            else if (fileType.includes('sheet') || fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                previewExcel(file);
            }
            // Resim önizleme
            else if (fileType.startsWith('image/')) {
                previewImage(file);
            }
            // Word dosyaları için
            else if (fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
                toastr.warning('Word dosyaları için önizleme desteklenmiyor. Lütfen dosyayı indirin.', 'Bilgi');
            }
            // Diğer dosyalar
            else {
                toastr.warning('Bu dosya türü için önizleme desteklenmiyor.', 'Bilgi');
            }
        }

        function previewPDF(file) {
            var blobUrl = URL.createObjectURL(file);
            var viewerPath = '/theme/assets/plugins/pdfjs/web/viewer.html';
            var iframe = $('#filePreviewIframe');
            var excelDiv = $('#excelPreviewContainer');
            var imageDiv = $('#imagePreviewContainer');

            if (iframe.length === 0) {
                console.error('Hata: filePreviewIframe idli element bulunamadı.');
                return;
            }

            // Diğer containerları gizle, PDF iframe'i göster
            excelDiv.hide().empty();
            imageDiv.hide().empty();
            iframe.show();

            $('#filePreviewModalTitle').text(file.name);
            iframe.attr('src', viewerPath + '?file=' + encodeURIComponent(blobUrl));
            $('#filePreviewModal').modal('show');

            $('#filePreviewModal').one('hidden.bs.modal', function () {
                URL.revokeObjectURL(blobUrl);
                iframe.attr('src', '').hide();
                excelDiv.empty();
                imageDiv.empty();
                $('#filePreviewModalTitle').text('Dosya Önizleme');
            });
        }

        function previewExcel(file) {
            var iframe = $('#filePreviewIframe');
            var excelDiv = $('#excelPreviewContainer');
            var imageDiv = $('#imagePreviewContainer');
            var modalTitle = $('#filePreviewModalTitle');

            iframe.hide();
            imageDiv.hide().empty();
            excelDiv.show().html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Excel dosyası işleniyor...</div>');

            modalTitle.text(file.name);

            var reader = new FileReader();
            reader.onload = function (e) {
                var data = new Uint8Array(e.target.result);
                try {
                    var workbook = XLSX.read(data, { type: 'array' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];

                    // Excel verisini JSON array'e çevir
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                    // Container'ı hazırla
                    excelDiv.html('<div id="handsontableContainer" style="overflow:hidden"></div>');

                    // Handsontable ile görselleştir
                    var container = document.getElementById('handsontableContainer');
                    var hot = new Handsontable(container, {
                        data: jsonData,
                        rowHeaders: true,
                        colHeaders: true,
                        readOnly: true,
                        width: '100%',
                        height: 'auto',
                        renderAllRows: true,
                        licenseKey: 'non-commercial-and-evaluation',
                        stretchH: 'all',
                        manualColumnResize: true,
                        manualRowResize: true,
                        contextMenu: true,
                        columnSorting: true,
                        filters: true
                    });

                } catch (error) {
                    console.error(error);
                    excelDiv.html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Dosya okunamadı.</div>');
                }
            };

            reader.onerror = function (ex) {
                console.log(ex);
                excelDiv.html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Dosya okuma hatası.</div>');
            };

            reader.readAsArrayBuffer(file);
            $('#filePreviewModal').modal('show');

            $('#filePreviewModal').one('hidden.bs.modal', function () {
                excelDiv.empty().hide();
                iframe.hide();
                imageDiv.empty();
            });
        }

        function previewImage(file) {
            var iframe = $('#filePreviewIframe');
            var excelDiv = $('#excelPreviewContainer');
            var imageDiv = $('#imagePreviewContainer');
            var modalTitle = $('#filePreviewModalTitle');

            // PDF iframe ve Excel containerını gizle, resim div'i göster
            iframe.hide();
            excelDiv.hide().empty();
            imageDiv.show().html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Resim yükleniyor...</div>');

            modalTitle.text(file.name);

            var reader = new FileReader();
            reader.onload = function (e) {
                var img = $('<img>')
                    .attr('src', e.target.result)
                    .addClass('img-fluid')
                    .css({
                        'max-width': '100%',
                        'max-height': '70vh',
                        'display': 'block',
                        'margin': '0 auto'
                    });
                imageDiv.html(img);
            };

            reader.onerror = function (ex) {
                console.log(ex);
                imageDiv.html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Resim yükleme hatası.</div>');
            };

            reader.readAsDataURL(file);
            $('#filePreviewModal').modal('show');

            $('#filePreviewModal').one('hidden.bs.modal', function () {
                imageDiv.empty().hide();
                iframe.hide();
                excelDiv.empty();
            });
        }
    </script>
    @await RenderSectionAsync("Scripts", required: false)

</body>

</html>