@{
    ViewData["Title"] = "Doküman Yükle";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link href="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <style>
        .dropzone {
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            min-height: 200px;
            padding: 20px;
        }

            .dropzone .dz-preview .dz-progress {
                border: unset;
                background: unset;
            }

            .dropzone:hover {
                border-color: #0056b3;
                background: #e3f2fd;
            }

            .dropzone.dz-drag-hover {
                border-color: #28a745;
                background: #d4edda;
            }

            .dropzone .dz-preview {
                margin: 10px;
                min-height: 0;
                cursor: pointer;
                position: relative;
                transition: all 0.2s ease;
            }

                /* 👇 Hover efekti - Yeni eklendi */
                .dropzone .dz-preview:hover {
                    transform: translateY(-2px);
                }

                .dropzone .dz-preview .dz-image {
                    border-radius: 8px;
                    overflow: hidden;
                    cursor: pointer;
                }

                .dropzone .dz-preview .dz-error-message {
                    background: #dc3545;
                    color: white;
                    border-radius: 4px;
                    padding: 5px 10px;
                    font-size: 12px;
                }

                /* 👇 Önizleme ikonu - Yeni eklendi */
                .dropzone .dz-preview .dz-image::before {
                    content: '🔍';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 32px;
                    opacity: 0;
                    transition: opacity 0.2s ease;
                    pointer-events: none;
                    z-index: 1;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                }

                .dropzone .dz-preview:hover .dz-image::before {
                    opacity: 0.9;
                }

                /* 👇 Resim üzerine koyu overlay - Yeni eklendi */
                .dropzone .dz-preview .dz-image::after {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0);
                    transition: background 0.2s ease;
                    pointer-events: none;
                }

                .dropzone .dz-preview:hover .dz-image::after {
                    background: rgba(0, 0, 0, 0.2);
                }

                /* 👇 Remove butonu hover'da önizleme açılmasın */
                .dropzone .dz-preview .dz-remove {
                    cursor: pointer !important;
                    z-index: 2;
                    position: relative;
                }

        .dropzone.dz-disabled {
            opacity: 0.6;
            pointer-events: none;
            cursor: not-allowed;
            background: #e9ecef;
        }

            .dropzone.dz-disabled .dz-message {
                opacity: 0.5;
            }

            /* 👇 Disabled durumunda hover efekti olmasın */
            .dropzone.dz-disabled .dz-preview {
                cursor: not-allowed;
            }

                .dropzone.dz-disabled .dz-preview:hover {
                    transform: none;
                    box-shadow: none;
                }

        /* 👇 Fancybox özelleştirme - Yeni eklendi */
        .fancybox__container {
            z-index: 9999 !important;
        }

        /* 👇 Excel preview tablosu için - Yeni eklendi */
        .excel-preview {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

            .excel-preview table {
                border-collapse: collapse;
                width: 100%;
                margin-top: 10px;
                font-size: 14px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .excel-preview th,
            .excel-preview td {
                border: 1px solid #ddd;
                padding: 8px 12px;
                text-align: left;
            }

            .excel-preview th {
                background-color: #007bff; /* 👈 Mevcut tema rengine uyumlu */
                color: white;
                font-weight: bold;
            }

            .excel-preview tr:nth-child(even) {
                background-color: #f8f9fa;
            }

            .excel-preview tr:hover {
                background-color: #e3f2fd;
            }

    </style>
}

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-file me-2"></i>
                    Doküman Yükleme
                </h5>
                <!-- File Type Selection -->
                <div class="file-type-section">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="department-select" class="form-label">Departman</label>
                            <select id="department-select" class="form-select">
                                <option value="">Departman seçin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="department-duty-select" class="form-label">Departman Görev</label>
                            <select id="department-duty-select" class="form-select">
                            </select>
                        </div>
                    </div>
                    <div class="row mt-2">
                         <div class="col-md-6">
                            <label for="document-type-select" class="form-label">Doküman Tipi</label>
                            <select id="document-type-select" class="form-select">
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="company-select" class="form-label">Firma</label>
                            <select id="company-select" class="form-select">
                            </select>
                        </div>
                       

                    </div>

                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label for="target-select" class="form-label">Hedef</label>
                            <select id="target-select" class="form-select">
                            </select>
                        </div>
                        <div class="col-md-2 mt-5">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="hasRenewalPeriodCheckbox">
                                <label class="form-check-label" for="hasRenewalPeriodCheckbox">
                                    Süreli mi?
                                </label>
                            </div>
                        </div>
                        <div id="dateRangeContainer" style="display: none;" class="col-md-4">
                            <label class="form-label">Tarih Aralığı</label>
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="start-date" placeholder="Başlangıç tarihi">
                                        <span class="input-group-text date-picker-trigger" data-target="#start-date">
                                            <i class="fas fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="end-date" placeholder="Bitiş tarihi">
                                        <span class="input-group-text date-picker-trigger" data-target="#end-date">
                                            <i class="fas fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                'Süreli mi' seçeneği seçilip tarih aralığı seçilmeden doküman yüklenirse başlangıç
                                tarihini yapay zeka tespit eder. Bitiş tarihi sistemdeki yenileme süresi ile hesaplanır
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Dropzone Area -->
                <form id="fileUploadForm" class="dropzone mt-3" action="/dosya/yukle" method="post"
                      enctype="multipart/form-data">
                    <div class="dz-message" data-dz-message>
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted" id="dropzone-message">
                                Lütfen önce departman ve doküman tipi seçin
                            </h5>
                            <p class="text-muted mb-0" id="dropzone-submessage"></p>
                            <small class="text-muted">Maksimum dosya boyutu: 100MB</small>
                        </div>
                    </div>
                </form>

                <div id="uploadButtonsContainer" class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <button type="button" id="uploadBtn" class="btn btn-primary me-2">
                            <i class="fas fa-upload me-1"></i> Dokümanları Yükle
                        </button>
                        <button type="button" id="clearBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> Temizle
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Dokümanları seçtikten sonra "Dokümanları Yükle" butonuna basın
                    </small>
                </div>

                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-4" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Yükleme İlerlemesi</span>
                        <span id="progressText" class="text-muted">0%</span>
                    </div>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="progressStatus" class="text-muted small mt-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>

        let myDropzone;
        let currentDepartmentScope = null;
        const MAX_UPLOAD_PROGRESS = 95;

        $(document).ready(async function () {
            initializeDropzone();
            await initializeDepartmentSelect();
            await initializeCompanySelect();
            checkDropzoneStatus();
            initializeTemporaryCheckbox();
        });

        async function initializeDepartmentSelect() {
            try {
                const response = await $.ajax({
                    url: '/departman/liste',
                    type: 'GET',
                    dataType: 'json'
                });
                if (response?.isSuccess && response.data) {
                    $('#department-select').empty().append('<option value="">Departman seçin</option>');
                    response.data.forEach(department => {
                        $('#department-select').append(`<option value="${department.id}">${department.name}</option>`);
                    });
                }
                $('#department-select').select2({
                    placeholder: 'Departman seçin',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });
                $('#department-select').on('change', async function () {
                    const departmentId = $(this).val();

                    // Reset other selects
                    $('#department-duty-select').val(null).trigger('change');
                    $('#company-select').val(null).trigger('change');
                    $('#document-type-select').val(null).trigger('change');
                    $('#target-select').val(null).trigger('change');

                    if (departmentId) {
                        await initializeDepartmentDutySelect(departmentId);
                    } else {
                        await initializeDepartmentDutySelect(null);
                        await initializeDocumentTypeSelect(null);
                        await initializeTargetSelect(null);
                    }

                    checkDropzoneStatus();
                });
            } catch (error) {
                console.error('Departman listesi yüklenirken hata:', error);
                toastr.error('Departman listesi yüklenirken hata oluştu', 'Hata!');
            }
        }
            async function initializeDepartmentDutySelect(departmentId) {
            try {
                  if (!departmentId) {
                    resetSelect('#department-duty-select', 'Departman görevi seçin');
                    return;
                }
                const response = await $.ajax({
                    url: `/departman/${departmentId}/gorev-liste`,
                    type: 'GET',
                    dataType: 'json'
                });

                if (response?.isSuccess && response.data) {
                    $('#department-duty-select').empty().append('<option value="">Departman görevi seçin</option>');
                    response.data.forEach(duty => {
                        $('#department-duty-select').append(`<option data-scope=${duty.scope} value="${duty.id}">${duty.name}</option>`);
                    });
                }

                $('#department-duty-select').select2({
                    placeholder: 'Departman görevi seçin',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });

                $('#department-duty-select').on('change', async function () {
                    const departmentDutyId = $(this).val();
                    const scope = $(this).find(':selected').data('scope');

                    // Reset other selects
                    $('#company-select').val(null).trigger('change');
                    $('#document-type-select').val(null).trigger('change');
                    $('#target-select').val(null).trigger('change');

                    if (departmentDutyId) {
                        await initializeDocumentTypeSelect(departmentDutyId);
                        await initializeTargetSelect(scope);
                        currentDepartmentScope = scope;

                    } else {
                        await initializeDocumentTypeSelect(null);
                        await initializeTargetSelect(null);
                    }

                    checkDropzoneStatus();
                });
            } catch (error) {
                console.error('Departman görevi listesi yüklenirken hata:', error);
                toastr.error('Departman görevi listesi yüklenirken hata oluştu', 'Hata!');
            }
        }
            async function initializeCompanySelect() {
            try {
                
                const response = await $.ajax({
                    url: `/firma/aktif-liste`,
                    type: 'GET',
                    dataType: 'json'
                });

                if (response?.isSuccess && response.data) {
                    response.data.forEach(company => {
                        $('#company-select').append(`<option value="${company.id}">${company.name}</option>`);
                    });
                }

                $('#company-select').select2({
                    placeholder: 'Firma seçin (birden fazla seçilebilir)',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%',
                    multiple: true,
                    closeOnSelect: false
                });

                    $('#company-select').val(null).trigger('change');

            } catch (error) {
                console.error('Firma listesi yüklenirken hata:', error);
                toastr.error('Firma listesi yüklenirken hata oluştu', 'Hata!');
            }
        }
         async function initializeDocumentTypeSelect(departmentDutyId) {
            try {
                  if (!departmentDutyId) {
                    resetSelect('#document-type-select', 'Doküman tipi seçin');
                    return;
                }
                const response = await $.ajax({
                     url: `/dokuman/${departmentDutyId}/tip-liste`,
                        type: 'GET',
                    dataType: 'json'
                });

                if (response?.isSuccess && response.data) {
                    $('#document-type-select').empty().append('<option value="">Doküman tipi seçin</option>');
                    response.data.forEach(docType => {
                        $('#document-type-select').append(`<option data-period="${docType.renewalPeriodInMonths}" value="${docType.id}">${docType.name}</option>`);
                    });
                }

                $('#document-type-select').select2({
                    placeholder: 'Doküman tipi seçin',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });

                $('#document-type-select').on('change', async function () {
                    const docTypeId = $(this).val();
                    const period = $(this).find(':selected').data('period');
                    $('#hasRenewalPeriodCheckbox').prop('checked', false);
                    $('#dateRangeContainer').slideUp();
                    clearDateInputs();
                    if (period != null && period !== "") {
                        $('#hasRenewalPeriodCheckbox').prop('checked', true);
                        initializeDatePickers();
                        $('#dateRangeContainer').slideDown();
                    }
                    checkDropzoneStatus();
                });
            } catch (error) {
                console.error('Doküman tipi listesi yüklenirken hata:', error);
                toastr.error('Doküman tipi listesi yüklenirken hata oluştu', 'Hata!');
            }
        }

          async function initializeTargetSelect(scope) {
            try {

                if (!scope) {
                    resetSelect('#target-select', 'Hedef seçin');
                    return;
                }
                const departmentDutyId = $("#department-duty-select").val();
                let url = '';
                let placeholder = 'Hedef seçin';
                // Scope'a göre URL ve placeholder belirleme
                if (scope === 1) {
                    url = `/kullanici/departman-gorev/${departmentDutyId}`;
                } else if (scope === 2) {
                    url = `/ekipman/aktif-liste`;
                } else if (scope === 3) {
                    // Scope 3 için sadece placeholder ayarla, istek atma
                    $('#target-select').empty().append('<option value="">Firma</option>');
                    $('#target-select').select2({
                        placeholder: 'Firma olduğu için hedef seçmeye gerek yok',
                        theme: 'bootstrap-5',
                        allowClear: true,
                        width: '100%'
                    });
                    return;
                }

                // Scope 1 veya 2 için API isteği at
                const response = await $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json'
                });

                if (response?.isSuccess && response.data) {
                    $('#target-select').empty().append(`<option value="">${placeholder}</option>`);
                    response.data.forEach(target => {
                      const displayName = scope === 1 ? target.fullName : target.name;

                        $('#target-select').append(`<option value="${target.id}">${displayName}</option>`);
                    });
                }

                $('#target-select').select2({
                    placeholder: placeholder,
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });

            } catch (error) {
                console.error('Hedef listesi yüklenirken hata:', error);
                toastr.error('Hedef listesi yüklenirken hata oluştu', 'Hata!');
            }
        }

        function resetSelect(selector, placeholder) {
            $(selector).empty().append(`<option value="">${placeholder}</option>`);
            initSelect(selector, placeholder);
        }

        function initSelect(selector, placeholder, disabled = false) {
            $(selector).select2({
                placeholder,
                theme: 'bootstrap-5',
                allowClear: true,
                width: '100%',
                disabled
            });
        }

        function checkDropzoneStatus() {
            const departmentId = $("#department-select").val();
            const departmentDutyId = $("#department-duty-select").val();
            const documentTypeId = $("#document-type-select").val();
            const isEnabled = departmentId && departmentDutyId && documentTypeId;

            if (myDropzone) {
                if (isEnabled) {
                    myDropzone.enable();
                    $("#fileUploadForm").removeClass("dz-disabled");
                    $("#dropzone-message").text("Dokümanlarınızı buraya sürükleyip bırakın");
                    $("#dropzone-submessage").html("veya <strong>tıklayarak</strong> dosya seçin");
                } else {
                    myDropzone.disable();
                    $("#fileUploadForm").addClass("dz-disabled");
                    $("#dropzone-message").text("Lütfen önce departman, görev ve doküman tipi seçin");
                    $("#dropzone-submessage").text("");
                }
            }
        }

        function initializeDropzone() {
            Dropzone.autoDiscover = false;

            myDropzone = new Dropzone("#fileUploadForm", {
                url: "/dosya/yukle",
                method: "post",
                paramName: "files",
                maxFilesize: 100,
                maxFiles: 5,
                acceptedFiles: "image/*,application/pdf,.doc,.docx,.txt,.xlsx,.xls",
                addRemoveLinks: true,
                dictDefaultMessage: "",
                dictRemoveFile: "Kaldır",
                dictCancelUpload: "İptal",
                dictUploadCanceled: "Yükleme iptal edildi",
                dictInvalidFileType: "Bu dosya türü desteklenmiyor",
                dictFileTooBig: "Dosya çok büyük ({{filesize}}MB). Maksimum: {{maxFilesize}}MB",
                dictMaxFilesExceeded: "Maksimum {{maxFiles}} dosya yükleyebilirsiniz",
                autoProcessQueue: false,
                uploadMultiple: false,
                parallelUploads: 1,
                disabled: true,

                init: function () {
                    const dropzone = this;
                    dropzone.disable();
                    $("#fileUploadForm").addClass("dz-disabled");

                    this.on("addedfile", function (file) {
                        const targetDepartmentId = $("#department-select").val();
                        const targetDepartmentDutyId = $("#department-duty-select").val();
                        const documentTypeId = $("#document-type-select").val();

                        if (!targetDepartmentId || !documentTypeId || !targetDepartmentDutyId) {
                            toastr.warning("Lütfen önce departman, görev ve doküman tipi seçin!", 'Uyarı!');
                            dropzone.removeFile(file);
                            return;
                                        }
                        file.previewElement.addEventListener("click", function(e) {
                                 // Remove button'a tıklanmışsa önizleme açma
                                 if (e.target.classList.contains('dz-remove')) {
                                     return;
                                 }
                                 // Progress bar, success mark gibi elementlere tıklanmışsa önizleme açma
                                 if (e.target.classList.contains('dz-progress') ||
                                    e.target.classList.contains('dz-success-mark') ||
                                    e.target.classList.contains('dz-error-mark') ||
                                    e.target.classList.contains('dz-upload') ||
                                    e.target.classList.contains('dz-progress-bar')) {
                                    return;
                                }
                                 previewFile(file);
                             });

                             // Hover efekti için cursor ekle
                           $(file.previewElement).attr('data-preview', 'true');

                             updateUploadButtonsVisibility();
                    });

                    this.on("removedfile", function (file) {
                        if (dropzone.files.length === 0) {
                            hideProgress();
                            updateUploadButtonsVisibility();
                        }
                    });

                    this.on("success", function (file, response) {
                        if (response?.success) {
                            toastr.success("Dosyalar başarıyla yüklendi", 'Başarılı!');
                        } else {
                            toastr.error(response?.message || "Yükleme başarısız", 'Hata!');
                        }

                        updateProgress(100);
                        setProgressStatus('İşlem tamamlandı.');
                        hideProgress();

                        if (typeof filesTable !== 'undefined' && filesTable.ajax) {
                            filesTable.ajax.reload(null, false);
                        }

                        setTimeout(() => dropzone.removeAllFiles(), 2000);
                    });

                    this.on("error", function (file, errorMessage) {
                        const message = typeof errorMessage === 'string' ? errorMessage :
                            errorMessage?.message || "Yükleme sırasında hata oluştu";
                        toastr.error(message, 'Hata!');
                        hideProgress();
                        setProgressStatus('Hata oluştu.');
                    });

                    this.on("totaluploadprogress", function (uploadProgress) {
                        const clampedProgress = Math.min(uploadProgress, MAX_UPLOAD_PROGRESS);
                        updateProgress(clampedProgress);
                        setProgressStatus(clampedProgress >= MAX_UPLOAD_PROGRESS
                            ? 'Sunucu yanıtı bekleniyor...'
                            : 'Dosyalar yükleniyor...');
                    });

                    $("#uploadBtn").on("click", processAllFiles);
                    $("#clearBtn").on("click", function () {
                        dropzone.removeAllFiles(true);
                        hideProgress();
                        updateUploadButtonsVisibility();
                    });

                    function processAllFiles() {
                        const documentTypeId = $("#document-type-select").val();
                        const targetDepartmentId = $("#department-select").val();
                        const targetDepartmentDutyId = $("#department-duty-select").val();
                        const targetCompanyIds = $("#company-select").val();
                        const targetId = $("#target-select").val();

                        if (!targetDepartmentId) {
                            toastr.warning("Lütfen departman seçin!", 'Uyarı!');
                            return;
                        }
                        if (!targetDepartmentDutyId) {
                            toastr.warning("Lütfen departman görevi seçin!", 'Uyarı!');
                            return;
                        }
                        if (!documentTypeId) {
                            toastr.warning("Lütfen doküman tipini seçin!", 'Uyarı!');
                            return;
                        }

                        // Scope kontrolü - kullanıcı/ekipman/proje bazlı ise target ID zorunlu
                        if (currentDepartmentScope !== 3 && !targetId) {
                            const targetName = currentDepartmentScope === 1 ? 'kullanıcı' :
                                currentDepartmentScope === 2 ? 'ekipman' :
                                    currentDepartmentScope === 4 ? 'proje' : '';
                            toastr.warning(`Lütfen ${targetName} seçin!`, 'Uyarı!');
                            return;
                        }

                        const files = dropzone.getAcceptedFiles();
                        if (files.length === 0) {
                            toastr.warning("Lütfen en az bir dosya seçin!", 'Uyarı!');
                            return;
                        }

                        uploadFilesManually(files, targetDepartmentId,targetDepartmentDutyId,targetCompanyIds, documentTypeId, targetId);
                    }

                    function uploadFilesManually(files, targetDepartmentId,targetDepartmentDutyId,targetCompanyIds, documentTypeId, targetId) {
                        const formData = new FormData();
                        const token = $('input[name="__RequestVerificationToken"]').val();
                        formData.append("__RequestVerificationToken", token);

                        const hasRenewalPeriod = $('#hasRenewalPeriodCheckbox').is(':checked');
                        let startDate = null;
                        let endDate = null;

                        if (hasRenewalPeriod) {
                            const startDateValue = $('#start-date').data('value');
                            const endDateValue = $('#end-date').data('value');

                            if (startDateValue && endDateValue) {
                                startDate = startDateValue;
                                endDate = endDateValue;
                            }
                        }

                        files.forEach((file, index) => {
                            formData.append(`[${index}].FormFile`, file);
                            formData.append(`[${index}].DocumentTypeId`, documentTypeId);
                            formData.append(`[${index}].TargetDepartmentId`, targetDepartmentId);
                            formData.append(`[${index}].TargetDepartmentDutyId`, targetDepartmentDutyId);
                            formData.append(`[${index}].HasRenewalPeriod`, hasRenewalPeriod);
                             if (targetCompanyIds && Array.isArray(targetCompanyIds)) {
                                targetCompanyIds.forEach((companyId, companyIndex) => {
                                    formData.append(`[${index}].TargetCompanyIds[${companyIndex}]`, companyId);
                                });
                            } else if (targetCompanyIds) {
                                formData.append(`[${index}].TargetCompanyIds[0]`, targetCompanyIds);
                            }
                            if (targetId) {
                                if (currentDepartmentScope === 1) {
                                    formData.append(`[${index}].TargetUserId`, targetId);
                                } else if (currentDepartmentScope === 2) {
                                    formData.append(`[${index}].TargetEquipmentId`, targetId);
                                }
                            }

                            if (hasRenewalPeriod && startDate && endDate) {
                                formData.append(`[${index}].StartDate`, startDate);
                                formData.append(`[${index}].EndDate`, endDate);
                            }
                        });

                        showProgress();
                        $("#uploadBtn").prop('disabled', true).text('Yükleniyor...');

                        $.ajax({
                            url: '/dosya/yukle',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            xhr: function () {
                                const xhr = new window.XMLHttpRequest();
                                xhr.upload.addEventListener("progress", function (evt) {
                                    if (evt.lengthComputable) {
                                        const percentComplete = (evt.loaded / evt.total) * 100;
                                        const clampedProgress = Math.min(percentComplete, MAX_UPLOAD_PROGRESS);
                                        updateProgress(clampedProgress);
                                        setProgressStatus(clampedProgress >= MAX_UPLOAD_PROGRESS
                                            ? 'Sunucu yanıtı bekleniyor...'
                                            : 'Dosyalar yükleniyor...');
                                    }
                                }, false);
                                xhr.upload.addEventListener("load", function () {
                                    updateProgress(MAX_UPLOAD_PROGRESS);
                                    setProgressStatus('Sunucu yanıtı bekleniyor...');
                                });
                                return xhr;
                            },
                            success: function (response) {
                                const message = response?.success ?
                                    `${files.length} dosya başarıyla yüklendi!` :
                                    response?.message || 'Dosyalar başarıyla yüklendi!';

                                toastr.success(message, 'Başarılı!');
                                updateProgress(100);
                                setProgressStatus('İşlem tamamlandı.');

                                if (typeof filesTable !== 'undefined' && filesTable.ajax) {
                                    filesTable.ajax.reload(null, false);
                                }

                                setTimeout(() => {
                                    dropzone.removeAllFiles(true);
                                    updateUploadButtonsVisibility();
                                }, 2000);
                            },
                            error: function (xhr) {
                                let errorMessage = 'Yükleme sırasında hata oluştu!';

                                try {
                                    const errorResponse = JSON.parse(xhr.responseText);
                                    if (errorResponse.message) {
                                        errorMessage = errorResponse.message;
                                    } else if (errorResponse.errors?.length > 0) {
                                        errorMessage = errorResponse.errors.join(', ');
                                    }
                                } catch (e) {
                                    errorMessage = xhr.responseText || errorMessage;
                                }

                                toastr.error(errorMessage, 'Hata!');
                                setProgressStatus('Hata oluştu.');
                            },
                            complete: function () {
                                hideProgress();
                                $("#uploadBtn").prop('disabled', false).text('Dokümanları Yükle');
                            }
                        });
                    }
                }
            });
        }

        function updateUploadButtonsVisibility() {
            const hasFiles = myDropzone?.files.length > 0;
            $("#uploadButtonsContainer").toggle(hasFiles);
        }

        function initializeTemporaryCheckbox() {
            $('#hasRenewalPeriodCheckbox').on('change', function () {
                if ($(this).is(':checked')) {
                    initializeDatePickers();
                    $('#dateRangeContainer').slideDown();
                } else {
                    $('#dateRangeContainer').slideUp();
                    clearDateInputs();
                }
            });
        }

        function initializeDatePickers() {
            setupSingleDatePicker('#start-date');
            setupSingleDatePicker('#end-date');
        }

        function setupSingleDatePicker(selector) {
            if ($(selector).data('hasPicker')) {
                return;
            }

            $(selector).daterangepicker({
                locale: turkishLocale,
                singleDatePicker: true,
                autoUpdateInput: false,
                autoApply: true,
                showDropdowns: true,
                opens: 'left'
            });

            $(selector).on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD/MM/YYYY'));
                $(this).data('value', picker.startDate.format('YYYY-MM-DD'));
            });

            $(selector).on('cancel.daterangepicker', function () {
                $(this).val('').removeData('value');
            });

            $(selector).data('hasPicker', true);
        }

        function clearDateInputs() {
            $('#start-date, #end-date').each(function () {
                $(this).val('').removeData('value');
            });
        }

        $(document).on('click', '.date-picker-trigger', function () {
            const target = $(this).data('target');
            if (target) {
                $(target).trigger('focus');
            }
        });

        function showProgress() {
            $("#uploadProgress").show();
            updateProgress(0);
            setProgressStatus('Dosyalar yüklenmeye hazırlanıyor...');
        }

        function hideProgress() {
            $("#uploadProgress").hide();
            updateProgress(0);
            setProgressStatus('');
        }

        function updateProgress(progress) {
            const percentage = Math.round(progress);
            $("#progressBar").css("width", percentage + "%");
            $("#progressText").text(percentage + "%");
        }

        function setProgressStatus(message) {
            $("#progressStatus").text(message || '');
        }

    </script>
}