@{
    ViewData["Title"] = "Doküman Kontrol";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

}

@Html.AntiForgeryToken()

<!-- Files List -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-file-shield me-2"></i>
                    Doküman Kontrol
                </h5>
                <div class="file-type-section">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="department-select" class="form-label">Departman</label>
                            <select id="department-select" class="form-select">
                                <option value="">Departman seçin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="department-duty-select" class="form-label">Departman Görev</label>
                            <select id="department-duty-select" class="form-select">
                            </select>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label for="document-type-select" class="form-label">Doküman Tipi</label>
                            <select id="document-type-select" class="form-select">
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="target-select" class="form-label">Hedef</label>
                            <select id="target-select" class="form-select">
                            </select>
                        </div>
                    </div>

                    <div class="row mt-2">

                        <div class="col-md-6">
                            <label for="company-select" class="form-label">Firma</label>
                            <select id="company-select" class="form-select">
                            </select>
                        </div>
                    </div>

                </div>

                <div id="tableContainer" class="table-responsive mt-5">
                    <table id="filesTable" class="table table-striped table-hover display" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>DÖKÜMAN<br />TİPİ</th>
                                <th>FİRMA</th>
                                <th>HEDEF</th>
                                <th>YENİLEME<br />SÜRESİ (AY)</th>
                                <th>YÜKLENDİ<br />Mİ?</th>
                                <th>SÜRESİ<br />GEÇTİ<br />Mİ?</th>
                                <th>BAŞLANGIÇ<br />TARİHİ</th>
                                <th>BİTİŞ<br />TARİHİ</th>
                                <th>YÜKLEME<br />TARİHİ</th>
                                <th>İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        const DEBOUNCE_DELAY = 400;
        let filesTable;
        let currentDepartmentScope = null;
        let tableLoadTimeout = null;

        $(document).ready(async function () {
            await initializeDepartmentSelect();
            await initializeCompanySelect();
        });

        async function initializeDepartmentSelect() {
             try {
                 const response = await $.ajax({
                     url: '/departman/liste',
                     type: 'GET',
                     dataType: 'json'
                 });
                 if (response?.isSuccess && response.data) {
                     $('#department-select').empty().append('<option value="">Departman seçin</option>');
                     response.data.forEach(department => {
                         $('#department-select').append(`<option value="${department.id}">${department.name}</option>`);
                     });
                 }
                 $('#department-select').select2({
                     placeholder: 'Departman seçin',
                     theme: 'bootstrap-5',
                     allowClear: true,
                     width: '100%'
                 });
                 $('#department-select').on('change', async function () {
                     const departmentId = $(this).val();

                     // Reset other selects
                     $('#department-duty-select').val(null).trigger('change');
                     $('#company-select').val(null).trigger('change');
                     $('#target-select').val(null).trigger('change');

                     if (departmentId) {
                         await initializeDepartmentDutySelect(departmentId);
                     } else {
                         await initializeDepartmentDutySelect(null);
                         await initializeTargetSelect(null);
                     }

                     debouncedCheckAndLoadTable();
                 });
             } catch (error) {
                 console.error('Departman listesi yüklenirken hata:', error);
                 toastr.error('Departman listesi yüklenirken hata oluştu', 'Hata!');
             }
         }
            async function initializeDocumentTypeSelect(departmentDutyId) {
            try {
                  if (!departmentDutyId) {
                    resetSelect('#document-type-select', 'Doküman tipi seçin');
                    return;
                }
                const response = await $.ajax({
                     url: `/dokuman/${departmentDutyId}/tip-liste`,
                        type: 'GET',
                    dataType: 'json'
                });

                if (response?.isSuccess && response.data) {
                    $('#document-type-select').empty().append('<option value="">Doküman tipi seçin</option>');
                    response.data.forEach(docType => {
                        $('#document-type-select').append(`<option data-period="${docType.renewalPeriodInMonths}" value="${docType.id}">${docType.name}</option>`);
                    });
                }

                $('#document-type-select').select2({
                    placeholder: 'Doküman tipi seçin',
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%'
                });

                $('#document-type-select').on('change', async function () {
                    const docTypeId = $(this).val();
                                     debouncedCheckAndLoadTable();

                });
            } catch (error) {
                console.error('Doküman tipi listesi yüklenirken hata:', error);
                toastr.error('Doküman tipi listesi yüklenirken hata oluştu', 'Hata!');
            }
        }
         async function initializeDepartmentDutySelect(departmentId) {
             try {
                   if (!departmentId) {
                     resetSelect('#department-duty-select', 'Departman görevi seçin');
                     return;
                 }
                 const response = await $.ajax({
                     url: `/departman/${departmentId}/gorev-liste`,
                     type: 'GET',
                     dataType: 'json'
                 });

                 if (response?.isSuccess && response.data) {
                     $('#department-duty-select').empty().append('<option value="">Departman görevi seçin</option>');
                     response.data.forEach(duty => {
                         $('#department-duty-select').append(`<option data-scope=${duty.scope} value="${duty.id}">${duty.name}</option>`);
                     });
                 }

                 $('#department-duty-select').select2({
                     placeholder: 'Departman görevi seçin',
                     theme: 'bootstrap-5',
                     allowClear: true,
                     width: '100%'
                 });

                 $('#department-duty-select').on('change', async function () {
                     const departmentDutyId = $(this).val();
                     const scope = $(this).find(':selected').data('scope');

                     // Reset other selects
                        $('#company-select').val(null).trigger('change');
                    $('#document-type-select').val(null).trigger('change');
                    $('#target-select').val(null).trigger('change');
                     if (departmentDutyId) {
                        await initializeDocumentTypeSelect(departmentDutyId);
                        await initializeTargetSelect(scope);
                        currentDepartmentScope = scope;

                    } else {
                        await initializeDocumentTypeSelect(null);
                        await initializeTargetSelect(null);
                    }

                 });
             } catch (error) {
                 console.error('Departman görevi listesi yüklenirken hata:', error);
                 toastr.error('Departman görevi listesi yüklenirken hata oluştu', 'Hata!');
             }
         }

        async function initializeCompanySelect() {
             try {
                 const response = await $.ajax({
                     url: `/firma/aktif-liste`,
                     type: 'GET',
                     dataType: 'json'
                 });

                 if (response?.isSuccess && response.data) {
                                          $('#company-select').empty().append('<option value="">Firma seçin</option>');

                     response.data.forEach(company => {
                         $('#company-select').append(`<option value="${company.id}">${company.name}</option>`);
                     });
                 }

                 $('#company-select').select2({
                     placeholder: 'Firma seçin',
                     theme: 'bootstrap-5',
                     allowClear: true,
                     width: '100%'
                 });

                    $('#company-select').on('change', async function () {
                     debouncedCheckAndLoadTable();
                 });

             } catch (error) {
                 console.error('Firma listesi yüklenirken hata:', error);
                 toastr.error('Firma listesi yüklenirken hata oluştu', 'Hata!');
             }
         }

         async function initializeTargetSelect(scope) {
             try {
                 if (!scope) {
                     resetSelect('#target-select', 'Hedef seçin');
                     return;
                 }

                 const departmentDutyId = $("#department-duty-select").val();
                 let url = '';
                 let placeholder = 'Hedef seçin';

                 // Scope'a göre URL ve placeholder belirleme
                 if (scope === 1) {
                     url = `/kullanici/departman-gorev/${departmentDutyId}`;
                 } else if (scope === 2) {
                     url = `/ekipman/aktif-liste`;
                 } else if (scope === 3) {
                     // Scope 3 için sadece placeholder ayarla, istek atma
                     $('#target-select').empty().append('<option value="">Firma</option>');
                     $('#target-select').select2({
                         placeholder: 'Firma olduğu için hedef seçmeye gerek yok',
                         theme: 'bootstrap-5',
                         allowClear: true,
                         width: '100%',
                         disabled: true
                     });

                     // Scope 3 için tablo kontrolü yap
                     debouncedCheckAndLoadTable();
                     return;
                 }

                 // Scope 1 veya 2 için API isteği at
                 const response = await $.ajax({
                     url: url,
                     type: 'GET',
                     dataType: 'json'
                 });

                 if (response?.isSuccess && response.data) {
                     $('#target-select').empty().append(`<option value="">${placeholder}</option>`);
                     response.data.forEach(target => {
                       const displayName = scope === 1 ? target.fullName : target.name;
                         $('#target-select').append(`<option value="${target.id}">${displayName}</option>`);
                     });
                 }

                 $('#target-select').select2({
                     placeholder: placeholder,
                     theme: 'bootstrap-5',
                     allowClear: true,
                     width: '100%'
                 });

                 // Target select change event
                 $('#target-select').on('change', function () {
                     debouncedCheckAndLoadTable();
                 });

             } catch (error) {
                 console.error('Hedef listesi yüklenirken hata:', error);
                 toastr.error('Hedef listesi yüklenirken hata oluştu', 'Hata!');
             }
         }

         function resetSelect(selector, placeholder) {
             $(selector).empty().append(`<option value="">${placeholder}</option>`);
             initSelect(selector, placeholder);
         }

         function initSelect(selector, placeholder, disabled = false) {
             $(selector).select2({
                 placeholder,
                 theme: 'bootstrap-5',
                 allowClear: true,
                 width: '100%',
                 disabled
             });
         }

         // Debounce fonksiyonu
         function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const context = this;
                 clearTimeout(timeout);
                 timeout = setTimeout(() => func.apply(context, args), wait);
             };
         }

         // Debounced tablo yükleme fonksiyonu
         const debouncedCheckAndLoadTable = debounce(function() {
             checkAndLoadTable();
         }, DEBOUNCE_DELAY);

         // Tablo yükleme kontrolü fonksiyonu
             function checkAndLoadTable() {
            const departmentId = $('#department-select').val();
            const departmentDutyId = $('#department-duty-select').val();
            const targetId = $('#target-select').val();
            const documentTypeId = $("#document-type-select").val();
            const scope = currentDepartmentScope;

            // İki senaryo:
            // 1) departmentId + departmentDutyId + documentTypeId varsa -> tüm kayıtlar gelir
            // 2) departmentId + departmentDutyId + targetId varsa (scope 1 veya 3 için) -> tek kayıt gelir
            const canLoadTable = departmentId && departmentDutyId &&
                (documentTypeId || (scope === 1 || scope === 3 ? targetId : true));

            console.log(canLoadTable);

            if (canLoadTable) {
                loadDataTable();
            } else {
                // Tablo varsa yok et
                if (filesTable) {
                    filesTable.destroy();
                    $('#filesTable tbody').empty();
                    filesTable = null;
                }
            }
        }

         // DataTable yükleme fonksiyonu
         function loadDataTable() {
             const departmentId = $('#department-select').val();
             const departmentDutyId = $('#department-duty-select').val();
             const companyId = $('#company-select').val() || '';
             const targetId = $('#target-select').val() || '';
             const documentTypeId = $("#document-type-select").val() || "";

             // URL oluştur
             const url = `/dokuman/kontrol-liste?departmentId=${departmentId}&departmentDutyId=${departmentDutyId}&companyId=${companyId}&targetId=${targetId}&documentTypeId=${documentTypeId}`;

             // Eğer tablo varsa, sadece URL'i güncelle ve yeniden yükle
             if (filesTable) {
                 filesTable.ajax.url(url).load();
             } else {
                 // Tablo yoksa oluştur
                 initializeDataTable(url);
             }
         }

        async function initializeDataTable(url) {
            filesTable = $('#filesTable').DataTable({
                processing: true,
                ajax: {
                    url: url,
                    type: "GET",
                    dataSrc: (json) => json?.isSuccess && json.data ? json.data : [],
                    error: (xhr, error, thrown) => {
                        console.error('DataTables AJAX error:', error, thrown);
                        let errorMessage = 'Veriler yüklenirken hata oluştu';

                        if (error === 'timeout') {
                            errorMessage = 'İstek zaman aşımına uğradı. Lütfen tekrar deneyin.';
                        } else if (xhr.responseJSON?.message) {
                            errorMessage += ': ' + xhr.responseJSON.message;
                        }

                        toastr.error(errorMessage);
                    }
                },
                columns: [
                    { data: null, width: "5%", orderable: false, className: "text-center", render: () => '' },
                    { data: "documentTypeName", render: (data) => data || '' },
                    { data: "companyName", render: (data) => data || '' },
                    { data: "targetFullName", render: (data) => data || '' },
                    { data: "renewalPeriodInMonths", render: (data) => data || '-' },
                    {
                        data: "isUploaded",
                        render: (data) => data ?
                            '<span class="badge bg-success">Evet</span>' :
                            '<span class="badge bg-danger">Hayır</span>'
                    },
                    {
                        data: "isExpired",
                        render: (data, type, row) => {
                            if (row.isNeverUploaded) {
                                return '<span class="badge bg-danger">Hiç Doküman Yüklenmedi</span>';
                            }
                            return data ?
                                '<span class="badge bg-warning">Evet</span>' :
                                '<span class="badge bg-success">Hayır</span>';
                        }
                    },
                    { data: "currentFileStartDate", render: (data) => data ? new Date(data).toLocaleDateString('tr-TR') : '-' },
                    { data: "currentFileEndDate", render: (data) => data ? new Date(data).toLocaleDateString('tr-TR') : '-' },
                    { data: "currentFileCreatedDate", render: (data) => data ? new Date(data).toLocaleDateString('tr-TR') : '' },
                    {
                        data: null,
                        width: "10%",
                        orderable: false,
                        className: "text-center",
                        render: (data, type, row) => {
                            if (!row.currentFileId) return "";
                            return `
                                <div class="btn-group btn-group-sm" role="group">
                                    <a class="btn btn-outline-primary btn-sm" href="/dosya/indir/${row.currentFileId}" title="İndir" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteFile('${row.currentFileId}')" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>`;
                        }
                    }
                ],
                language: { url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json' },
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                pageLength: 10,
                responsive: true,
                searchDelay: 300,
                order: [[6, "asc"]],
                drawCallback: function () {
                    const api = this.api();
                    const pageInfo = api.page.info();
                    api.column(0, { page: 'current' }).nodes().each((cell, i) => {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });
                    $('[title]').tooltip();
                }
            });
        }

        async function deleteFile(fileId) {
            try {
                const result = await Swal.fire({
                    title: 'Evrağı Sil',
                    text: 'Bu evrağı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-trash"></i> Evet, Sil',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            return await $.ajax({
                                url: `/dosya/${fileId}`,
                                type: 'DELETE',
                                contentType: 'application/json'
                            });
                        } catch (error) {
                            let errorMessage = 'Silme başarısız';
                            if (error.responseJSON?.message) {
                                errorMessage = error.responseJSON.message;
                            } else if (error.responseJSON?.errors?.length > 0) {
                                errorMessage = error.responseJSON.errors.join(', ');
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;
                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Evrak başarıyla silindi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    filesTable.ajax.reload(null, false);
                }
            } catch (error) {
                console.error('Silme hatası:', error);
            }
        }
    </script>
}