@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Proje Yönetimi";
}

@section Styles {
    <link href="~/theme/assets/plugins/DataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <style>
        .form-control-color {
            max-width: 150px !important;
        }
    </style>
}

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-tools me-2"></i>
                    Proje Yönetimi
                </h5>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#createProjectModal">
                    <i class="fas fa-plus me-2"></i>Proje Ekle
                </button>
                <br />
                <br />
                <div class="table-responsive">
                    <table id="projectsTable" class="table table-striped table-hover display" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>PROJE ADI</th>
                                <th>BAŞLANGIÇ<br />TARİHİ</th>
                                <th>BİTİŞ<br />TARİHİ</th>
                                <th>ATANAN<br />KULLANICILAR</th>
                                <th>ATANAN<br />EKİPMANLAR</th>
                                <th>AKTİF Mİ</th>
                                <th>İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- DataTables will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1" aria-labelledby="createProjectModalLabel"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Proje Ekleme Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form class="needs-validation" novalidate id="createProjectForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="txtCName" class="form-label">Proje Adı</label>
                            <input type="text" class="form-control" id="txtCName" required>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir proje adı giriniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="c-date-project" class="form-label">Proje Süresi</label>
                            <div class="input-group">

                                <input type="text" class="form-control date-project" id="c-date-project" required
                                       placeholder="Başlangıç - Bitiş"> <span class="input-group-text">
                                    <i class="fas fa-calendar"></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="selectCTargetUsers" class="form-label">Hedef Kullanıcılar</label>
                            <select class="form-select" id="selectCTargetUsers" multiple>
                                <option value="">Yükleniyor...</option>
                            </select>
                            <div class="form-text">
                                Projeye atanacak kullanıcıları seçin (çoklu seçim yapabilirsiniz)
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="selectCTargetEquipments" class="form-label">Hedef Ekipmanlar</label>
                            <select class="form-select" id="selectCTargetEquipments" multiple>
                                <option value="">Yükleniyor...</option>
                            </select>
                            <div class="form-text">Projeye atanacak ekipmanları seçin (çoklu seçim yapabilirsiniz)</div>
                        </div>
                        <div class="col-md-12">
                            <label for="projectCColorInput" class="form-label">Proje Rengi</label>
                            <input type="color" class="form-control form-control-color" id="projectCColorInput" value="#563d7c" title="Proje rengi seçiniz">
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir proje rengi seçiniz.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-add me-1"></i>Ekle</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Project Modal -->
<div class="modal fade" id="updateProjectModal" tabindex="-1" aria-labelledby="updateProjectModalLabel"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Proje Güncelleme Penceresi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form class="needs-validation" novalidate id="updateProjectForm">
                <div class="modal-body">
                    <input type="hidden" id="txtUId">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="txtUName" class="form-label">Proje Adı</label>
                            <input type="text" class="form-control" id="txtUName" required>
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir proje adı giriniz.</div>
                        </div>
                        <div class="col-md-12">
                            <label for="u-date-project" class="form-label">Proje Süresi</label>
                            <div class="input-group">

                                <input type="text" class="form-control date-project" id="u-date-project" required
                                       placeholder="Başlangıç - Bitiş"> <span class="input-group-text">
                                    <i class="fas fa-calendar"></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="selectUTargetUsers" class="form-label">Hedef Kullanıcılar</label>
                            <select class="form-select" id="selectUTargetUsers" multiple>
                                <option value="">Yükleniyor...</option>
                            </select>
                            <div class="form-text">
                                Projeye atanacak kullanıcıları seçin (çoklu seçim yapabilirsiniz)
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="selectUTargetEquipments" class="form-label">Hedef Ekipmanlar</label>
                            <select class="form-select" id="selectUTargetEquipments" multiple>
                                <option value="">Yükleniyor...</option>
                            </select>
                            <div class="form-text">Projeye atanacak ekipmanları seçin (çoklu seçim yapabilirsiniz)</div>
                        </div>
                        <div class="col-md-12">
                            <label for="projectUColorInput" class="form-label">Proje Rengi</label>
                            <input type="color" class="form-control form-control-color" id="projectUColorInput" title="Proje rengi seçiniz">
                            <div class="valid-feedback">İyi görünüyor!</div>
                            <div class="invalid-feedback">Geçerli bir proje rengi seçiniz.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-pen me-1"></i>Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/theme/assets/plugins/DataTables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        let projectsTable;

        $(document).ready(async function () {
            setupEventListeners();

            await initializeDataTable();
            await initializeSelects();

            $('.date-project').daterangepicker({
                locale: turkishLocale,
                opens: 'left',
                autoUpdateInput: false,
                autoApply: true

            });

            $('#c-date-project').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
            });

            $('#c-date-project').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
            });
            $('#u-date-project').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
            });

            $('#u-date-project').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
            });
            $('.fa-calendar').parent().on('click', function () {
                $(this).closest('.input-group').find('.date-project').focus();
            });
        });

        async function initializeDataTable() {
            projectsTable = $('#projectsTable').DataTable({
                "processing": true,
                "ajax": {
                    "url": "/proje/liste",
                    "type": "GET",
                    "dataSrc": function (json) {
                        if (json) {
                            return json;
                        }
                        return [];
                    },
                    "error": function (xhr, error, code) {
                        console.error('DataTables AJAX error:', error);
                        let errorMessage = 'Veriler yüklenirken hata oluştu';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ': ' + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ': ' + xhr.responseText;
                            }
                        } catch (e) {
                            errorMessage += ': ' + error;
                        }

                        showToast(errorMessage, 'error', 'Hata');
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "width": "5%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            return '';
                        }
                    },
                    {
                        "data": "name",
                        "render": function (data) {
                            return data ? `<strong>${data}</strong>` : '';
                        }
                    },
                    {
                        "data": "startDate",
                        "render": function (data) {
                            return data ? new Date(data).toLocaleDateString('tr-TR') : '';
                        }
                    },
                    {
                        "data": "endDate",
                        "render": function (data) {
                            return data ? new Date(data).toLocaleDateString('tr-TR') : '';
                        }
                    },
                    {
                        "data": "targetUsers",
                        "width": "15%",
                        "orderable": false,
                        "render": function (data, type, row) {
                            if (!data || !Array.isArray(data) || data.length === 0) {
                                return '<span class="text-muted">-</span>';
                            }
                            const usersHtml = data.map(user =>
                                `<span class="badge bg-info me-1 mb-1">${user}</span>`
                            ).join('');
                            return usersHtml;
                        }
                    },
                    {
                        "data": "targetEquipments",
                        "width": "15%",
                        "orderable": false,
                        "render": function (data, type, row) {
                            if (!data || !Array.isArray(data) || data.length === 0) {
                                return '<span class="text-muted">-</span>';
                            }
                            const equipmentsHtml = data.map(equipment =>
                                `<span class="badge bg-secondary me-1 mb-1">${equipment}</span>`
                            ).join('');
                            return equipmentsHtml;
                        }
                    },
                    {
                        "data": "isActive",
                        "width": "10%",
                        "className": "text-center",
                        "render": function (data) {
                            return data ?
                                '<span class="badge bg-success">Evet</span>' :
                                '<span class="badge bg-danger">Hayır</span>';
                        }
                    },
                    {
                        "data": null,
                        "width": "10%",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {

                            const statusButton = row.isActive
                                ? `<button type="button" class="btn btn-outline-success btn-sm"
                                                                        onclick="deactivateProject('${row.id}')" title="Pasifleştir">
                                                                            <i class="fas fa-toggle-on"></i>
                                                                        </button>`
                                : `<button type="button" class="btn btn-outline-secondary btn-sm"
                                                                        onclick="activateProject('${row.id}')" title="Aktifleştir">
                                                                            <i class="fas fa-toggle-off"></i>
                                                                       </button>`;
                            return `
                                                                            <div class="btn-group btn-group-sm" role="group">
                                                                             <button type="button" class="btn btn-outline-warning btn-sm"
                                                                               onclick="loadProjectForEdit('${row.id}')" title="Düzenle">
                                                                              <i class="fas fa-edit"></i>
                                                                             </button>
                                                                             ${statusButton}
                                                                             <button type="button" class="btn btn-outline-danger btn-sm"
                                                                               onclick="deleteProject('${row.id}')" title="Sil">
                                                                              <i class="fas fa-trash"></i>
                                                                             </button>
                                                                            </div>
                                                                       `;
                        }
                    }
                ],
                "language": {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/tr.json'
                },
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "pageLength": 10,
                "responsive": true,
                "searchDelay": 300,
                "order": [[2, "asc"]],
                "drawCallback": function () {
                    var api = this.api();
                    var pageInfo = api.page.info();

                    api.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });
                    $('[title]').tooltip();
                }
            });
        }

        function setupEventListeners() {
            $('#createProjectForm').on('submit', function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    createProject();
                }
                $(this).addClass('was-validated');
            });

            $('#updateProjectForm').on('submit', function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    updateProject();
                }
                $(this).addClass('was-validated');
            });

            // Clear forms when modals hide
            $('#createProjectModal').on('hidden.bs.modal', function () {
                $('#createProjectForm')[0].reset();
                $('#createProjectForm').removeClass('was-validated');
                $('#selectCTargetUsers').val(null).trigger('change');
                $('#selectCTargetEquipments').val(null).trigger('change');
            });

            $('#updateProjectModal').on('hidden.bs.modal', function () {
                $('#updateProjectForm')[0].reset();
                $('#updateProjectForm').removeClass('was-validated');
                $('#selectUTargetUsers').val(null).trigger('change');
                $('#selectUTargetEquipments').val(null).trigger('change');
            });
        }

        async function initializeSelects() {
            try {
                await initializeUserSelects();
                await initializeEquipmentSelects();
            } catch (error) {
                console.error('Select initialization error:', error);
                handleError(error, 'Select alanları yüklenirken hata oluştu');
            }
        }

        async function initializeUserSelects() {
            try {
                const response = await makeRequest('/kullanici/liste', 'GET');

                if (response && Array.isArray(response)) {
                    // Create modal select
                    $('#selectCTargetUsers').empty();
                    response.forEach(user => {
                        $('#selectCTargetUsers').append(`<option value="${user.id}">${user.fullNameWithExp || user.fullName}</option>`);
                    });

                    // Update modal select
                    $('#selectUTargetUsers').empty();
                    response.forEach(user => {
                        $('#selectUTargetUsers').append(`<option value="${user.id}">${user.fullNameWithExp || user.fullName}</option>`);
                    });
                }

                // Initialize select2 for create modal
                $('#selectCTargetUsers').select2({
                    placeholder: 'Kullanıcı seçin',
                    theme: 'bootstrap-5',
                    width: '100%',
                    multiple: true,
                    allowClear: true
                });

                // Initialize select2 for update modal
                $('#selectUTargetUsers').select2({
                    placeholder: 'Kullanıcı seçin',
                    theme: 'bootstrap-5',
                    width: '100%',
                    multiple: true,
                    allowClear: true
                });
            } catch (error) {
                console.error('Kullanıcı listesi yüklenirken hata:', error);
                handleError(error, 'Kullanıcı listesi yüklenirken hata oluştu');
            }
        }

        async function initializeEquipmentSelects() {
            try {
                const response = await makeRequest('/ekipman/aktif-liste', 'GET');

                if (response && Array.isArray(response)) {
                    // Create modal select
                    $('#selectCTargetEquipments').empty();
                    response.forEach(equipment => {
                        $('#selectCTargetEquipments').append(`<option value="${equipment.id}">${equipment.name}</option>`);
                    });

                    // Update modal select
                    $('#selectUTargetEquipments').empty();
                    response.forEach(equipment => {
                        $('#selectUTargetEquipments').append(`<option value="${equipment.id}">${equipment.name}</option>`);
                    });
                }

                // Initialize select2 for create modal
                $('#selectCTargetEquipments').select2({
                    placeholder: 'Ekipman seçin',
                    theme: 'bootstrap-5',
                    width: '100%',
                    multiple: true,
                    allowClear: true
                });

                // Initialize select2 for update modal
                $('#selectUTargetEquipments').select2({
                    placeholder: 'Ekipman seçin',
                    theme: 'bootstrap-5',
                    width: '100%',
                    multiple: true,
                    allowClear: true
                });
            } catch (error) {
                console.error('Ekipman listesi yüklenirken hata:', error);
                handleError(error, 'Ekipman listesi yüklenirken hata oluştu');
            }
        }

        async function createProject() {
            var picker = $('#c-date-project').data('daterangepicker');
            var startDate = picker.startDate.format('YYYY-MM-DD');
            var endDate = picker.endDate.format('YYYY-MM-DD');

            const projectColor = $('#projectCColorInput').val();
            const targetUserIds = $('#selectCTargetUsers').val();
            const targetEquipmentIds = $('#selectCTargetEquipments').val();

            const projectData = {
                name: $('#txtCName').val().trim(),
                startDate: startDate,
                endDate: endDate,
                projectColor: projectColor,
                targetUserIds: targetUserIds && targetUserIds.length > 0 ? targetUserIds : null,
                targetEquipmentIds: targetEquipmentIds && targetEquipmentIds.length > 0 ? targetEquipmentIds : null
            };

            try {
                await makeRequest('/proje', 'POST', projectData);
                showToast('Proje başarıyla oluşturuldu.', 'success', 'Başarılı!');
                $('#createProjectModal').modal('hide');
                projectsTable.ajax.reload();
            } catch (error) {
                console.error('Create project error:', error);
                handleError(error, 'Proje oluşturulurken hata oluştu.');
            }
        }

        async function loadProjectForEdit(projectId) {
            try {
                const response = await makeRequest(`/proje/${projectId}`, 'GET');

                if (response) {
                    $('#txtUId').val(response.id);
                    $('#txtUName').val(response.name);
                    $('#projectUColorInput').val(response.projectColor);
                    if ($('#u-date-project').data('daterangepicker')) {
                        const startDate = moment(response.startDate);
                        const endDate = moment(response.endDate);

                        $('#u-date-project').val(startDate.format('DD/MM/YYYY') + "-" + endDate.format('DD/MM/YYYY'));
                        $('#u-date-project').data('daterangepicker').setStartDate(startDate);
                        $('#u-date-project').data('daterangepicker').setEndDate(endDate);

                    }

                    // Set target users
                    if (response.targetUserIds && response.targetUserIds.length > 0) {
                        $('#selectUTargetUsers').val(response.targetUserIds).trigger('change');
                    } else {
                        $('#selectUTargetUsers').val(null).trigger('change');
                    }

                    // Set target equipments
                    if (response.targetEquipmentIds && response.targetEquipmentIds.length > 0) {
                        $('#selectUTargetEquipments').val(response.targetEquipmentIds).trigger('change');
                    } else {
                        $('#selectUTargetEquipments').val(null).trigger('change');
                    }

                    $('#updateProjectModal').modal('show');
                }
            } catch (error) {
                console.error('Load project error:', error);
                handleError(error, 'Proje bilgisi yüklenirken hata oluştu.');
            }
        }

        async function updateProject() {
            var picker = $('#u-date-project').data('daterangepicker');
            const startDate = picker.startDate.format('YYYY-MM-DD');
            const endDate = picker.endDate.format('YYYY-MM-DD');
            const projectId = $('#txtUId').val();
            const projectColor = $('#projectUColorInput').val();

            const targetUserIds = $('#selectUTargetUsers').val();
            const targetEquipmentIds = $('#selectUTargetEquipments').val();

            const projectData = {
                name: $('#txtUName').val(),
                startDate: startDate,
                endDate: endDate,
                projectColor: projectColor,
                targetUserIds: targetUserIds && targetUserIds.length > 0 ? targetUserIds : null,
                targetEquipmentIds: targetEquipmentIds && targetEquipmentIds.length > 0 ? targetEquipmentIds : null
            };

            try {
                await makeRequest(`/proje/${projectId}`, 'PUT', projectData);
                showToast('Proje başarıyla güncellendi.', 'success', 'Başarılı!');
                $('#updateProjectModal').modal('hide');
                projectsTable.ajax.reload();
            } catch (error) {
                console.error('Update project error:', error);
                handleError(error, 'Proje güncellenirken hata oluştu.');
            }
        }

        async function deleteProject(projectId) {
            try {
                const result = await Swal.fire({
                    title: 'Emin misiniz?',
                    text: "Bu proje silinecek ve geri alınamayacak!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Evet, Sil!',
                    cancelButtonText: 'İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await makeRequest(`/proje/${projectId}`, 'DELETE');
                            return response;
                        } catch (error) {
                            let errorMessage = 'Silme başarısız';
                            if (error.detail) {
                                errorMessage = error.detail;
                            } else if (error.title) {
                                errorMessage = error.title;
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;
                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Proje başarıyla silindi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    projectsTable.ajax.reload(null, false);
                }
            } catch (error) {
                console.error('Silme hatası:', error);
            }
        }

        async function activateProject(projectId) {
            try {
                const result = await Swal.fire({
                    title: 'Projeyi Aktifleştir',
                    text: 'Bu projeyi aktifleştirmek istediğinizden emin misiniz?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-check"></i> Evet, Aktifleştir',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await makeRequest(`/proje/${projectId}/aktif-et`, 'PUT');
                            return response;
                        } catch (error) {
                            let errorMessage = 'Aktifleştirme başarısız';
                            if (error.detail) {
                                errorMessage = error.detail;
                            } else if (error.title) {
                                errorMessage = error.title;
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;
                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Proje başarıyla aktifleştirildi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });

                    projectsTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Aktifleştirme hatası:', error);
                throw error;
            }
        }

        async function deactivateProject(projectId) {
            try {
                const result = await Swal.fire({
                    title: 'Projeyi Pasifleştir',
                    text: 'Bu projeyi pasifleştirmek istediğinizden emin misiniz?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ffc107',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-user-slash"></i> Evet, Pasifleştir',
                    cancelButtonText: '<i class="fas fa-times"></i> İptal',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        try {
                            const response = await makeRequest(`/proje/${projectId}/pasif-et`, 'PUT');
                            return response;
                        } catch (error) {
                            let errorMessage = 'Pasifleştirme başarısız';
                            if (error.detail) {
                                errorMessage = error.detail;
                            } else if (error.title) {
                                errorMessage = error.title;
                            }
                            Swal.showValidationMessage(`Hata: ${errorMessage}`);
                            return false;
                        }
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (result.isConfirmed) {
                    await Swal.fire({
                        title: 'Başarılı!',
                        text: 'Proje başarıyla pasifleştirildi.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });

                    projectsTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Pasifleştirme hatası:', error);
                throw error;
            }
        }
    </script>
}